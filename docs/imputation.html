<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>5 Imputation: Romeo Malette Forest | Integration of Photo Interpreted and LiDAR Attributes into a Polygonal Forest Inventory Framework</title>
  <meta name="description" content="A place to find background information and follow updates related to the project." />
  <meta name="generator" content="bookdown 0.27 and GitBook 2.6.7" />

  <meta property="og:title" content="5 Imputation: Romeo Malette Forest | Integration of Photo Interpreted and LiDAR Attributes into a Polygonal Forest Inventory Framework" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="A place to find background information and follow updates related to the project." />
  <meta name="github-repo" content="bermane/ontario-inventory" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="5 Imputation: Romeo Malette Forest | Integration of Photo Interpreted and LiDAR Attributes into a Polygonal Forest Inventory Framework" />
  
  <meta name="twitter:description" content="A place to find background information and follow updates related to the project." />
  



<meta name="date" content="2023-05-02" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="segmentation.html"/>
<link rel="next" href="fsf.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Integration of Photo Interpreted and LiDAR Attributes Into a Polygonal Forest Inventory Framework</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><strong>1</strong> Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#summary"><i class="fa fa-check"></i><strong>1.1</strong> Project Summary</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#partners"><i class="fa fa-check"></i><strong>1.2</strong> Project Partners</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="people.html"><a href="people.html"><i class="fa fa-check"></i><strong>2</strong> People</a>
<ul>
<li class="chapter" data-level="" data-path="people.html"><a href="people.html#ubc"><i class="fa fa-check"></i><strong>2.1</strong> University of British Columbia</a>
<ul>
<li class="chapter" data-level="" data-path="people.html"><a href="people.html#ncc"><i class="fa fa-check"></i>Prof. Nicholas Coops, <em>project lead</em></a></li>
<li class="chapter" data-level="" data-path="people.html"><a href="people.html#eb"><i class="fa fa-check"></i>Ethan Berman, <em>research scientist</em></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="people.html"><a href="people.html#greenfirst"><i class="fa fa-check"></i><strong>2.2</strong> GreenFirst Forest Products</a>
<ul>
<li class="chapter" data-level="" data-path="people.html"><a href="people.html#cm"><i class="fa fa-check"></i>Chris McDonell, <em>partner</em></a></li>
<li class="chapter" data-level="" data-path="people.html"><a href="people.html#gm"><i class="fa fa-check"></i>Grant McCartney, <em>partner</em></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="people.html"><a href="people.html#ministry"><i class="fa fa-check"></i><strong>2.3</strong> Ontario Ministry of Natural Resources and Forestry</a>
<ul>
<li class="chapter" data-level="" data-path="people.html"><a href="people.html#is"><i class="fa fa-check"></i>Ian Sinclair, <em>partner</em></a></li>
<li class="chapter" data-level="" data-path="people.html"><a href="people.html#grm"><i class="fa fa-check"></i>Geordie Robere-McGugan, <em>partner</em></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="people.html"><a href="people.html#laval"><i class="fa fa-check"></i><strong>2.4</strong> Laval University</a>
<ul>
<li class="chapter" data-level="" data-path="people.html"><a href="people.html#aachim"><i class="fa fa-check"></i>Alexis Achim, <em>advisor</em></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="project-details.html"><a href="project-details.html"><i class="fa fa-check"></i><strong>3</strong> Project Details</a>
<ul>
<li class="chapter" data-level="" data-path="project-details.html"><a href="project-details.html#objective"><i class="fa fa-check"></i><strong>3.1</strong> Objective</a></li>
<li class="chapter" data-level="" data-path="project-details.html"><a href="project-details.html#themes"><i class="fa fa-check"></i><strong>3.2</strong> Themes</a></li>
<li class="chapter" data-level="" data-path="project-details.html"><a href="project-details.html#description"><i class="fa fa-check"></i><strong>3.3</strong> Description</a></li>
<li class="chapter" data-level="" data-path="project-details.html"><a href="project-details.html#study-area"><i class="fa fa-check"></i><strong>3.4</strong> Study Area</a></li>
<li class="chapter" data-level="" data-path="project-details.html"><a href="project-details.html#methodology"><i class="fa fa-check"></i><strong>3.5</strong> Methodology</a></li>
<li class="chapter" data-level="" data-path="project-details.html"><a href="project-details.html#knowledge-transfer"><i class="fa fa-check"></i><strong>3.6</strong> Knowledge &amp; Technology Transfer</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="segmentation.html"><a href="segmentation.html"><i class="fa fa-check"></i><strong>4</strong> Segmentation: Romeo Malette Forest</a>
<ul>
<li class="chapter" data-level="" data-path="segmentation.html"><a href="segmentation.html#segmentation41"><i class="fa fa-check"></i><strong>4.1</strong> Introduction</a></li>
<li class="chapter" data-level="" data-path="segmentation.html"><a href="segmentation.html#segmentation42"><i class="fa fa-check"></i><strong>4.2</strong> Generic Region Merging Parameters</a></li>
<li class="chapter" data-level="" data-path="segmentation.html"><a href="segmentation.html#segmentation43"><i class="fa fa-check"></i><strong>4.3</strong> Data Requirements</a></li>
<li class="chapter" data-level="" data-path="segmentation.html"><a href="segmentation.html#segmentation44"><i class="fa fa-check"></i><strong>4.4</strong> Set Code and File Parameters</a></li>
<li class="chapter" data-level="" data-path="segmentation.html"><a href="segmentation.html#segmentation45"><i class="fa fa-check"></i><strong>4.5</strong> Pre-processing</a></li>
<li class="chapter" data-level="" data-path="segmentation.html"><a href="segmentation.html#segmentation46"><i class="fa fa-check"></i><strong>4.6</strong> Execute GRM Segmentation</a></li>
<li class="chapter" data-level="" data-path="segmentation.html"><a href="segmentation.html#segmentation47"><i class="fa fa-check"></i><strong>4.7</strong> Post-processing</a></li>
<li class="chapter" data-level="" data-path="segmentation.html"><a href="segmentation.html#segmentation48"><i class="fa fa-check"></i><strong>4.8</strong> Performance Analysis</a></li>
<li class="chapter" data-level="" data-path="segmentation.html"><a href="segmentation.html#segmentation49"><i class="fa fa-check"></i><strong>4.9</strong> Results: GRM Algorithm</a></li>
<li class="chapter" data-level="" data-path="segmentation.html"><a href="segmentation.html#segmentation410"><i class="fa fa-check"></i><strong>4.10</strong> Results: Summary Statisics</a></li>
<li class="chapter" data-level="" data-path="segmentation.html"><a href="segmentation.html#segmentation411"><i class="fa fa-check"></i><strong>4.11</strong> Results: Visual examples of GRM and FRI Polygons</a></li>
<li class="chapter" data-level="" data-path="segmentation.html"><a href="segmentation.html#segmentation412"><i class="fa fa-check"></i><strong>4.12</strong> Results: Distribution Plots</a></li>
<li class="chapter" data-level="" data-path="segmentation.html"><a href="segmentation.html#segmentation413"><i class="fa fa-check"></i><strong>4.13</strong> Caveats</a></li>
<li class="chapter" data-level="" data-path="segmentation.html"><a href="segmentation.html#segmentation414"><i class="fa fa-check"></i><strong>4.14</strong> Future Work</a></li>
<li class="chapter" data-level="" data-path="segmentation.html"><a href="segmentation.html#segmentation415"><i class="fa fa-check"></i><strong>4.15</strong> Summary</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="imputation.html"><a href="imputation.html"><i class="fa fa-check"></i><strong>5</strong> Imputation: Romeo Malette Forest</a>
<ul>
<li class="chapter" data-level="" data-path="imputation.html"><a href="imputation.html#imputation51"><i class="fa fa-check"></i><strong>5.1</strong> Introduction</a></li>
<li class="chapter" data-level="" data-path="imputation.html"><a href="imputation.html#imputation52"><i class="fa fa-check"></i><strong>5.2</strong> Imputation Parameters</a></li>
<li class="chapter" data-level="" data-path="imputation.html"><a href="imputation.html#imputation53"><i class="fa fa-check"></i><strong>5.3</strong> Data Requirements</a></li>
<li class="chapter" data-level="" data-path="imputation.html"><a href="imputation.html#imputation54"><i class="fa fa-check"></i><strong>5.4</strong> Set Code and File Parameters</a></li>
<li class="chapter" data-level="" data-path="imputation.html"><a href="imputation.html#imputation55"><i class="fa fa-check"></i><strong>5.5</strong> Pre-processing: Extract Variables into Polygons</a></li>
<li class="chapter" data-level="" data-path="imputation.html"><a href="imputation.html#imputation56"><i class="fa fa-check"></i><strong>5.6</strong> Pre-processing: Calculate Species Attributes</a></li>
<li class="chapter" data-level="" data-path="imputation.html"><a href="imputation.html#imputation57"><i class="fa fa-check"></i><strong>5.7</strong> Pre-processing: Forest Data Screening</a></li>
<li class="chapter" data-level="" data-path="imputation.html"><a href="imputation.html#imputation58"><i class="fa fa-check"></i><strong>5.8</strong> Execute Imputation Algorithm Over FRI Polygons ONLY</a></li>
<li class="chapter" data-level="" data-path="imputation.html"><a href="imputation.html#imputation59"><i class="fa fa-check"></i><strong>5.9</strong> Results: Imputation over FRI</a></li>
<li class="chapter" data-level="" data-path="imputation.html"><a href="imputation.html#imputation510"><i class="fa fa-check"></i><strong>5.10</strong> Execute Imputation Algorithm From FRI to GRM Polygons</a></li>
<li class="chapter" data-level="" data-path="imputation.html"><a href="imputation.html#imputation511"><i class="fa fa-check"></i><strong>5.11</strong> Results: Imputation X-Variable Performance</a></li>
<li class="chapter" data-level="" data-path="imputation.html"><a href="imputation.html#imputation512"><i class="fa fa-check"></i><strong>5.12</strong> Results: Distribution of Age</a></li>
<li class="chapter" data-level="" data-path="imputation.html"><a href="imputation.html#imputation513"><i class="fa fa-check"></i><strong>5.13</strong> Results: Distribution of Species</a></li>
<li class="chapter" data-level="" data-path="imputation.html"><a href="imputation.html#imputation516"><i class="fa fa-check"></i><strong>5.16</strong> Caveats</a></li>
<li class="chapter" data-level="" data-path="imputation.html"><a href="imputation.html#imputation517"><i class="fa fa-check"></i><strong>5.17</strong> Future Work</a></li>
<li class="chapter" data-level="" data-path="imputation.html"><a href="imputation.html#imputation518"><i class="fa fa-check"></i><strong>5.18</strong> Summary</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="fsf.html"><a href="fsf.html"><i class="fa fa-check"></i><strong>6</strong> Case Study: French-Severn Forest</a>
<ul>
<li class="chapter" data-level="" data-path="fsf.html"><a href="fsf.html#fsf61"><i class="fa fa-check"></i><strong>6.1</strong> Segmentation</a>
<ul>
<li class="chapter" data-level="" data-path="fsf.html"><a href="fsf.html#fsf611"><i class="fa fa-check"></i><strong>6.1.1</strong> Run Algorithm</a></li>
<li class="chapter" data-level="" data-path="fsf.html"><a href="fsf.html#fsf612"><i class="fa fa-check"></i><strong>6.1.2</strong> Results: Summary Statistics</a></li>
<li class="chapter" data-level="" data-path="fsf.html"><a href="fsf.html#fsf613"><i class="fa fa-check"></i><strong>6.1.3</strong> Results: Distribution Plots</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="fsf.html"><a href="fsf.html#fsf62"><i class="fa fa-check"></i><strong>6.2</strong> Imputation Over FRI</a>
<ul>
<li class="chapter" data-level="" data-path="fsf.html"><a href="fsf.html#fsf621"><i class="fa fa-check"></i><strong>6.2.1</strong> Run Algorithm</a></li>
<li class="chapter" data-level="" data-path="fsf.html"><a href="fsf.html#fsf622"><i class="fa fa-check"></i><strong>6.2.2</strong> Results: Imputation Over FRI</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="fsf.html"><a href="fsf.html#fsf63"><i class="fa fa-check"></i><strong>6.3</strong> Imputation from FRI to GRM</a>
<ul>
<li class="chapter" data-level="" data-path="fsf.html"><a href="fsf.html#fsf631"><i class="fa fa-check"></i><strong>6.3.1</strong> Run Algorithm</a></li>
<li class="chapter" data-level="" data-path="fsf.html"><a href="fsf.html#fsf632"><i class="fa fa-check"></i><strong>6.3.2</strong> Results: Imputation X-Variable Performance</a></li>
<li class="chapter" data-level="" data-path="fsf.html"><a href="fsf.html#fsf633"><i class="fa fa-check"></i><strong>6.3.3</strong> Results: Distribution of Age</a></li>
<li class="chapter" data-level="" data-path="fsf.html"><a href="fsf.html#fsf634"><i class="fa fa-check"></i><strong>6.3.4</strong> Results: Distribution of Species</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="perf.html"><a href="perf.html"><i class="fa fa-check"></i><strong>7</strong> Imputation Performance Analysis: Comparing RMF and FSF</a>
<ul>
<li class="chapter" data-level="" data-path="perf.html"><a href="perf.html#perf71"><i class="fa fa-check"></i><strong>7.1</strong> Introduction</a></li>
<li class="chapter" data-level="" data-path="perf.html"><a href="perf.html#perf72"><i class="fa fa-check"></i><strong>7.2</strong> Results in RMF</a></li>
<li class="chapter" data-level="" data-path="perf.html"><a href="perf.html#perf73"><i class="fa fa-check"></i><strong>7.3</strong> Results in FSF</a></li>
<li class="chapter" data-level="" data-path="perf.html"><a href="perf.html#perf74"><i class="fa fa-check"></i><strong>7.4</strong> Comparing Results</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="contact.html"><a href="contact.html"><i class="fa fa-check"></i><strong>8</strong> Contact Info and Thank You</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i><strong>6</strong> References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Integration of Photo Interpreted and LiDAR Attributes into a Polygonal Forest Inventory Framework</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="imputation" class="section level1 unnumbered hasAnchor">
<h1><strong>5</strong> Imputation: Romeo Malette Forest<a href="imputation.html#imputation" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="imputation51" class="section level2 unnumbered hasAnchor">
<h2><strong>5.1</strong> Introduction<a href="imputation.html#imputation51" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>After automatically delineating forest stands from ALS data, the second step of this project is to integrate the vast database of conventionally derived forest composition attributes with EFI structural attributes from ALS. EFIs contain forest attributes such as Lorey’s height, quadratic mean diameter at breast height, basal area, merchantable volume and above-ground biomass. Yet ALS is limited in its ability to accurately estimate additional important forest composition attributes such as species and forest stand age. Thus, although we can easily average ALS/EFI attributes using zonal statistics, we need a workflow to carry forward important interpreter-derived attributes from the conventional FRI. We achieve this through imputation.</p>
<p>k-nearest neighbor (kNN) imputation is a widely used technique to derive spatially contiguous forest attributes for inventory and monitoring purposes (Chirici et al., 2016; McRoberts et al., 2010). kNN is applicable when desired forest attributes (Y-variables) exist in a subset of all observations (reference observations), and are imputed into observations that are missing Y-variable values (target observations). The algorithm works by minimizing a distance function between variables without missing values across the dataset (X-variables), finding k-reference observations closest to a single target observation, and imputing Y-variable values from k-reference observations into the target observation. In this case X-variables are derived from ALS and optical spaceborne remote sensing due to the contiguous nature of the data. This technique is distribution-free, multivariate, and non-parametric (Eskelson et al., 2009). It is based on the premise that observations with similar X-variable values should also have similar desired forest attribute values (Y-variable values). Thus, X-variable selection can be more important than imputation method (Brosofske et al., 2014) and therefore an iterative performance analysis is used to aid in optimal variable selection. Since all attributes are imputed together from k-nearest neighbors, kNN imputation maintains the relationship between interpreter derived attributes (Coops et al., 2021).</p>
<p>In this example we will walk through the imputation of FRI age and species attributes into the forest stand polygons we generated using the GRM algorithm. As explained in Part 7 below (as well as in a forthcoming journal article), we undertook an iterative performance analysis to select the optimal X-variables to use to drive the imputation algorithm. We will not test different combinations of X-variables in this example, rather just use the optimal selection found for the RMF study area, focusing on the process of imputing age and species attributes into new polygons and assessing the distribution of attributes in relation to the conventional FRI.</p>
</div>
<div id="imputation52" class="section level2 unnumbered hasAnchor">
<h2><strong>5.2</strong> Imputation Parameters<a href="imputation.html#imputation52" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The kNN algorithm functions by minimizing the Euclidean distance, without weights, between n X-variables in a target observation (in this case a forested polygon) and k-reference observations. We tested combinations of n = 3/5/7 and use n = 7 in this example.</p>
<p>When k = 1, values from the nearest reference observation (X and Y-variables) are directly joined to the target observation. When k &gt; 1, values from the nearest reference observations are averaged using either the mean (for numeric variables) or mode (for categorical values). All Y-variables are imputed together, maintaining the relationship between variables in the reference observations. We tested combinations of k = 1/3/5 and use k = 5 in this example as it produced optimal results. In general, larger values of k lead to higher performance but more averaging of estimated attributes, which decreases variability.</p>
</div>
<div id="imputation53" class="section level2 unnumbered hasAnchor">
<h2><strong>5.3</strong> Data Requirements<a href="imputation.html#imputation53" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The GRM segmentation workflow requires the following data layers, which are input into the algorithm at the beginning of the code:</p>
<ol style="list-style-type: decimal">
<li>Gridded raster layers of the following ALS metrics and Sentinel-2 imagery, which are used as imputation X-variables as well as for polygon data screening:</li>
</ol>
<p>Imputation X-variables:</p>
<ul>
<li>avg: Mean returns height &gt; 1.3 m classified as vegetation</li>
<li>rumple: Ratio of canopy outer surface area to ground surface area</li>
<li>pcum8: Cumulative percentage of returns found in 80th percentile of returns height</li>
<li>sd: Standard deviation of returns height &gt; 1.3 m classified as vegetation</li>
<li>b6: Cloud-free composite of Sentinel-2 red-edge 2 (band 6; 740 nm) surface reflectance</li>
</ul>
<p>These five attributes comprise the optimal imputation X-variables from our performance analysis. The additional two variables used are the x and y coordinates of each polygon centroid, and are calculated automatically in the code. In the RMF, we found that these attributes derived directly from the ALS point cloud performed slightly better than modeled attributes from the EFI. Many of the ALS/EFI attributes are highly correlated and thus yield similar imputation results.</p>
<p>Variables for polygon data screening:</p>
<ul>
<li>p95: 95th percentile of returns height &gt; 1.3 meters classified as vegetation</li>
<li>cc: Canopy cover. Percentage of first returns &gt; 2 meters classified as vegetation</li>
</ul>
<p>We use these layers to screen FRI and GRM polygons to curate a set of polygons likely to be forested, since we do not want to impute attributes from/to polygons that are likely non-forested. We do not go into detail about how to pre-process ALS layers from the point cloud. These metrics were processed using the <a href="https://r-lidar.github.io/lidRbook/">lidR</a> package in R.</p>
<ol start="2" style="list-style-type: decimal">
<li>Forest Resources Inventory polygons (shapefile)</li>
</ol>
<p>The polygons need to have a “SPCOMP”, “YRORG”, and “POLYID” field, which are used in the code below.</p>
<ol start="3" style="list-style-type: decimal">
<li>Generic Region Merging segmented polygons (shapefile)</li>
</ol>
<p>The polygons generated in the segmentation step of this project.</p>
<ol start="4" style="list-style-type: decimal">
<li>VLCE 2.0 Canada-wide Landcover data. <a href="https://opendata.nfis.org/mapserver/nfis-change_eng.html">Download here.</a></li>
</ol>
<p>We use 2018 to match the year of aquisition of the ALS data.</p>
<p>All analyses are run in <a href="https://posit.co/download/rstudio-desktop/">R using RStudio</a> – so having a valid installation is necessary too.</p>
</div>
<div id="imputation54" class="section level2 unnumbered hasAnchor">
<h2><strong>5.4</strong> Set Code and File Parameters<a href="imputation.html#imputation54" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Now working in R, we will showcase a demo workflow, imputing age and species composition attributes from the FRI into GRM polygons in the Romeo Malette Forest (RMF). Although imputation can be carried out over the entire suite of FRI attributes, we focus on age and species for the purpose of this analysis. The first step is to install packages (if not already installed) and set the code and file parameters. The input file locations are referenced.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="imputation.html#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="do">##################################</span></span>
<span id="cb14-2"><a href="imputation.html#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="do">### INSTALL PACKAGES IF NEEDED </span><span class="al">###</span></span>
<span id="cb14-3"><a href="imputation.html#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="do">##################################</span></span>
<span id="cb14-4"><a href="imputation.html#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="imputation.html#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages(c(&#39;terra&#39;,</span></span>
<span id="cb14-6"><a href="imputation.html#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">#                    &#39;tidyverse&#39;,</span></span>
<span id="cb14-7"><a href="imputation.html#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">#                    &#39;exactextractr&#39;,</span></span>
<span id="cb14-8"><a href="imputation.html#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co">#                    &#39;sf&#39;,</span></span>
<span id="cb14-9"><a href="imputation.html#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co">#                    &#39;magrittr&#39;,</span></span>
<span id="cb14-10"><a href="imputation.html#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co">#                    &#39;gridExtra&#39;,</span></span>
<span id="cb14-11"><a href="imputation.html#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co">#                    &#39;RANN&#39;,</span></span>
<span id="cb14-12"><a href="imputation.html#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="co">#                    &#39;reshape2&#39;,</span></span>
<span id="cb14-13"><a href="imputation.html#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co">#                    &#39;viridis&#39;,</span></span>
<span id="cb14-14"><a href="imputation.html#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co">#                    &#39;scales&#39;,</span></span>
<span id="cb14-15"><a href="imputation.html#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="co">#                    &#39;janitor&#39;,</span></span>
<span id="cb14-16"><a href="imputation.html#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="co">#                    &#39;kableExtra&#39;,</span></span>
<span id="cb14-17"><a href="imputation.html#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="co">#                    &#39;knitr&#39;))</span></span>
<span id="cb14-18"><a href="imputation.html#cb14-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-19"><a href="imputation.html#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="co"># make sure to have OTB installed from here:</span></span>
<span id="cb14-20"><a href="imputation.html#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="co"># https://www.orfeo-toolbox.org/</span></span>
<span id="cb14-21"><a href="imputation.html#cb14-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-22"><a href="imputation.html#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="do">#####################</span></span>
<span id="cb14-23"><a href="imputation.html#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="do">### LOAD PACKAGES </span><span class="al">###</span></span>
<span id="cb14-24"><a href="imputation.html#cb14-24" aria-hidden="true" tabindex="-1"></a><span class="do">#####################</span></span>
<span id="cb14-25"><a href="imputation.html#cb14-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-26"><a href="imputation.html#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="co"># load packages</span></span>
<span id="cb14-27"><a href="imputation.html#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb14-28"><a href="imputation.html#cb14-28" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb14-29"><a href="imputation.html#cb14-29" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(exactextractr)</span>
<span id="cb14-30"><a href="imputation.html#cb14-30" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb14-31"><a href="imputation.html#cb14-31" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb14-32"><a href="imputation.html#cb14-32" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb14-33"><a href="imputation.html#cb14-33" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RANN)</span>
<span id="cb14-34"><a href="imputation.html#cb14-34" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reshape2)</span>
<span id="cb14-35"><a href="imputation.html#cb14-35" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis)</span>
<span id="cb14-36"><a href="imputation.html#cb14-36" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb14-37"><a href="imputation.html#cb14-37" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(janitor)</span>
<span id="cb14-38"><a href="imputation.html#cb14-38" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb14-39"><a href="imputation.html#cb14-39" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb14-40"><a href="imputation.html#cb14-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-41"><a href="imputation.html#cb14-41" aria-hidden="true" tabindex="-1"></a><span class="do">####################################</span></span>
<span id="cb14-42"><a href="imputation.html#cb14-42" aria-hidden="true" tabindex="-1"></a><span class="do">### SET CODE AND FILE PARAMETERS </span><span class="al">###</span></span>
<span id="cb14-43"><a href="imputation.html#cb14-43" aria-hidden="true" tabindex="-1"></a><span class="do">####################################</span></span>
<span id="cb14-44"><a href="imputation.html#cb14-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-45"><a href="imputation.html#cb14-45" aria-hidden="true" tabindex="-1"></a><span class="co"># set file names for ALS input variables</span></span>
<span id="cb14-46"><a href="imputation.html#cb14-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-47"><a href="imputation.html#cb14-47" aria-hidden="true" tabindex="-1"></a><span class="co"># first set the imputation X-variables</span></span>
<span id="cb14-48"><a href="imputation.html#cb14-48" aria-hidden="true" tabindex="-1"></a>lidar_imp <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;avg&#39;</span> <span class="ot">=</span> <span class="st">&#39;D:/ontario_inventory/romeo/RMF_EFI_layers/SPL100 metrics/RMF_20m_T130cm_avg.tif&#39;</span>,</span>
<span id="cb14-49"><a href="imputation.html#cb14-49" aria-hidden="true" tabindex="-1"></a>               <span class="st">&#39;rumple&#39;</span> <span class="ot">=</span> <span class="st">&#39;D:/ontario_inventory/romeo/SPL metrics/Z_METRICS_MOSAIC/individual/RMF_RUMPLE_MOSAIC_r_rumple.tif&#39;</span>,</span>
<span id="cb14-50"><a href="imputation.html#cb14-50" aria-hidden="true" tabindex="-1"></a>               <span class="st">&#39;pcum8&#39;</span> <span class="ot">=</span> <span class="st">&#39;D:/ontario_inventory/romeo/SPL metrics/Z_METRICS_MOSAIC/individual/RMF_Z_METRICS_MOSAIC_zpcum8.tif&#39;</span>,</span>
<span id="cb14-51"><a href="imputation.html#cb14-51" aria-hidden="true" tabindex="-1"></a>               <span class="st">&#39;sd&#39;</span> <span class="ot">=</span> <span class="st">&#39;D:/ontario_inventory/romeo/SPL metrics/Z_METRICS_MOSAIC/individual/RMF_Z_METRICS_MOSAIC_zsd.tif&#39;</span>,</span>
<span id="cb14-52"><a href="imputation.html#cb14-52" aria-hidden="true" tabindex="-1"></a>               <span class="st">&#39;b6&#39;</span> <span class="ot">=</span> <span class="st">&#39;D:/ontario_inventory/romeo/Sentinel/red_edge_2.tif&#39;</span>)</span>
<span id="cb14-53"><a href="imputation.html#cb14-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-54"><a href="imputation.html#cb14-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-55"><a href="imputation.html#cb14-55" aria-hidden="true" tabindex="-1"></a><span class="co"># next set the data screening variables</span></span>
<span id="cb14-56"><a href="imputation.html#cb14-56" aria-hidden="true" tabindex="-1"></a>lidar_scr <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;p95&#39;</span> <span class="ot">=</span> <span class="st">&#39;D:/ontario_inventory/romeo/RMF_EFI_layers/SPL100 metrics/RMF_20m_T130cm_p95.tif&#39;</span>,</span>
<span id="cb14-57"><a href="imputation.html#cb14-57" aria-hidden="true" tabindex="-1"></a>               <span class="st">&#39;cc&#39;</span> <span class="ot">=</span> <span class="st">&#39;D:/ontario_inventory/romeo/RMF_EFI_layers/SPL100 metrics/RMF_20m_T130cm_2m_cov.tif&#39;</span>)</span>
<span id="cb14-58"><a href="imputation.html#cb14-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-59"><a href="imputation.html#cb14-59" aria-hidden="true" tabindex="-1"></a><span class="co"># set file location of FRI polygons shape file</span></span>
<span id="cb14-60"><a href="imputation.html#cb14-60" aria-hidden="true" tabindex="-1"></a>fri <span class="ot">&lt;-</span> <span class="st">&#39;D:/ontario_inventory/romeo/RMF_EFI_layers/Polygons Inventory/RMF_PolygonForest.shp&#39;</span></span>
<span id="cb14-61"><a href="imputation.html#cb14-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-62"><a href="imputation.html#cb14-62" aria-hidden="true" tabindex="-1"></a><span class="co"># set file location of GRM polygons shape file</span></span>
<span id="cb14-63"><a href="imputation.html#cb14-63" aria-hidden="true" tabindex="-1"></a>grm <span class="ot">&lt;-</span> <span class="st">&#39;C:/Users/bermane/Desktop/RMF/grm_10_01_05.shp&#39;</span></span>
<span id="cb14-64"><a href="imputation.html#cb14-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-65"><a href="imputation.html#cb14-65" aria-hidden="true" tabindex="-1"></a><span class="co"># set output folder for files generated</span></span>
<span id="cb14-66"><a href="imputation.html#cb14-66" aria-hidden="true" tabindex="-1"></a><span class="co"># make sure no &quot;/&quot; at end of folder location!</span></span>
<span id="cb14-67"><a href="imputation.html#cb14-67" aria-hidden="true" tabindex="-1"></a>out_dir <span class="ot">&lt;-</span> <span class="st">&#39;C:/Users/bermane/Desktop/RMF&#39;</span></span>
<span id="cb14-68"><a href="imputation.html#cb14-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-69"><a href="imputation.html#cb14-69" aria-hidden="true" tabindex="-1"></a><span class="co"># set file location of 2018 VLCE 2.0 landcover data</span></span>
<span id="cb14-70"><a href="imputation.html#cb14-70" aria-hidden="true" tabindex="-1"></a><span class="co"># using 2018 because it is the year of Romeo ALS acquisition</span></span>
<span id="cb14-71"><a href="imputation.html#cb14-71" aria-hidden="true" tabindex="-1"></a><span class="co"># can change based on ALS acquisition year</span></span>
<span id="cb14-72"><a href="imputation.html#cb14-72" aria-hidden="true" tabindex="-1"></a><span class="co"># download here:</span></span>
<span id="cb14-73"><a href="imputation.html#cb14-73" aria-hidden="true" tabindex="-1"></a><span class="co"># https://opendata.nfis.org/mapserver/nfis-change_eng.html</span></span>
<span id="cb14-74"><a href="imputation.html#cb14-74" aria-hidden="true" tabindex="-1"></a>lc_f <span class="ot">&lt;-</span> <span class="st">&#39;D:/ontario_inventory/VLCE/CA_forest_VLCE2_2018.tif&#39;</span></span></code></pre></div>
</div>
<div id="imputation55" class="section level2 unnumbered hasAnchor">
<h2><strong>5.5</strong> Pre-processing: Extract Variables into Polygons<a href="imputation.html#imputation55" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The first step before running imputation is to extract all of the variables needed into each of the polygons. We take the median value of all pixels covered by each polygon, weighted by percent coverage. We also calculate the polygon centroid x and y coordinates (in UTM) and the age of the forest stand in 2018 (year of ALS acquisition) for FRI polygons only.</p>
<p>We start with the FRI polygons.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="imputation.html#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="do">###########################################</span></span>
<span id="cb15-2"><a href="imputation.html#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="do">### EXTRACT VARIABLES INTO FRI POLYGONS </span><span class="al">###</span></span>
<span id="cb15-3"><a href="imputation.html#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="do">###########################################</span></span>
<span id="cb15-4"><a href="imputation.html#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="imputation.html#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co"># load FRI polygons</span></span>
<span id="cb15-6"><a href="imputation.html#cb15-6" aria-hidden="true" tabindex="-1"></a>poly <span class="ot">&lt;-</span> <span class="fu">vect</span>(fri)</span>
<span id="cb15-7"><a href="imputation.html#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="imputation.html#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co"># convert to df</span></span>
<span id="cb15-9"><a href="imputation.html#cb15-9" aria-hidden="true" tabindex="-1"></a>dat_fri <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(poly)</span>
<span id="cb15-10"><a href="imputation.html#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="imputation.html#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="co"># cbind centroids to dat</span></span>
<span id="cb15-12"><a href="imputation.html#cb15-12" aria-hidden="true" tabindex="-1"></a>dat_fri <span class="ot">&lt;-</span> <span class="fu">cbind</span>(dat_fri, <span class="fu">centroids</span>(poly) <span class="sc">%&gt;%</span> crds)</span>
<span id="cb15-13"><a href="imputation.html#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="imputation.html#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="co"># combine all LiDAR and aux variables to extract</span></span>
<span id="cb15-15"><a href="imputation.html#cb15-15" aria-hidden="true" tabindex="-1"></a>lidar_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(lidar_imp, lidar_scr)</span>
<span id="cb15-16"><a href="imputation.html#cb15-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-17"><a href="imputation.html#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="co"># loop through LiDAR attributes to extract values</span></span>
<span id="cb15-18"><a href="imputation.html#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(lidar_vars)) {</span>
<span id="cb15-19"><a href="imputation.html#cb15-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load LiDAR raster</span></span>
<span id="cb15-20"><a href="imputation.html#cb15-20" aria-hidden="true" tabindex="-1"></a>  lidar_ras <span class="ot">&lt;-</span> <span class="fu">rast</span>(lidar_vars[i])</span>
<span id="cb15-21"><a href="imputation.html#cb15-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-22"><a href="imputation.html#cb15-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># project poly to crs of raster</span></span>
<span id="cb15-23"><a href="imputation.html#cb15-23" aria-hidden="true" tabindex="-1"></a>  poly_ras <span class="ot">&lt;-</span> <span class="fu">project</span>(poly, lidar_ras)</span>
<span id="cb15-24"><a href="imputation.html#cb15-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-25"><a href="imputation.html#cb15-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># convert to sf</span></span>
<span id="cb15-26"><a href="imputation.html#cb15-26" aria-hidden="true" tabindex="-1"></a>  poly_ras <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(poly_ras)</span>
<span id="cb15-27"><a href="imputation.html#cb15-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-28"><a href="imputation.html#cb15-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">#extract median values</span></span>
<span id="cb15-29"><a href="imputation.html#cb15-29" aria-hidden="true" tabindex="-1"></a>  vec <span class="ot">&lt;-</span></span>
<span id="cb15-30"><a href="imputation.html#cb15-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">exact_extract</span>(lidar_ras, poly_ras, <span class="st">&#39;median&#39;</span>)</span>
<span id="cb15-31"><a href="imputation.html#cb15-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-32"><a href="imputation.html#cb15-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># aggregate into data frame</span></span>
<span id="cb15-33"><a href="imputation.html#cb15-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb15-34"><a href="imputation.html#cb15-34" aria-hidden="true" tabindex="-1"></a>    vec_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(vec)</span>
<span id="cb15-35"><a href="imputation.html#cb15-35" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span>{</span>
<span id="cb15-36"><a href="imputation.html#cb15-36" aria-hidden="true" tabindex="-1"></a>    vec_df <span class="ot">&lt;-</span> <span class="fu">cbind</span>(vec_df, <span class="fu">as.data.frame</span>(vec))</span>
<span id="cb15-37"><a href="imputation.html#cb15-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-38"><a href="imputation.html#cb15-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-39"><a href="imputation.html#cb15-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-40"><a href="imputation.html#cb15-40" aria-hidden="true" tabindex="-1"></a><span class="co"># change column names of extracted attribute data frame</span></span>
<span id="cb15-41"><a href="imputation.html#cb15-41" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(vec_df) <span class="ot">&lt;-</span> <span class="fu">names</span>(lidar_vars)</span>
<span id="cb15-42"><a href="imputation.html#cb15-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-43"><a href="imputation.html#cb15-43" aria-hidden="true" tabindex="-1"></a><span class="co"># add LiDAR attributes to FRI polygon data frame</span></span>
<span id="cb15-44"><a href="imputation.html#cb15-44" aria-hidden="true" tabindex="-1"></a>dat_fri <span class="ot">&lt;-</span> <span class="fu">cbind</span>(dat_fri, vec_df)</span>
<span id="cb15-45"><a href="imputation.html#cb15-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-46"><a href="imputation.html#cb15-46" aria-hidden="true" tabindex="-1"></a><span class="co"># add 2018 age values</span></span>
<span id="cb15-47"><a href="imputation.html#cb15-47" aria-hidden="true" tabindex="-1"></a>dat_fri<span class="sc">$</span>AGE2018 <span class="ot">&lt;-</span> <span class="dv">2018</span> <span class="sc">-</span> dat_fri<span class="sc">$</span>YRORG</span>
<span id="cb15-48"><a href="imputation.html#cb15-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-49"><a href="imputation.html#cb15-49" aria-hidden="true" tabindex="-1"></a><span class="co"># check if main dir exists and create</span></span>
<span id="cb15-50"><a href="imputation.html#cb15-50" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">dir.exists</span>(out_dir) <span class="sc">==</span> F) {</span>
<span id="cb15-51"><a href="imputation.html#cb15-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(out_dir)</span>
<span id="cb15-52"><a href="imputation.html#cb15-52" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-53"><a href="imputation.html#cb15-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-54"><a href="imputation.html#cb15-54" aria-hidden="true" tabindex="-1"></a><span class="co"># check if temp dir exists and create</span></span>
<span id="cb15-55"><a href="imputation.html#cb15-55" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">dir.exists</span>(<span class="fu">file.path</span>(out_dir, <span class="st">&#39;temp&#39;</span>)) <span class="sc">==</span> F) {</span>
<span id="cb15-56"><a href="imputation.html#cb15-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(<span class="fu">file.path</span>(out_dir, <span class="st">&#39;temp&#39;</span>))</span>
<span id="cb15-57"><a href="imputation.html#cb15-57" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-58"><a href="imputation.html#cb15-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-59"><a href="imputation.html#cb15-59" aria-hidden="true" tabindex="-1"></a><span class="co"># save extracted dataframe for fast rebooting</span></span>
<span id="cb15-60"><a href="imputation.html#cb15-60" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(dat_fri, <span class="at">file =</span> <span class="fu">str_c</span>(out_dir, <span class="st">&#39;/temp/dat_fri_extr.RData&#39;</span>))</span></code></pre></div>
<p>Next we extract the same variables into GRM polygons.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="imputation.html#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="do">###########################################</span></span>
<span id="cb16-2"><a href="imputation.html#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="do">### EXTRACT VARIABLES INTO GRM POLYGONS </span><span class="al">###</span></span>
<span id="cb16-3"><a href="imputation.html#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="do">###########################################</span></span>
<span id="cb16-4"><a href="imputation.html#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="imputation.html#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co"># load GRM segmented polygons</span></span>
<span id="cb16-6"><a href="imputation.html#cb16-6" aria-hidden="true" tabindex="-1"></a>poly <span class="ot">&lt;-</span> <span class="fu">vect</span>(grm)</span>
<span id="cb16-7"><a href="imputation.html#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="imputation.html#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co"># reproject to match FRI polygons</span></span>
<span id="cb16-9"><a href="imputation.html#cb16-9" aria-hidden="true" tabindex="-1"></a>poly <span class="ot">&lt;-</span> <span class="fu">project</span>(poly, <span class="fu">vect</span>(fri))</span>
<span id="cb16-10"><a href="imputation.html#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="imputation.html#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="co"># convert to df</span></span>
<span id="cb16-12"><a href="imputation.html#cb16-12" aria-hidden="true" tabindex="-1"></a>dat_grm <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(poly)</span>
<span id="cb16-13"><a href="imputation.html#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="imputation.html#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="co"># cbind centroids to dat</span></span>
<span id="cb16-15"><a href="imputation.html#cb16-15" aria-hidden="true" tabindex="-1"></a>dat_grm <span class="ot">&lt;-</span> <span class="fu">cbind</span>(dat_grm, <span class="fu">centroids</span>(poly) <span class="sc">%&gt;%</span> crds)</span>
<span id="cb16-16"><a href="imputation.html#cb16-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-17"><a href="imputation.html#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="co"># loop through LiDAR attributes to extract values</span></span>
<span id="cb16-18"><a href="imputation.html#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(lidar_vars)) {</span>
<span id="cb16-19"><a href="imputation.html#cb16-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load LiDAR raster</span></span>
<span id="cb16-20"><a href="imputation.html#cb16-20" aria-hidden="true" tabindex="-1"></a>  lidar_ras <span class="ot">&lt;-</span> <span class="fu">rast</span>(lidar_vars[i])</span>
<span id="cb16-21"><a href="imputation.html#cb16-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-22"><a href="imputation.html#cb16-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># project poly to crs of raster</span></span>
<span id="cb16-23"><a href="imputation.html#cb16-23" aria-hidden="true" tabindex="-1"></a>  poly_ras <span class="ot">&lt;-</span> <span class="fu">project</span>(poly, lidar_ras)</span>
<span id="cb16-24"><a href="imputation.html#cb16-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-25"><a href="imputation.html#cb16-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># convert to sf</span></span>
<span id="cb16-26"><a href="imputation.html#cb16-26" aria-hidden="true" tabindex="-1"></a>  poly_ras <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(poly_ras)</span>
<span id="cb16-27"><a href="imputation.html#cb16-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-28"><a href="imputation.html#cb16-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">#extract median values</span></span>
<span id="cb16-29"><a href="imputation.html#cb16-29" aria-hidden="true" tabindex="-1"></a>  vec <span class="ot">&lt;-</span></span>
<span id="cb16-30"><a href="imputation.html#cb16-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">exact_extract</span>(lidar_ras, poly_ras, <span class="st">&#39;median&#39;</span>)</span>
<span id="cb16-31"><a href="imputation.html#cb16-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-32"><a href="imputation.html#cb16-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># aggregate into data frame</span></span>
<span id="cb16-33"><a href="imputation.html#cb16-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb16-34"><a href="imputation.html#cb16-34" aria-hidden="true" tabindex="-1"></a>    vec_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(vec)</span>
<span id="cb16-35"><a href="imputation.html#cb16-35" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span>{</span>
<span id="cb16-36"><a href="imputation.html#cb16-36" aria-hidden="true" tabindex="-1"></a>    vec_df <span class="ot">&lt;-</span> <span class="fu">cbind</span>(vec_df, <span class="fu">as.data.frame</span>(vec))</span>
<span id="cb16-37"><a href="imputation.html#cb16-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-38"><a href="imputation.html#cb16-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-39"><a href="imputation.html#cb16-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-40"><a href="imputation.html#cb16-40" aria-hidden="true" tabindex="-1"></a><span class="co"># change column names of extracted attribute data frame</span></span>
<span id="cb16-41"><a href="imputation.html#cb16-41" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(vec_df) <span class="ot">&lt;-</span> <span class="fu">names</span>(lidar_vars)</span>
<span id="cb16-42"><a href="imputation.html#cb16-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-43"><a href="imputation.html#cb16-43" aria-hidden="true" tabindex="-1"></a><span class="co"># add LiDAR attributes to FRI polygon data frame</span></span>
<span id="cb16-44"><a href="imputation.html#cb16-44" aria-hidden="true" tabindex="-1"></a>dat_grm <span class="ot">&lt;-</span> <span class="fu">cbind</span>(dat_grm, vec_df)</span>
<span id="cb16-45"><a href="imputation.html#cb16-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-46"><a href="imputation.html#cb16-46" aria-hidden="true" tabindex="-1"></a><span class="co"># save extracted dataframe for fast rebooting</span></span>
<span id="cb16-47"><a href="imputation.html#cb16-47" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(dat_grm, <span class="at">file =</span> <span class="fu">str_c</span>(out_dir, <span class="st">&#39;/temp/dat_grm_extr.RData&#39;</span>))</span></code></pre></div>
</div>
<div id="imputation56" class="section level2 unnumbered hasAnchor">
<h2><strong>5.6</strong> Pre-processing: Calculate Species Attributes<a href="imputation.html#imputation56" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The next step in pre-processing is to prepare the species attributes from the FRI. In the FRI, species type and percent composition are listed in a long string attribute “SPCOMP”. We break up this string into the following species attributes:</p>
<ul>
<li>First leading species</li>
<li>Second leading species</li>
<li>Three functional group classification (softwood, mixedwood, hardwood)</li>
<li>Five functional group classification (jack pine dominated, black spruce dominated, mixed conifer, mixedwood, hardwood)</li>
</ul>
<p>See Queinnec et al. (2022) and Woods et al. (2011) for the derivation of three and five functional group classification. Note these group classifications were developed for the RMF and may be less relevant in other areas (specifically the five functional group classification).</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="imputation.html#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="do">############################################</span></span>
<span id="cb17-2"><a href="imputation.html#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="do">### FUNCTIONS FOR SPECIES CLASSIFICATION </span><span class="al">###</span></span>
<span id="cb17-3"><a href="imputation.html#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="do">############################################</span></span>
<span id="cb17-4"><a href="imputation.html#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="imputation.html#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co"># assign species name -- note this list was updated with all species in FSF FRI.</span></span>
<span id="cb17-6"><a href="imputation.html#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co"># It may need to be adjusted for other areas</span></span>
<span id="cb17-7"><a href="imputation.html#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="imputation.html#cb17-8" aria-hidden="true" tabindex="-1"></a>assign_common_name <span class="ot">&lt;-</span> <span class="cf">function</span>(sp_abbrev) {</span>
<span id="cb17-9"><a href="imputation.html#cb17-9" aria-hidden="true" tabindex="-1"></a>  sp_abbrev  <span class="ot">&lt;-</span> <span class="fu">toupper</span>(sp_abbrev)</span>
<span id="cb17-10"><a href="imputation.html#cb17-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-11"><a href="imputation.html#cb17-11" aria-hidden="true" tabindex="-1"></a>  dict <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">SB =</span> <span class="st">&quot;black spruce&quot;</span>, </span>
<span id="cb17-12"><a href="imputation.html#cb17-12" aria-hidden="true" tabindex="-1"></a>                     <span class="at">LA =</span> <span class="st">&quot;eastern larch&quot;</span>, </span>
<span id="cb17-13"><a href="imputation.html#cb17-13" aria-hidden="true" tabindex="-1"></a>                     <span class="at">BW =</span> <span class="st">&quot;white birch&quot;</span>, </span>
<span id="cb17-14"><a href="imputation.html#cb17-14" aria-hidden="true" tabindex="-1"></a>                     <span class="at">BF =</span> <span class="st">&quot;balsam fir&quot;</span>, </span>
<span id="cb17-15"><a href="imputation.html#cb17-15" aria-hidden="true" tabindex="-1"></a>                     <span class="at">CE =</span> <span class="st">&quot;cedar&quot;</span>, </span>
<span id="cb17-16"><a href="imputation.html#cb17-16" aria-hidden="true" tabindex="-1"></a>                     <span class="at">SW =</span> <span class="st">&quot;white spruce&quot;</span>, </span>
<span id="cb17-17"><a href="imputation.html#cb17-17" aria-hidden="true" tabindex="-1"></a>                     <span class="at">PT =</span> <span class="st">&quot;trembling aspen&quot;</span>, </span>
<span id="cb17-18"><a href="imputation.html#cb17-18" aria-hidden="true" tabindex="-1"></a>                     <span class="at">PJ =</span> <span class="st">&quot;jack pine&quot;</span>, </span>
<span id="cb17-19"><a href="imputation.html#cb17-19" aria-hidden="true" tabindex="-1"></a>                     <span class="at">PO =</span> <span class="st">&quot;poplar&quot;</span>, </span>
<span id="cb17-20"><a href="imputation.html#cb17-20" aria-hidden="true" tabindex="-1"></a>                     <span class="at">PB =</span> <span class="st">&quot;balsam poplar&quot;</span>, </span>
<span id="cb17-21"><a href="imputation.html#cb17-21" aria-hidden="true" tabindex="-1"></a>                     <span class="at">PR =</span> <span class="st">&quot;red pine&quot;</span>, </span>
<span id="cb17-22"><a href="imputation.html#cb17-22" aria-hidden="true" tabindex="-1"></a>                     <span class="at">PW =</span> <span class="st">&quot;white pine&quot;</span>, </span>
<span id="cb17-23"><a href="imputation.html#cb17-23" aria-hidden="true" tabindex="-1"></a>                     <span class="at">SX =</span> <span class="st">&quot;spruce&quot;</span>, </span>
<span id="cb17-24"><a href="imputation.html#cb17-24" aria-hidden="true" tabindex="-1"></a>                     <span class="at">MR =</span> <span class="st">&quot;red maple&quot;</span>, </span>
<span id="cb17-25"><a href="imputation.html#cb17-25" aria-hidden="true" tabindex="-1"></a>                     <span class="at">AB =</span> <span class="st">&quot;black ash&quot;</span>, </span>
<span id="cb17-26"><a href="imputation.html#cb17-26" aria-hidden="true" tabindex="-1"></a>                     <span class="at">BY =</span> <span class="st">&quot;yellow birch&quot;</span>,</span>
<span id="cb17-27"><a href="imputation.html#cb17-27" aria-hidden="true" tabindex="-1"></a>                     <span class="at">OR =</span> <span class="st">&#39;red oak&#39;</span>,</span>
<span id="cb17-28"><a href="imputation.html#cb17-28" aria-hidden="true" tabindex="-1"></a>                     <span class="at">CW =</span> <span class="st">&#39;eastern white cedar&#39;</span>,</span>
<span id="cb17-29"><a href="imputation.html#cb17-29" aria-hidden="true" tabindex="-1"></a>                     <span class="at">MH =</span> <span class="st">&#39;hard maple&#39;</span>,</span>
<span id="cb17-30"><a href="imputation.html#cb17-30" aria-hidden="true" tabindex="-1"></a>                     <span class="at">HE =</span> <span class="st">&#39;eastern hemlock&#39;</span>,</span>
<span id="cb17-31"><a href="imputation.html#cb17-31" aria-hidden="true" tabindex="-1"></a>                     <span class="at">BD =</span> <span class="st">&#39;basswood&#39;</span>,</span>
<span id="cb17-32"><a href="imputation.html#cb17-32" aria-hidden="true" tabindex="-1"></a>                     <span class="at">CB =</span> <span class="st">&#39;black cherry&#39;</span>,</span>
<span id="cb17-33"><a href="imputation.html#cb17-33" aria-hidden="true" tabindex="-1"></a>                     <span class="at">BE =</span> <span class="st">&#39;american beech&#39;</span>,</span>
<span id="cb17-34"><a href="imputation.html#cb17-34" aria-hidden="true" tabindex="-1"></a>                     <span class="at">AW =</span> <span class="st">&#39;white ash&#39;</span>,</span>
<span id="cb17-35"><a href="imputation.html#cb17-35" aria-hidden="true" tabindex="-1"></a>                     <span class="at">PL =</span> <span class="st">&#39;largetooth aspen&#39;</span>,</span>
<span id="cb17-36"><a href="imputation.html#cb17-36" aria-hidden="true" tabindex="-1"></a>                     <span class="at">AG =</span> <span class="st">&#39;red ash&#39;</span>,</span>
<span id="cb17-37"><a href="imputation.html#cb17-37" aria-hidden="true" tabindex="-1"></a>                     <span class="at">OW =</span> <span class="st">&#39;white oak&#39;</span>,</span>
<span id="cb17-38"><a href="imputation.html#cb17-38" aria-hidden="true" tabindex="-1"></a>                     <span class="at">IW =</span> <span class="st">&#39;ironwood&#39;</span>,</span>
<span id="cb17-39"><a href="imputation.html#cb17-39" aria-hidden="true" tabindex="-1"></a>                     <span class="at">OB =</span> <span class="st">&#39;bur oak&#39;</span>,</span>
<span id="cb17-40"><a href="imputation.html#cb17-40" aria-hidden="true" tabindex="-1"></a>                     <span class="at">EW =</span> <span class="st">&#39;white elm&#39;</span>,</span>
<span id="cb17-41"><a href="imputation.html#cb17-41" aria-hidden="true" tabindex="-1"></a>                     <span class="at">MS =</span> <span class="st">&#39;silver maple&#39;</span>,</span>
<span id="cb17-42"><a href="imputation.html#cb17-42" aria-hidden="true" tabindex="-1"></a>                     <span class="at">PS =</span> <span class="st">&#39;scots pine&#39;</span>,</span>
<span id="cb17-43"><a href="imputation.html#cb17-43" aria-hidden="true" tabindex="-1"></a>                     <span class="at">OH =</span> <span class="st">&#39;other hardwoods&#39;</span>,</span>
<span id="cb17-44"><a href="imputation.html#cb17-44" aria-hidden="true" tabindex="-1"></a>                     <span class="at">BG =</span> <span class="st">&#39;grey birch&#39;</span>,</span>
<span id="cb17-45"><a href="imputation.html#cb17-45" aria-hidden="true" tabindex="-1"></a>                     <span class="at">AL =</span> <span class="st">&#39;alder&#39;</span>,</span>
<span id="cb17-46"><a href="imputation.html#cb17-46" aria-hidden="true" tabindex="-1"></a>                     <span class="at">SR =</span> <span class="st">&#39;red spruce&#39;</span>,</span>
<span id="cb17-47"><a href="imputation.html#cb17-47" aria-hidden="true" tabindex="-1"></a>                     <span class="at">BB =</span> <span class="st">&#39;blue beech&#39;</span>,</span>
<span id="cb17-48"><a href="imputation.html#cb17-48" aria-hidden="true" tabindex="-1"></a>                     <span class="at">MT =</span> <span class="st">&#39;mountain maple&#39;</span>,</span>
<span id="cb17-49"><a href="imputation.html#cb17-49" aria-hidden="true" tabindex="-1"></a>                     <span class="at">MB =</span> <span class="st">&#39;black maple&#39;</span>,</span>
<span id="cb17-50"><a href="imputation.html#cb17-50" aria-hidden="true" tabindex="-1"></a>                     <span class="at">OC =</span> <span class="st">&#39;other conifers&#39;</span>,</span>
<span id="cb17-51"><a href="imputation.html#cb17-51" aria-hidden="true" tabindex="-1"></a>                     <span class="at">SN =</span> <span class="st">&#39;norway spruce&#39;</span>,</span>
<span id="cb17-52"><a href="imputation.html#cb17-52" aria-hidden="true" tabindex="-1"></a>                     <span class="at">PE =</span> <span class="st">&#39;silver poplar&#39;</span>,</span>
<span id="cb17-53"><a href="imputation.html#cb17-53" aria-hidden="true" tabindex="-1"></a>                     <span class="at">HI =</span> <span class="st">&#39;hickory&#39;</span>,</span>
<span id="cb17-54"><a href="imputation.html#cb17-54" aria-hidden="true" tabindex="-1"></a>                     <span class="at">AX =</span> <span class="st">&#39;ash&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-55"><a href="imputation.html#cb17-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(), <span class="at">names_to =</span> <span class="st">&quot;abb&quot;</span>, <span class="at">values_to =</span> <span class="st">&quot;common&quot;</span>)</span>
<span id="cb17-56"><a href="imputation.html#cb17-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-57"><a href="imputation.html#cb17-57" aria-hidden="true" tabindex="-1"></a>  dict<span class="sc">$</span>common[<span class="fu">match</span>(sp_abbrev, dict<span class="sc">$</span>abb)]</span>
<span id="cb17-58"><a href="imputation.html#cb17-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-59"><a href="imputation.html#cb17-59" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-60"><a href="imputation.html#cb17-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-61"><a href="imputation.html#cb17-61" aria-hidden="true" tabindex="-1"></a><span class="co"># assign either coniferous or deciduous</span></span>
<span id="cb17-62"><a href="imputation.html#cb17-62" aria-hidden="true" tabindex="-1"></a>assign_type <span class="ot">&lt;-</span> <span class="cf">function</span>(sp_common) {</span>
<span id="cb17-63"><a href="imputation.html#cb17-63" aria-hidden="true" tabindex="-1"></a>  sp_common  <span class="ot">&lt;-</span> <span class="fu">tolower</span>(sp_common)</span>
<span id="cb17-64"><a href="imputation.html#cb17-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ifelse</span>(stringr<span class="sc">::</span><span class="fu">str_detect</span>(sp_common, <span class="at">pattern =</span> <span class="st">&quot;pine|spruce|fir|cedar|larch|conifers|hemlock&quot;</span>), <span class="st">&quot;Coniferous&quot;</span>, <span class="st">&quot;Deciduous&quot;</span>)</span>
<span id="cb17-65"><a href="imputation.html#cb17-65" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-66"><a href="imputation.html#cb17-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-67"><a href="imputation.html#cb17-67" aria-hidden="true" tabindex="-1"></a><span class="do">####################################</span></span>
<span id="cb17-68"><a href="imputation.html#cb17-68" aria-hidden="true" tabindex="-1"></a><span class="do">### CALCULATE SPECIES ATTRIBUTES </span><span class="al">###</span></span>
<span id="cb17-69"><a href="imputation.html#cb17-69" aria-hidden="true" tabindex="-1"></a><span class="do">####################################</span></span>
<span id="cb17-70"><a href="imputation.html#cb17-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-71"><a href="imputation.html#cb17-71" aria-hidden="true" tabindex="-1"></a><span class="co"># load fri</span></span>
<span id="cb17-72"><a href="imputation.html#cb17-72" aria-hidden="true" tabindex="-1"></a>poly_fri <span class="ot">&lt;-</span> <span class="fu">st_read</span>(fri)</span>
<span id="cb17-73"><a href="imputation.html#cb17-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-74"><a href="imputation.html#cb17-74" aria-hidden="true" tabindex="-1"></a><span class="co"># separate SPCOMP string into individual columns</span></span>
<span id="cb17-75"><a href="imputation.html#cb17-75" aria-hidden="true" tabindex="-1"></a>poly_fri_for <span class="ot">&lt;-</span> poly_fri <span class="sc">%&gt;%</span></span>
<span id="cb17-76"><a href="imputation.html#cb17-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb17-77"><a href="imputation.html#cb17-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(POLYTYPE <span class="sc">==</span> <span class="st">&quot;FOR&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-78"><a href="imputation.html#cb17-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(POLYID, POLYTYPE, SPCOMP) <span class="sc">%&gt;%</span> <span class="co"># these need to match FRI attr fields</span></span>
<span id="cb17-79"><a href="imputation.html#cb17-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">new_SP =</span> <span class="fu">str_match_all</span>(SPCOMP, <span class="st">&quot;[A-Z]{2}[ ]+[0-9]+&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb17-80"><a href="imputation.html#cb17-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(new_SP) <span class="sc">%&gt;%</span></span>
<span id="cb17-81"><a href="imputation.html#cb17-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">new_SP =</span> <span class="fu">as.character</span>(new_SP)) <span class="sc">%&gt;%</span></span>
<span id="cb17-82"><a href="imputation.html#cb17-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(new_SP, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">&quot;SP&quot;</span>, <span class="st">&quot;PROP&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb17-83"><a href="imputation.html#cb17-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">PROP =</span> <span class="fu">as.numeric</span>(PROP),</span>
<span id="cb17-84"><a href="imputation.html#cb17-84" aria-hidden="true" tabindex="-1"></a>         <span class="at">Common =</span> <span class="fu">assign_common_name</span>(SP),</span>
<span id="cb17-85"><a href="imputation.html#cb17-85" aria-hidden="true" tabindex="-1"></a>         <span class="at">sp_type =</span> <span class="fu">assign_type</span>(Common))</span>
<span id="cb17-86"><a href="imputation.html#cb17-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-87"><a href="imputation.html#cb17-87" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate polygon level species groups</span></span>
<span id="cb17-88"><a href="imputation.html#cb17-88" aria-hidden="true" tabindex="-1"></a><span class="co"># percent species type</span></span>
<span id="cb17-89"><a href="imputation.html#cb17-89" aria-hidden="true" tabindex="-1"></a>poly_dom_type <span class="ot">&lt;-</span> poly_fri_for <span class="sc">%&gt;%</span></span>
<span id="cb17-90"><a href="imputation.html#cb17-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(POLYID) <span class="sc">%&gt;%</span></span>
<span id="cb17-91"><a href="imputation.html#cb17-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">per_conif =</span> <span class="fu">sum</span>(PROP[sp_type <span class="sc">==</span> <span class="st">&quot;Coniferous&quot;</span>]), </span>
<span id="cb17-92"><a href="imputation.html#cb17-92" aria-hidden="true" tabindex="-1"></a>            <span class="at">per_decid =</span> <span class="fu">sum</span>(PROP[sp_type <span class="sc">==</span> <span class="st">&quot;Deciduous&quot;</span>]))</span>
<span id="cb17-93"><a href="imputation.html#cb17-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-94"><a href="imputation.html#cb17-94" aria-hidden="true" tabindex="-1"></a><span class="co"># leading species</span></span>
<span id="cb17-95"><a href="imputation.html#cb17-95" aria-hidden="true" tabindex="-1"></a>poly_dom_sp <span class="ot">&lt;-</span> poly_fri_for <span class="sc">%&gt;%</span></span>
<span id="cb17-96"><a href="imputation.html#cb17-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(POLYID) <span class="sc">%&gt;%</span></span>
<span id="cb17-97"><a href="imputation.html#cb17-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(PROP, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">with_ties =</span> <span class="cn">FALSE</span>)</span>
<span id="cb17-98"><a href="imputation.html#cb17-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-99"><a href="imputation.html#cb17-99" aria-hidden="true" tabindex="-1"></a><span class="co"># combine type with leading species</span></span>
<span id="cb17-100"><a href="imputation.html#cb17-100" aria-hidden="true" tabindex="-1"></a>poly_dom_sp_group <span class="ot">&lt;-</span> <span class="fu">inner_join</span>(poly_dom_type, poly_dom_sp, <span class="at">by =</span> <span class="st">&quot;POLYID&quot;</span>)</span>
<span id="cb17-101"><a href="imputation.html#cb17-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-102"><a href="imputation.html#cb17-102" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate functional groups</span></span>
<span id="cb17-103"><a href="imputation.html#cb17-103" aria-hidden="true" tabindex="-1"></a>poly_dom_sp_group <span class="ot">&lt;-</span> poly_dom_sp_group <span class="sc">%&gt;%</span></span>
<span id="cb17-104"><a href="imputation.html#cb17-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SpeciesGroup1 =</span> <span class="fu">ifelse</span>(PROP <span class="sc">&gt;=</span> <span class="dv">70</span>, Common, </span>
<span id="cb17-105"><a href="imputation.html#cb17-105" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">ifelse</span>(PROP <span class="sc">&lt;</span> <span class="dv">70</span> <span class="sc">&amp;</span> per_conif <span class="sc">&gt;=</span> <span class="dv">70</span>, <span class="st">&quot;Mixed Coniferous&quot;</span>,</span>
<span id="cb17-106"><a href="imputation.html#cb17-106" aria-hidden="true" tabindex="-1"></a>                                       <span class="fu">ifelse</span>(PROP <span class="sc">&lt;</span> <span class="dv">70</span> <span class="sc">&amp;</span> per_decid <span class="sc">&gt;=</span> <span class="dv">70</span>, <span class="st">&quot;Mixed Deciduous&quot;</span>, <span class="st">&quot;Mixedwoods&quot;</span>))), </span>
<span id="cb17-107"><a href="imputation.html#cb17-107" aria-hidden="true" tabindex="-1"></a>         <span class="at">SpeciesGroup2 =</span> <span class="fu">ifelse</span>(Common <span class="sc">==</span> <span class="st">&quot;jack pine&quot;</span> <span class="sc">&amp;</span> PROP <span class="sc">&gt;=</span> <span class="dv">50</span> <span class="sc">&amp;</span> per_conif <span class="sc">&gt;=</span> <span class="dv">70</span>, <span class="st">&quot;Jack Pine Dominated&quot;</span>, <span class="fu">ifelse</span>(</span>
<span id="cb17-108"><a href="imputation.html#cb17-108" aria-hidden="true" tabindex="-1"></a>           Common <span class="sc">==</span> <span class="st">&quot;black spruce&quot;</span> <span class="sc">&amp;</span> PROP <span class="sc">&gt;=</span> <span class="dv">50</span> <span class="sc">&amp;</span> per_conif <span class="sc">&gt;=</span> <span class="dv">70</span>, <span class="st">&quot;Black Spruce Dominated&quot;</span>, <span class="fu">ifelse</span>(</span>
<span id="cb17-109"><a href="imputation.html#cb17-109" aria-hidden="true" tabindex="-1"></a>             per_decid <span class="sc">&gt;=</span> <span class="dv">70</span>, <span class="st">&quot;Hardwood&quot;</span>, <span class="fu">ifelse</span>(</span>
<span id="cb17-110"><a href="imputation.html#cb17-110" aria-hidden="true" tabindex="-1"></a>               per_decid <span class="sc">&gt;=</span> <span class="dv">30</span> <span class="sc">&amp;</span> per_decid <span class="sc">&lt;=</span> <span class="dv">70</span> <span class="sc">&amp;</span> per_conif <span class="sc">&gt;=</span> <span class="dv">30</span> <span class="sc">&amp;</span> per_conif <span class="sc">&lt;=</span> <span class="dv">70</span>, <span class="st">&quot;Mixedwood&quot;</span>, <span class="st">&quot;Mixed Conifers&quot;</span></span>
<span id="cb17-111"><a href="imputation.html#cb17-111" aria-hidden="true" tabindex="-1"></a>             )))), </span>
<span id="cb17-112"><a href="imputation.html#cb17-112" aria-hidden="true" tabindex="-1"></a>         <span class="at">SpeciesGroup3 =</span> <span class="fu">ifelse</span>(per_conif <span class="sc">&gt;=</span> <span class="dv">70</span>, <span class="st">&quot;Softwood&quot;</span>, </span>
<span id="cb17-113"><a href="imputation.html#cb17-113" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">ifelse</span>(per_decid <span class="sc">&gt;=</span> <span class="dv">70</span>, <span class="st">&quot;Hardwood&quot;</span>, <span class="st">&quot;Mixedwood&quot;</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb17-114"><a href="imputation.html#cb17-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="at">.cols =</span> <span class="fu">starts_with</span>(<span class="st">&quot;SpeciesGroup&quot;</span>), <span class="at">.fns =</span> as.factor)) <span class="sc">%&gt;%</span></span>
<span id="cb17-115"><a href="imputation.html#cb17-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(POLYID, SpeciesGroup2, SpeciesGroup3) <span class="sc">%&gt;%</span></span>
<span id="cb17-116"><a href="imputation.html#cb17-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">class5 =</span> SpeciesGroup2, <span class="at">class3 =</span> SpeciesGroup3)</span>
<span id="cb17-117"><a href="imputation.html#cb17-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-118"><a href="imputation.html#cb17-118" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate leading and second species only</span></span>
<span id="cb17-119"><a href="imputation.html#cb17-119" aria-hidden="true" tabindex="-1"></a>poly_fri_sp <span class="ot">&lt;-</span> poly_fri <span class="sc">%&gt;%</span></span>
<span id="cb17-120"><a href="imputation.html#cb17-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb17-121"><a href="imputation.html#cb17-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(POLYTYPE <span class="sc">==</span> <span class="st">&quot;FOR&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-122"><a href="imputation.html#cb17-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(POLYID, POLYTYPE, SPCOMP) <span class="sc">%&gt;%</span> <span class="co"># these need to match FRI attr fields</span></span>
<span id="cb17-123"><a href="imputation.html#cb17-123" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">new_SP =</span> <span class="fu">str_match_all</span>(SPCOMP, <span class="st">&quot;[A-Z]{2}[ ]+[0-9]+&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb17-124"><a href="imputation.html#cb17-124" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest_wider</span>(new_SP, <span class="at">names_sep =</span> <span class="st">&#39;&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-125"><a href="imputation.html#cb17-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">new_SP =</span> new_SP1) <span class="sc">%&gt;%</span></span>
<span id="cb17-126"><a href="imputation.html#cb17-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">new_SP =</span> <span class="fu">as.character</span>(new_SP),</span>
<span id="cb17-127"><a href="imputation.html#cb17-127" aria-hidden="true" tabindex="-1"></a>         <span class="at">new_SP2 =</span> <span class="fu">as.character</span>(new_SP2)) <span class="sc">%&gt;%</span></span>
<span id="cb17-128"><a href="imputation.html#cb17-128" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(new_SP, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">&quot;SP&quot;</span>, <span class="st">&quot;PROP&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb17-129"><a href="imputation.html#cb17-129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(new_SP2, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">&quot;SP2&quot;</span>, <span class="st">&quot;PROP2&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb17-130"><a href="imputation.html#cb17-130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(POLYID, SP, SP2)</span>
<span id="cb17-131"><a href="imputation.html#cb17-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-132"><a href="imputation.html#cb17-132" aria-hidden="true" tabindex="-1"></a><span class="co"># join functional groups with leading and second species</span></span>
<span id="cb17-133"><a href="imputation.html#cb17-133" aria-hidden="true" tabindex="-1"></a>poly_dom_sp_group <span class="ot">&lt;-</span> <span class="fu">left_join</span>(poly_dom_sp_group,</span>
<span id="cb17-134"><a href="imputation.html#cb17-134" aria-hidden="true" tabindex="-1"></a>                               poly_fri_sp,</span>
<span id="cb17-135"><a href="imputation.html#cb17-135" aria-hidden="true" tabindex="-1"></a>                               <span class="at">by =</span> <span class="st">&#39;POLYID&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-136"><a href="imputation.html#cb17-136" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">SP1 =</span> SP)</span>
<span id="cb17-137"><a href="imputation.html#cb17-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-138"><a href="imputation.html#cb17-138" aria-hidden="true" tabindex="-1"></a><span class="co"># join to FRI extracted dataframe</span></span>
<span id="cb17-139"><a href="imputation.html#cb17-139" aria-hidden="true" tabindex="-1"></a>dat_fri <span class="ot">&lt;-</span> <span class="fu">left_join</span>(dat_fri,</span>
<span id="cb17-140"><a href="imputation.html#cb17-140" aria-hidden="true" tabindex="-1"></a>                     poly_dom_sp_group,</span>
<span id="cb17-141"><a href="imputation.html#cb17-141" aria-hidden="true" tabindex="-1"></a>                     <span class="at">by =</span> <span class="st">&#39;POLYID&#39;</span>)</span>
<span id="cb17-142"><a href="imputation.html#cb17-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-143"><a href="imputation.html#cb17-143" aria-hidden="true" tabindex="-1"></a><span class="co"># re-save extracted dataframe for fast rebooting</span></span>
<span id="cb17-144"><a href="imputation.html#cb17-144" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(dat_fri, <span class="at">file =</span> <span class="fu">str_c</span>(out_dir, <span class="st">&#39;/temp/dat_fri_extr.RData&#39;</span>))</span></code></pre></div>
</div>
<div id="imputation57" class="section level2 unnumbered hasAnchor">
<h2><strong>5.7</strong> Pre-processing: Forest Data Screening<a href="imputation.html#imputation57" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>FRI and GRM polygons delineate the entire landscape, not just forest stands. Since we are only interested in imputing age and species attributes in forest stands, it is important to screen the FRI and GRM datasets and remove polygons that do not fit certain data criteria representative of forest stands. We want to ensure:</p>
<ul>
<li>We only use FRI polygons for imputation that are forested, to ensure accurate and representative data points</li>
<li>We only impute values into GRM polygons that are forested, since age and species attributes do not apply to non-forested polygons</li>
</ul>
<p>The current data criteria being used is as follows:</p>
<ul>
<li>POLYTYPE == ‘FOR’ (for FRI polygons only)</li>
<li>polygon &gt;= 50% forested landcover</li>
<li>p95 &gt;= 5 meters (broad definition of ‘forest’)</li>
<li>Canopy cover &gt;= 50%</li>
</ul>
<p>We first apply data screening to the FRI polygons.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="imputation.html#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="do">#####################</span></span>
<span id="cb18-2"><a href="imputation.html#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="do">### LOAD FRI DATA </span><span class="al">###</span></span>
<span id="cb18-3"><a href="imputation.html#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="do">#####################</span></span>
<span id="cb18-4"><a href="imputation.html#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="imputation.html#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co"># load FRI polygons</span></span>
<span id="cb18-6"><a href="imputation.html#cb18-6" aria-hidden="true" tabindex="-1"></a>poly <span class="ot">&lt;-</span> <span class="fu">vect</span>(fri)</span>
<span id="cb18-7"><a href="imputation.html#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="imputation.html#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co"># load FRI polygon data frame</span></span>
<span id="cb18-9"><a href="imputation.html#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="fu">str_c</span>(out_dir, <span class="st">&#39;/temp/dat_fri_extr.RData&#39;</span>))</span>
<span id="cb18-10"><a href="imputation.html#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="imputation.html#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb18-12"><a href="imputation.html#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="do">### DATA SCREENING PART 1 </span><span class="al">###</span></span>
<span id="cb18-13"><a href="imputation.html#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb18-14"><a href="imputation.html#cb18-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-15"><a href="imputation.html#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="co"># remove all non-forested polygons</span></span>
<span id="cb18-16"><a href="imputation.html#cb18-16" aria-hidden="true" tabindex="-1"></a>dat_fri <span class="ot">&lt;-</span> <span class="fu">filter</span>(dat_fri, POLYTYPE <span class="sc">==</span> <span class="st">&#39;FOR&#39;</span>)</span>
<span id="cb18-17"><a href="imputation.html#cb18-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-18"><a href="imputation.html#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="co"># create smaller polygon set only FOR polytypes</span></span>
<span id="cb18-19"><a href="imputation.html#cb18-19" aria-hidden="true" tabindex="-1"></a>poly_fri <span class="ot">&lt;-</span> poly[poly<span class="sc">$</span>POLYTYPE <span class="sc">==</span> <span class="st">&#39;FOR&#39;</span>]</span>
<span id="cb18-20"><a href="imputation.html#cb18-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-21"><a href="imputation.html#cb18-21" aria-hidden="true" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb18-22"><a href="imputation.html#cb18-22" aria-hidden="true" tabindex="-1"></a><span class="do">### DATA SCREENING PART 2 </span><span class="al">###</span></span>
<span id="cb18-23"><a href="imputation.html#cb18-23" aria-hidden="true" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb18-24"><a href="imputation.html#cb18-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-25"><a href="imputation.html#cb18-25" aria-hidden="true" tabindex="-1"></a><span class="co"># polygon landcover &gt; 50% forested</span></span>
<span id="cb18-26"><a href="imputation.html#cb18-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-27"><a href="imputation.html#cb18-27" aria-hidden="true" tabindex="-1"></a><span class="co"># load VLCE 2.0 landcover dataset from 2018</span></span>
<span id="cb18-28"><a href="imputation.html#cb18-28" aria-hidden="true" tabindex="-1"></a>lc <span class="ot">&lt;-</span> <span class="fu">rast</span>(lc_f)</span>
<span id="cb18-29"><a href="imputation.html#cb18-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-30"><a href="imputation.html#cb18-30" aria-hidden="true" tabindex="-1"></a><span class="co"># project poly to crs of raster</span></span>
<span id="cb18-31"><a href="imputation.html#cb18-31" aria-hidden="true" tabindex="-1"></a>poly_lc <span class="ot">&lt;-</span> <span class="fu">project</span>(poly_fri, lc)</span>
<span id="cb18-32"><a href="imputation.html#cb18-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-33"><a href="imputation.html#cb18-33" aria-hidden="true" tabindex="-1"></a><span class="co"># convert to sf</span></span>
<span id="cb18-34"><a href="imputation.html#cb18-34" aria-hidden="true" tabindex="-1"></a>poly_lcsf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(poly_lc)</span>
<span id="cb18-35"><a href="imputation.html#cb18-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-36"><a href="imputation.html#cb18-36" aria-hidden="true" tabindex="-1"></a><span class="co"># extract landcover values</span></span>
<span id="cb18-37"><a href="imputation.html#cb18-37" aria-hidden="true" tabindex="-1"></a>lc_poly <span class="ot">&lt;-</span> <span class="fu">exact_extract</span>(lc, poly_lcsf)</span>
<span id="cb18-38"><a href="imputation.html#cb18-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-39"><a href="imputation.html#cb18-39" aria-hidden="true" tabindex="-1"></a><span class="co"># set landcover class key with single forested class</span></span>
<span id="cb18-40"><a href="imputation.html#cb18-40" aria-hidden="true" tabindex="-1"></a>lc_key_for <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">0</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&#39;NA&#39;</span>,</span>
<span id="cb18-41"><a href="imputation.html#cb18-41" aria-hidden="true" tabindex="-1"></a>                <span class="st">`</span><span class="at">20</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&#39;Water&#39;</span>,</span>
<span id="cb18-42"><a href="imputation.html#cb18-42" aria-hidden="true" tabindex="-1"></a>                <span class="st">`</span><span class="at">31</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&#39;Snow/Ice&#39;</span>,</span>
<span id="cb18-43"><a href="imputation.html#cb18-43" aria-hidden="true" tabindex="-1"></a>                <span class="st">`</span><span class="at">32</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&#39;Rock/Rubble&#39;</span>,</span>
<span id="cb18-44"><a href="imputation.html#cb18-44" aria-hidden="true" tabindex="-1"></a>                <span class="st">`</span><span class="at">33</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&#39;Exposed/Barren Land&#39;</span>,</span>
<span id="cb18-45"><a href="imputation.html#cb18-45" aria-hidden="true" tabindex="-1"></a>                <span class="st">`</span><span class="at">40</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&#39;Bryoids&#39;</span>,</span>
<span id="cb18-46"><a href="imputation.html#cb18-46" aria-hidden="true" tabindex="-1"></a>                <span class="st">`</span><span class="at">50</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&#39;Shrubland&#39;</span>,</span>
<span id="cb18-47"><a href="imputation.html#cb18-47" aria-hidden="true" tabindex="-1"></a>                <span class="st">`</span><span class="at">80</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&#39;Wetland&#39;</span>,</span>
<span id="cb18-48"><a href="imputation.html#cb18-48" aria-hidden="true" tabindex="-1"></a>                <span class="st">`</span><span class="at">81</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&#39;Forest&#39;</span>,</span>
<span id="cb18-49"><a href="imputation.html#cb18-49" aria-hidden="true" tabindex="-1"></a>                <span class="st">`</span><span class="at">100</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&#39;Herbs&#39;</span>,</span>
<span id="cb18-50"><a href="imputation.html#cb18-50" aria-hidden="true" tabindex="-1"></a>                <span class="st">`</span><span class="at">210</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&#39;Forest&#39;</span>,</span>
<span id="cb18-51"><a href="imputation.html#cb18-51" aria-hidden="true" tabindex="-1"></a>                <span class="st">`</span><span class="at">220</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&#39;Forest&#39;</span>,</span>
<span id="cb18-52"><a href="imputation.html#cb18-52" aria-hidden="true" tabindex="-1"></a>                <span class="st">`</span><span class="at">230</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&#39;Forest&#39;</span>)</span>
<span id="cb18-53"><a href="imputation.html#cb18-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-54"><a href="imputation.html#cb18-54" aria-hidden="true" tabindex="-1"></a><span class="co"># find pixels with forest at least 50% of pixel</span></span>
<span id="cb18-55"><a href="imputation.html#cb18-55" aria-hidden="true" tabindex="-1"></a><span class="co"># apply over list</span></span>
<span id="cb18-56"><a href="imputation.html#cb18-56" aria-hidden="true" tabindex="-1"></a>lc_dom_for <span class="ot">&lt;-</span> <span class="fu">sapply</span>(lc_poly, <span class="cf">function</span>(x){</span>
<span id="cb18-57"><a href="imputation.html#cb18-57" aria-hidden="true" tabindex="-1"></a>  x<span class="sc">$</span>value <span class="ot">&lt;-</span> <span class="fu">recode</span>(x<span class="sc">$</span>value, <span class="sc">!!!</span>lc_key_for)</span>
<span id="cb18-58"><a href="imputation.html#cb18-58" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(value) <span class="sc">%&gt;%</span> <span class="fu">summarize</span>(<span class="at">sum =</span> <span class="fu">sum</span>(coverage_fraction))</span>
<span id="cb18-59"><a href="imputation.html#cb18-59" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> x<span class="sc">$</span>value[<span class="fu">which</span>(x<span class="sc">$</span>sum <span class="sc">==</span> <span class="fu">max</span>(x<span class="sc">$</span>sum))]</span>
<span id="cb18-60"><a href="imputation.html#cb18-60" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>((<span class="fu">length</span>(m) <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">&amp;</span> (m <span class="sc">==</span> <span class="st">&#39;Forest&#39;</span>)[<span class="dv">1</span>]){</span>
<span id="cb18-61"><a href="imputation.html#cb18-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(x<span class="sc">$</span>sum[x<span class="sc">$</span>value <span class="sc">==</span> m]<span class="sc">/</span><span class="fu">sum</span>(x<span class="sc">$</span>sum) <span class="sc">&gt;=</span> <span class="fl">0.5</span>){</span>
<span id="cb18-62"><a href="imputation.html#cb18-62" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="st">&#39;Yes&#39;</span>)</span>
<span id="cb18-63"><a href="imputation.html#cb18-63" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{<span class="fu">return</span>(<span class="st">&#39;No&#39;</span>)}</span>
<span id="cb18-64"><a href="imputation.html#cb18-64" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{<span class="fu">return</span>(<span class="st">&#39;No&#39;</span>)}</span>
<span id="cb18-65"><a href="imputation.html#cb18-65" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb18-66"><a href="imputation.html#cb18-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-67"><a href="imputation.html#cb18-67" aria-hidden="true" tabindex="-1"></a><span class="co"># add new columns into dat</span></span>
<span id="cb18-68"><a href="imputation.html#cb18-68" aria-hidden="true" tabindex="-1"></a>dat_fri <span class="ot">&lt;-</span> dat_fri <span class="sc">%&gt;%</span> <span class="fu">add_column</span>(<span class="at">dom_for =</span> lc_dom_for)</span>
<span id="cb18-69"><a href="imputation.html#cb18-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-70"><a href="imputation.html#cb18-70" aria-hidden="true" tabindex="-1"></a><span class="co"># subset FRI data frame based on whether polygon dominated by forest</span></span>
<span id="cb18-71"><a href="imputation.html#cb18-71" aria-hidden="true" tabindex="-1"></a>dat_fri_scr <span class="ot">&lt;-</span> dat_fri <span class="sc">%&gt;%</span> <span class="fu">filter</span>(dom_for <span class="sc">==</span> <span class="st">&#39;Yes&#39;</span>)</span>
<span id="cb18-72"><a href="imputation.html#cb18-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-73"><a href="imputation.html#cb18-73" aria-hidden="true" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb18-74"><a href="imputation.html#cb18-74" aria-hidden="true" tabindex="-1"></a><span class="do">### DATA SCREENING PART 3 </span><span class="al">###</span></span>
<span id="cb18-75"><a href="imputation.html#cb18-75" aria-hidden="true" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb18-76"><a href="imputation.html#cb18-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-77"><a href="imputation.html#cb18-77" aria-hidden="true" tabindex="-1"></a><span class="co"># require p95 &gt;= 5</span></span>
<span id="cb18-78"><a href="imputation.html#cb18-78" aria-hidden="true" tabindex="-1"></a><span class="co"># require cc &gt;= 50</span></span>
<span id="cb18-79"><a href="imputation.html#cb18-79" aria-hidden="true" tabindex="-1"></a>dat_fri_scr <span class="sc">%&lt;&gt;%</span> <span class="fu">filter</span>(p95 <span class="sc">&gt;=</span> <span class="dv">5</span>, cc <span class="sc">&gt;=</span> <span class="dv">50</span>)</span>
<span id="cb18-80"><a href="imputation.html#cb18-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-81"><a href="imputation.html#cb18-81" aria-hidden="true" tabindex="-1"></a><span class="co"># save extracted data frame for fast rebooting</span></span>
<span id="cb18-82"><a href="imputation.html#cb18-82" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(dat_fri_scr, <span class="at">file =</span> <span class="fu">str_c</span>(out_dir, <span class="st">&#39;/temp/dat_fri_scr.RData&#39;</span>))</span></code></pre></div>
<p>We next apply the data screening to the GRM polygons.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="imputation.html#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="do">#####################</span></span>
<span id="cb19-2"><a href="imputation.html#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="do">### LOAD GRM DATA </span><span class="al">###</span></span>
<span id="cb19-3"><a href="imputation.html#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="do">#####################</span></span>
<span id="cb19-4"><a href="imputation.html#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="imputation.html#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co"># load GRM polygon data frame</span></span>
<span id="cb19-6"><a href="imputation.html#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="fu">str_c</span>(out_dir, <span class="st">&#39;/temp/dat_grm_extr.RData&#39;</span>))</span>
<span id="cb19-7"><a href="imputation.html#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="imputation.html#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="do">######################</span></span>
<span id="cb19-9"><a href="imputation.html#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="do">### DATA SCREENING </span><span class="al">###</span></span>
<span id="cb19-10"><a href="imputation.html#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="do">######################</span></span>
<span id="cb19-11"><a href="imputation.html#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="imputation.html#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Don&#39;t screen GRM polygons for POLYTYPE == FOR</span></span>
<span id="cb19-13"><a href="imputation.html#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="imputation.html#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co"># polygon landcover &gt; 50% forested</span></span>
<span id="cb19-15"><a href="imputation.html#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co"># dom_for attribute already exists in GRM data from segmentation</span></span>
<span id="cb19-16"><a href="imputation.html#cb19-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-17"><a href="imputation.html#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="co"># require p95 &gt;= 5</span></span>
<span id="cb19-18"><a href="imputation.html#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="co"># require cc &gt;= 50</span></span>
<span id="cb19-19"><a href="imputation.html#cb19-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-20"><a href="imputation.html#cb19-20" aria-hidden="true" tabindex="-1"></a>dat_grm_scr <span class="ot">&lt;-</span> dat_grm <span class="sc">%&gt;%</span> <span class="fu">filter</span>(dom_for <span class="sc">==</span> <span class="st">&#39;Yes&#39;</span>,</span>
<span id="cb19-21"><a href="imputation.html#cb19-21" aria-hidden="true" tabindex="-1"></a>                                  p95 <span class="sc">&gt;=</span> <span class="dv">5</span>,</span>
<span id="cb19-22"><a href="imputation.html#cb19-22" aria-hidden="true" tabindex="-1"></a>                                  cc <span class="sc">&gt;=</span> <span class="dv">50</span>)</span>
<span id="cb19-23"><a href="imputation.html#cb19-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-24"><a href="imputation.html#cb19-24" aria-hidden="true" tabindex="-1"></a><span class="co"># save extracted data frame for fast rebooting</span></span>
<span id="cb19-25"><a href="imputation.html#cb19-25" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(dat_grm_scr, <span class="at">file =</span> <span class="fu">str_c</span>(out_dir, <span class="st">&#39;/temp/dat_grm_scr.RData&#39;</span>))</span></code></pre></div>
</div>
<div id="imputation58" class="section level2 unnumbered hasAnchor">
<h2><strong>5.8</strong> Execute Imputation Algorithm Over FRI Polygons ONLY<a href="imputation.html#imputation58" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The goal of this imputation procedure is to estimate age and species composition in GRM segmented forest polygons. But it is also important to assess the performance of the algorithm. To best do this, we first conduct imputation over the FRI dataset ONLY. For each FRI polygon, we find the k-nearest neighbors (k=5), and calculate the age and species composition attributes to impute (a “leave one out” approach”). We can then compare the observed age and species composition of the polygon to the imputed values. Note we have to do this calculation on the FRI dataset alone because we do not have observed age and species composition values for the GRM segmented polygons. Also note that ALL attributes are imputed from the same k-nearest neighbors. The algorithm is not run for individual attributes.</p>
<p>For age, we report root mean squared difference (RMSD), mean absolute error (MAE) and mean bias error (MBE). RMSD was used in the performance analysis to assess results between algorithm runs and to decide upon an optimal model (see forthcoming journal article). MAE gives an average error of imputed age in years. MBE gives an indication of whether we are imputing younger or older ages on average.</p>
<p>For species composition, we report the percent of observed and imputed values that match (accuracy).</p>
<p>We also calculate performance metrics on the X-variables used in imputation: relative RMSD (RRMSD) and relative MBE (RMBE), calculated by dividing RMSD and RMBE by the mean value of each variable and multiplying by 100. RRMSD and RMBE give a percent error that can be compared across variables and when variables have difficult to interpret units, such as several of the ALS metrics used in imputation.</p>
<p>First we define the functions needed for imputation.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="imputation.html#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="do">######################################################</span></span>
<span id="cb20-2"><a href="imputation.html#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="do">### FUNCTIONS TO RUN K NEAREST NEIGHBOR IMPUTATION </span><span class="al">###</span></span>
<span id="cb20-3"><a href="imputation.html#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="do">######################################################</span></span>
<span id="cb20-4"><a href="imputation.html#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="imputation.html#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co"># create mode function</span></span>
<span id="cb20-6"><a href="imputation.html#cb20-6" aria-hidden="true" tabindex="-1"></a>getmode <span class="ot">&lt;-</span> <span class="cf">function</span>(v) {</span>
<span id="cb20-7"><a href="imputation.html#cb20-7" aria-hidden="true" tabindex="-1"></a>  uniqv <span class="ot">&lt;-</span> <span class="fu">unique</span>(v)</span>
<span id="cb20-8"><a href="imputation.html#cb20-8" aria-hidden="true" tabindex="-1"></a>  uniqv[<span class="fu">which.max</span>(<span class="fu">tabulate</span>(<span class="fu">match</span>(v, uniqv)))]</span>
<span id="cb20-9"><a href="imputation.html#cb20-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-10"><a href="imputation.html#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="imputation.html#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co"># create rmsd function</span></span>
<span id="cb20-12"><a href="imputation.html#cb20-12" aria-hidden="true" tabindex="-1"></a>rmsd <span class="ot">&lt;-</span> <span class="cf">function</span>(obs, est){</span>
<span id="cb20-13"><a href="imputation.html#cb20-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sqrt</span>(<span class="fu">mean</span>((est <span class="sc">-</span> obs) <span class="sc">^</span> <span class="dv">2</span>))</span>
<span id="cb20-14"><a href="imputation.html#cb20-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-15"><a href="imputation.html#cb20-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-16"><a href="imputation.html#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="co"># create rrmsd function</span></span>
<span id="cb20-17"><a href="imputation.html#cb20-17" aria-hidden="true" tabindex="-1"></a>rrmsd <span class="ot">&lt;-</span> <span class="cf">function</span>(obs, est){</span>
<span id="cb20-18"><a href="imputation.html#cb20-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sqrt</span>(<span class="fu">mean</span>((est <span class="sc">-</span> obs) <span class="sc">^</span> <span class="dv">2</span>)) <span class="sc">/</span> <span class="fu">mean</span>(obs) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb20-19"><a href="imputation.html#cb20-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-20"><a href="imputation.html#cb20-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-21"><a href="imputation.html#cb20-21" aria-hidden="true" tabindex="-1"></a><span class="co"># create mae function</span></span>
<span id="cb20-22"><a href="imputation.html#cb20-22" aria-hidden="true" tabindex="-1"></a>mae <span class="ot">&lt;-</span> <span class="cf">function</span>(obs, est){</span>
<span id="cb20-23"><a href="imputation.html#cb20-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(<span class="fu">abs</span>(est <span class="sc">-</span> obs))</span>
<span id="cb20-24"><a href="imputation.html#cb20-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-25"><a href="imputation.html#cb20-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-26"><a href="imputation.html#cb20-26" aria-hidden="true" tabindex="-1"></a><span class="co"># create mbe function</span></span>
<span id="cb20-27"><a href="imputation.html#cb20-27" aria-hidden="true" tabindex="-1"></a>mbe <span class="ot">&lt;-</span> <span class="cf">function</span>(obs, est){</span>
<span id="cb20-28"><a href="imputation.html#cb20-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(est <span class="sc">-</span> obs)</span>
<span id="cb20-29"><a href="imputation.html#cb20-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-30"><a href="imputation.html#cb20-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-31"><a href="imputation.html#cb20-31" aria-hidden="true" tabindex="-1"></a><span class="co"># create rmbe function</span></span>
<span id="cb20-32"><a href="imputation.html#cb20-32" aria-hidden="true" tabindex="-1"></a>rmbe <span class="ot">&lt;-</span> <span class="cf">function</span>(obs, est){</span>
<span id="cb20-33"><a href="imputation.html#cb20-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(est <span class="sc">-</span> obs) <span class="sc">/</span> <span class="fu">mean</span>(obs) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb20-34"><a href="imputation.html#cb20-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-35"><a href="imputation.html#cb20-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-36"><a href="imputation.html#cb20-36" aria-hidden="true" tabindex="-1"></a><span class="co"># create knn function to output performance results</span></span>
<span id="cb20-37"><a href="imputation.html#cb20-37" aria-hidden="true" tabindex="-1"></a>run_knn_fri <span class="ot">&lt;-</span> <span class="cf">function</span>(dat, vars, k) {</span>
<span id="cb20-38"><a href="imputation.html#cb20-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-39"><a href="imputation.html#cb20-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># subset data</span></span>
<span id="cb20-40"><a href="imputation.html#cb20-40" aria-hidden="true" tabindex="-1"></a>  dat_nn <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">all_of</span>(vars))</span>
<span id="cb20-41"><a href="imputation.html#cb20-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-42"><a href="imputation.html#cb20-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># scale for nn computation</span></span>
<span id="cb20-43"><a href="imputation.html#cb20-43" aria-hidden="true" tabindex="-1"></a>  dat_nn_scaled <span class="ot">&lt;-</span> dat_nn <span class="sc">%&gt;%</span> scale</span>
<span id="cb20-44"><a href="imputation.html#cb20-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-45"><a href="imputation.html#cb20-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># run nearest neighbor</span></span>
<span id="cb20-46"><a href="imputation.html#cb20-46" aria-hidden="true" tabindex="-1"></a>  nn <span class="ot">&lt;-</span> <span class="fu">nn2</span>(dat_nn_scaled, dat_nn_scaled, <span class="at">k =</span> k <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb20-47"><a href="imputation.html#cb20-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-48"><a href="imputation.html#cb20-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get nn indices</span></span>
<span id="cb20-49"><a href="imputation.html#cb20-49" aria-hidden="true" tabindex="-1"></a>  nni <span class="ot">&lt;-</span> nn[[<span class="dv">1</span>]][, <span class="dv">2</span><span class="sc">:</span>(k <span class="sc">+</span> <span class="dv">1</span>)]</span>
<span id="cb20-50"><a href="imputation.html#cb20-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-51"><a href="imputation.html#cb20-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add vars to tibble</span></span>
<span id="cb20-52"><a href="imputation.html#cb20-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># take mean/mode if k &gt; 1</span></span>
<span id="cb20-53"><a href="imputation.html#cb20-53" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(k <span class="sc">&gt;</span> <span class="dv">1</span>){</span>
<span id="cb20-54"><a href="imputation.html#cb20-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(vars)){</span>
<span id="cb20-55"><a href="imputation.html#cb20-55" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb20-56"><a href="imputation.html#cb20-56" aria-hidden="true" tabindex="-1"></a>        nn_tab <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="sc">!!</span>vars[i] <span class="sc">:</span><span class="er">=</span> dat_nn[,i],</span>
<span id="cb20-57"><a href="imputation.html#cb20-57" aria-hidden="true" tabindex="-1"></a>                         <span class="sc">!!</span><span class="fu">str_c</span>(vars[i], <span class="st">&#39;_nn&#39;</span>) <span class="sc">:</span><span class="er">=</span> <span class="fu">apply</span>(nni, <span class="at">MARGIN =</span> <span class="dv">1</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb20-58"><a href="imputation.html#cb20-58" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">mean</span>(dat_nn[x, i])</span>
<span id="cb20-59"><a href="imputation.html#cb20-59" aria-hidden="true" tabindex="-1"></a>                         }))</span>
<span id="cb20-60"><a href="imputation.html#cb20-60" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb20-61"><a href="imputation.html#cb20-61" aria-hidden="true" tabindex="-1"></a>        nn_tab <span class="sc">%&lt;&gt;%</span> <span class="fu">mutate</span>(<span class="sc">!!</span>vars[i] <span class="sc">:</span><span class="er">=</span> dat_nn[,i],</span>
<span id="cb20-62"><a href="imputation.html#cb20-62" aria-hidden="true" tabindex="-1"></a>                           <span class="sc">!!</span><span class="fu">str_c</span>(vars[i], <span class="st">&#39;_nn&#39;</span>) <span class="sc">:</span><span class="er">=</span> <span class="fu">apply</span>(nni, <span class="at">MARGIN =</span> <span class="dv">1</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb20-63"><a href="imputation.html#cb20-63" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">mean</span>(dat_nn[x, i])</span>
<span id="cb20-64"><a href="imputation.html#cb20-64" aria-hidden="true" tabindex="-1"></a>                           }))</span>
<span id="cb20-65"><a href="imputation.html#cb20-65" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb20-66"><a href="imputation.html#cb20-66" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-67"><a href="imputation.html#cb20-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-68"><a href="imputation.html#cb20-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add target vars to tibble</span></span>
<span id="cb20-69"><a href="imputation.html#cb20-69" aria-hidden="true" tabindex="-1"></a>    nn_tab <span class="sc">%&lt;&gt;%</span> <span class="fu">mutate</span>(<span class="at">age =</span> dat<span class="sc">$</span>AGE2018,</span>
<span id="cb20-70"><a href="imputation.html#cb20-70" aria-hidden="true" tabindex="-1"></a>                       <span class="at">sp1 =</span> dat<span class="sc">$</span>SP1,</span>
<span id="cb20-71"><a href="imputation.html#cb20-71" aria-hidden="true" tabindex="-1"></a>                       <span class="at">sp2 =</span> dat<span class="sc">$</span>SP2,</span>
<span id="cb20-72"><a href="imputation.html#cb20-72" aria-hidden="true" tabindex="-1"></a>                       <span class="at">class5 =</span> dat<span class="sc">$</span>class5,</span>
<span id="cb20-73"><a href="imputation.html#cb20-73" aria-hidden="true" tabindex="-1"></a>                       <span class="at">class3 =</span> dat<span class="sc">$</span>class3,</span>
<span id="cb20-74"><a href="imputation.html#cb20-74" aria-hidden="true" tabindex="-1"></a>                       <span class="at">age_nn =</span> <span class="fu">apply</span>(nni, <span class="at">MARGIN =</span> <span class="dv">1</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb20-75"><a href="imputation.html#cb20-75" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">mean</span>(dat<span class="sc">$</span>AGE2018[x])</span>
<span id="cb20-76"><a href="imputation.html#cb20-76" aria-hidden="true" tabindex="-1"></a>                       }),</span>
<span id="cb20-77"><a href="imputation.html#cb20-77" aria-hidden="true" tabindex="-1"></a>                       <span class="at">sp1_nn =</span> <span class="fu">apply</span>(nni, <span class="at">MARGIN =</span> <span class="dv">1</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb20-78"><a href="imputation.html#cb20-78" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">getmode</span>(dat<span class="sc">$</span>SP1[x])</span>
<span id="cb20-79"><a href="imputation.html#cb20-79" aria-hidden="true" tabindex="-1"></a>                       }),</span>
<span id="cb20-80"><a href="imputation.html#cb20-80" aria-hidden="true" tabindex="-1"></a>                       <span class="at">sp2_nn =</span> <span class="fu">apply</span>(nni, <span class="at">MARGIN =</span> <span class="dv">1</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb20-81"><a href="imputation.html#cb20-81" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">getmode</span>(dat<span class="sc">$</span>SP2[x])</span>
<span id="cb20-82"><a href="imputation.html#cb20-82" aria-hidden="true" tabindex="-1"></a>                       }),</span>
<span id="cb20-83"><a href="imputation.html#cb20-83" aria-hidden="true" tabindex="-1"></a>                       <span class="at">class5_nn =</span> <span class="fu">apply</span>(nni, <span class="at">MARGIN =</span> <span class="dv">1</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb20-84"><a href="imputation.html#cb20-84" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">getmode</span>(dat<span class="sc">$</span>class5[x])</span>
<span id="cb20-85"><a href="imputation.html#cb20-85" aria-hidden="true" tabindex="-1"></a>                       }),</span>
<span id="cb20-86"><a href="imputation.html#cb20-86" aria-hidden="true" tabindex="-1"></a>                       <span class="at">class3_nn =</span> <span class="fu">apply</span>(nni, <span class="at">MARGIN =</span> <span class="dv">1</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb20-87"><a href="imputation.html#cb20-87" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">getmode</span>(dat<span class="sc">$</span>class3[x])</span>
<span id="cb20-88"><a href="imputation.html#cb20-88" aria-hidden="true" tabindex="-1"></a>                       }))</span>
<span id="cb20-89"><a href="imputation.html#cb20-89" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-90"><a href="imputation.html#cb20-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-91"><a href="imputation.html#cb20-91" aria-hidden="true" tabindex="-1"></a>  <span class="co"># take direct nn if k == 1</span></span>
<span id="cb20-92"><a href="imputation.html#cb20-92" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(k <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb20-93"><a href="imputation.html#cb20-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(vars)){</span>
<span id="cb20-94"><a href="imputation.html#cb20-94" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb20-95"><a href="imputation.html#cb20-95" aria-hidden="true" tabindex="-1"></a>        nn_tab <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="sc">!!</span>vars[i] <span class="sc">:</span><span class="er">=</span> dat_nn[,i],</span>
<span id="cb20-96"><a href="imputation.html#cb20-96" aria-hidden="true" tabindex="-1"></a>                         <span class="sc">!!</span><span class="fu">str_c</span>(vars[i], <span class="st">&#39;_nn&#39;</span>) <span class="sc">:</span><span class="er">=</span> dat_nn[nn[[<span class="dv">1</span>]][,<span class="dv">2</span>],i])</span>
<span id="cb20-97"><a href="imputation.html#cb20-97" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb20-98"><a href="imputation.html#cb20-98" aria-hidden="true" tabindex="-1"></a>        nn_tab <span class="sc">%&lt;&gt;%</span> <span class="fu">mutate</span>(<span class="sc">!!</span>vars[i] <span class="sc">:</span><span class="er">=</span> dat_nn[,i],</span>
<span id="cb20-99"><a href="imputation.html#cb20-99" aria-hidden="true" tabindex="-1"></a>                           <span class="sc">!!</span><span class="fu">str_c</span>(vars[i], <span class="st">&#39;_nn&#39;</span>) <span class="sc">:</span><span class="er">=</span> dat_nn[nn[[<span class="dv">1</span>]][,<span class="dv">2</span>],i])</span>
<span id="cb20-100"><a href="imputation.html#cb20-100" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb20-101"><a href="imputation.html#cb20-101" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-102"><a href="imputation.html#cb20-102" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-103"><a href="imputation.html#cb20-103" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add target vars to tibble</span></span>
<span id="cb20-104"><a href="imputation.html#cb20-104" aria-hidden="true" tabindex="-1"></a>    nn_tab <span class="sc">%&lt;&gt;%</span> <span class="fu">mutate</span>(<span class="at">age =</span> dat<span class="sc">$</span>AGE2018,</span>
<span id="cb20-105"><a href="imputation.html#cb20-105" aria-hidden="true" tabindex="-1"></a>                       <span class="at">sp1 =</span> dat<span class="sc">$</span>SP1,</span>
<span id="cb20-106"><a href="imputation.html#cb20-106" aria-hidden="true" tabindex="-1"></a>                       <span class="at">sp2 =</span> dat<span class="sc">$</span>SP2,</span>
<span id="cb20-107"><a href="imputation.html#cb20-107" aria-hidden="true" tabindex="-1"></a>                       <span class="at">class5 =</span> dat<span class="sc">$</span>class5,</span>
<span id="cb20-108"><a href="imputation.html#cb20-108" aria-hidden="true" tabindex="-1"></a>                       <span class="at">class3 =</span> dat<span class="sc">$</span>class3,</span>
<span id="cb20-109"><a href="imputation.html#cb20-109" aria-hidden="true" tabindex="-1"></a>                       <span class="at">age_nn =</span> dat<span class="sc">$</span>AGE2018[nn[[<span class="dv">1</span>]][,<span class="dv">2</span>]],</span>
<span id="cb20-110"><a href="imputation.html#cb20-110" aria-hidden="true" tabindex="-1"></a>                       <span class="at">sp1_nn =</span> dat<span class="sc">$</span>SP1[nn[[<span class="dv">1</span>]][,<span class="dv">2</span>]],</span>
<span id="cb20-111"><a href="imputation.html#cb20-111" aria-hidden="true" tabindex="-1"></a>                       <span class="at">sp2_nn =</span> dat<span class="sc">$</span>SP2[nn[[<span class="dv">1</span>]][,<span class="dv">2</span>]],</span>
<span id="cb20-112"><a href="imputation.html#cb20-112" aria-hidden="true" tabindex="-1"></a>                       <span class="at">class5_nn =</span> dat<span class="sc">$</span>class5[nn[[<span class="dv">1</span>]][,<span class="dv">2</span>]],</span>
<span id="cb20-113"><a href="imputation.html#cb20-113" aria-hidden="true" tabindex="-1"></a>                       <span class="at">class3_nn =</span> dat<span class="sc">$</span>class3[nn[[<span class="dv">1</span>]][,<span class="dv">2</span>]])</span>
<span id="cb20-114"><a href="imputation.html#cb20-114" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-115"><a href="imputation.html#cb20-115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-116"><a href="imputation.html#cb20-116" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-117"><a href="imputation.html#cb20-117" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate fit metrics for vars</span></span>
<span id="cb20-118"><a href="imputation.html#cb20-118" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(vars)){</span>
<span id="cb20-119"><a href="imputation.html#cb20-119" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb20-120"><a href="imputation.html#cb20-120" aria-hidden="true" tabindex="-1"></a>      perform_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">variable =</span> vars[i],</span>
<span id="cb20-121"><a href="imputation.html#cb20-121" aria-hidden="true" tabindex="-1"></a>                           <span class="at">metric =</span> <span class="fu">c</span>(<span class="st">&#39;rrmsd (%)&#39;</span>, <span class="st">&#39;rmbe (%)&#39;</span>),</span>
<span id="cb20-122"><a href="imputation.html#cb20-122" aria-hidden="true" tabindex="-1"></a>                           <span class="at">value =</span> <span class="fu">c</span>(<span class="fu">rrmsd</span>(<span class="fu">pull</span>(nn_tab, vars[i]),</span>
<span id="cb20-123"><a href="imputation.html#cb20-123" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">pull</span>(nn_tab, <span class="fu">str_c</span>(vars[i], <span class="st">&#39;_nn&#39;</span>))),</span>
<span id="cb20-124"><a href="imputation.html#cb20-124" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">rmbe</span>(<span class="fu">pull</span>(nn_tab, vars[i]),</span>
<span id="cb20-125"><a href="imputation.html#cb20-125" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">pull</span>(nn_tab, <span class="fu">str_c</span>(vars[i], <span class="st">&#39;_nn&#39;</span>)))))</span>
<span id="cb20-126"><a href="imputation.html#cb20-126" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb20-127"><a href="imputation.html#cb20-127" aria-hidden="true" tabindex="-1"></a>      perform_df <span class="sc">%&lt;&gt;%</span> <span class="fu">add_row</span>(<span class="at">variable =</span> vars[i],</span>
<span id="cb20-128"><a href="imputation.html#cb20-128" aria-hidden="true" tabindex="-1"></a>                           <span class="at">metric =</span> <span class="fu">c</span>(<span class="st">&#39;rrmsd (%)&#39;</span>, <span class="st">&#39;rmbe (%)&#39;</span>),</span>
<span id="cb20-129"><a href="imputation.html#cb20-129" aria-hidden="true" tabindex="-1"></a>                           <span class="at">value =</span> <span class="fu">c</span>(<span class="fu">rrmsd</span>(<span class="fu">pull</span>(nn_tab, vars[i]),</span>
<span id="cb20-130"><a href="imputation.html#cb20-130" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">pull</span>(nn_tab, <span class="fu">str_c</span>(vars[i], <span class="st">&#39;_nn&#39;</span>))),</span>
<span id="cb20-131"><a href="imputation.html#cb20-131" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">rmbe</span>(<span class="fu">pull</span>(nn_tab, vars[i]),</span>
<span id="cb20-132"><a href="imputation.html#cb20-132" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">pull</span>(nn_tab, <span class="fu">str_c</span>(vars[i], <span class="st">&#39;_nn&#39;</span>)))))</span>
<span id="cb20-133"><a href="imputation.html#cb20-133" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-134"><a href="imputation.html#cb20-134" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-135"><a href="imputation.html#cb20-135" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-136"><a href="imputation.html#cb20-136" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate metrics for age</span></span>
<span id="cb20-137"><a href="imputation.html#cb20-137" aria-hidden="true" tabindex="-1"></a>  perform_df <span class="sc">%&lt;&gt;%</span> <span class="fu">add_row</span>(<span class="at">variable =</span> <span class="st">&#39;age&#39;</span>,</span>
<span id="cb20-138"><a href="imputation.html#cb20-138" aria-hidden="true" tabindex="-1"></a>                          <span class="at">metric =</span> <span class="fu">c</span>(<span class="st">&#39;rmsd (yrs)&#39;</span>, <span class="st">&#39;mbe (yrs)&#39;</span>, <span class="st">&#39;mae (yrs)&#39;</span>),</span>
<span id="cb20-139"><a href="imputation.html#cb20-139" aria-hidden="true" tabindex="-1"></a>                          <span class="at">value =</span> <span class="fu">c</span>(<span class="fu">rmsd</span>(nn_tab<span class="sc">$</span>age, nn_tab<span class="sc">$</span>age_nn),</span>
<span id="cb20-140"><a href="imputation.html#cb20-140" aria-hidden="true" tabindex="-1"></a>                                    <span class="fu">mbe</span>(nn_tab<span class="sc">$</span>age, nn_tab<span class="sc">$</span>age_nn),</span>
<span id="cb20-141"><a href="imputation.html#cb20-141" aria-hidden="true" tabindex="-1"></a>                                    <span class="fu">mae</span>(nn_tab<span class="sc">$</span>age, nn_tab<span class="sc">$</span>age_nn)))</span>
<span id="cb20-142"><a href="imputation.html#cb20-142" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-143"><a href="imputation.html#cb20-143" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate SP1 accuracy</span></span>
<span id="cb20-144"><a href="imputation.html#cb20-144" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create df of SP1</span></span>
<span id="cb20-145"><a href="imputation.html#cb20-145" aria-hidden="true" tabindex="-1"></a>  sp1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">obs =</span> nn_tab<span class="sc">$</span>sp1,</span>
<span id="cb20-146"><a href="imputation.html#cb20-146" aria-hidden="true" tabindex="-1"></a>                    <span class="at">est =</span> nn_tab<span class="sc">$</span>sp1_nn)</span>
<span id="cb20-147"><a href="imputation.html#cb20-147" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-148"><a href="imputation.html#cb20-148" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create column of match or not</span></span>
<span id="cb20-149"><a href="imputation.html#cb20-149" aria-hidden="true" tabindex="-1"></a>  sp1<span class="sc">$</span>match <span class="ot">&lt;-</span> sp1<span class="sc">$</span>obs <span class="sc">==</span> sp1<span class="sc">$</span>est</span>
<span id="cb20-150"><a href="imputation.html#cb20-150" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-151"><a href="imputation.html#cb20-151" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add total percent of matching SP1 to perform_df</span></span>
<span id="cb20-152"><a href="imputation.html#cb20-152" aria-hidden="true" tabindex="-1"></a>  perform_df <span class="sc">%&lt;&gt;%</span> <span class="fu">add_row</span>(<span class="at">variable =</span> <span class="st">&#39;leading species&#39;</span>,</span>
<span id="cb20-153"><a href="imputation.html#cb20-153" aria-hidden="true" tabindex="-1"></a>                          <span class="at">metric =</span> <span class="st">&#39;accuracy (%)&#39;</span>,</span>
<span id="cb20-154"><a href="imputation.html#cb20-154" aria-hidden="true" tabindex="-1"></a>                          <span class="at">value =</span> <span class="fu">NROW</span>(sp1[sp1<span class="sc">$</span>match <span class="sc">==</span> T,]) <span class="sc">/</span></span>
<span id="cb20-155"><a href="imputation.html#cb20-155" aria-hidden="true" tabindex="-1"></a>                                   <span class="fu">NROW</span>(sp1) <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb20-156"><a href="imputation.html#cb20-156" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-157"><a href="imputation.html#cb20-157" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate SP2 accuracy</span></span>
<span id="cb20-158"><a href="imputation.html#cb20-158" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create df of SP2</span></span>
<span id="cb20-159"><a href="imputation.html#cb20-159" aria-hidden="true" tabindex="-1"></a>  sp2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">obs =</span> nn_tab<span class="sc">$</span>sp2,</span>
<span id="cb20-160"><a href="imputation.html#cb20-160" aria-hidden="true" tabindex="-1"></a>                    <span class="at">est =</span> nn_tab<span class="sc">$</span>sp2_nn)</span>
<span id="cb20-161"><a href="imputation.html#cb20-161" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-162"><a href="imputation.html#cb20-162" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create column of match or not</span></span>
<span id="cb20-163"><a href="imputation.html#cb20-163" aria-hidden="true" tabindex="-1"></a>  sp2<span class="sc">$</span>match <span class="ot">&lt;-</span> sp2<span class="sc">$</span>obs <span class="sc">==</span> sp2<span class="sc">$</span>est</span>
<span id="cb20-164"><a href="imputation.html#cb20-164" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-165"><a href="imputation.html#cb20-165" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add total percent of matching SP2 to perform_df</span></span>
<span id="cb20-166"><a href="imputation.html#cb20-166" aria-hidden="true" tabindex="-1"></a>  perform_df <span class="sc">%&lt;&gt;%</span> <span class="fu">add_row</span>(<span class="at">variable =</span> <span class="st">&#39;second species&#39;</span>, </span>
<span id="cb20-167"><a href="imputation.html#cb20-167" aria-hidden="true" tabindex="-1"></a>                        <span class="at">metric =</span> <span class="st">&#39;accuracy (%)&#39;</span>,</span>
<span id="cb20-168"><a href="imputation.html#cb20-168" aria-hidden="true" tabindex="-1"></a>                        <span class="at">value =</span> <span class="fu">NROW</span>(sp2[sp2<span class="sc">$</span>match <span class="sc">==</span> T,]) <span class="sc">/</span></span>
<span id="cb20-169"><a href="imputation.html#cb20-169" aria-hidden="true" tabindex="-1"></a>                                   <span class="fu">NROW</span>(sp2) <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb20-170"><a href="imputation.html#cb20-170" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-171"><a href="imputation.html#cb20-171" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate  class3 accuracy</span></span>
<span id="cb20-172"><a href="imputation.html#cb20-172" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create df of class3</span></span>
<span id="cb20-173"><a href="imputation.html#cb20-173" aria-hidden="true" tabindex="-1"></a>  class3 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">obs =</span> nn_tab<span class="sc">$</span>class3,</span>
<span id="cb20-174"><a href="imputation.html#cb20-174" aria-hidden="true" tabindex="-1"></a>                       <span class="at">est =</span> nn_tab<span class="sc">$</span>class3_nn)</span>
<span id="cb20-175"><a href="imputation.html#cb20-175" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-176"><a href="imputation.html#cb20-176" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create column of match or not</span></span>
<span id="cb20-177"><a href="imputation.html#cb20-177" aria-hidden="true" tabindex="-1"></a>  class3<span class="sc">$</span>match <span class="ot">&lt;-</span> class3<span class="sc">$</span>obs <span class="sc">==</span> class3<span class="sc">$</span>est</span>
<span id="cb20-178"><a href="imputation.html#cb20-178" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-179"><a href="imputation.html#cb20-179" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add total percent of matching class3 to perform_df</span></span>
<span id="cb20-180"><a href="imputation.html#cb20-180" aria-hidden="true" tabindex="-1"></a>  perform_df <span class="sc">%&lt;&gt;%</span> <span class="fu">add_row</span>(<span class="at">variable =</span> <span class="st">&#39;three func group class&#39;</span>,</span>
<span id="cb20-181"><a href="imputation.html#cb20-181" aria-hidden="true" tabindex="-1"></a>                          <span class="at">metric =</span> <span class="st">&#39;accuracy (%)&#39;</span>,</span>
<span id="cb20-182"><a href="imputation.html#cb20-182" aria-hidden="true" tabindex="-1"></a>                          <span class="at">value =</span> <span class="fu">NROW</span>(class3[class3<span class="sc">$</span>match <span class="sc">==</span> T,]) <span class="sc">/</span></span>
<span id="cb20-183"><a href="imputation.html#cb20-183" aria-hidden="true" tabindex="-1"></a>                                   <span class="fu">NROW</span>(class3) <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb20-184"><a href="imputation.html#cb20-184" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-185"><a href="imputation.html#cb20-185" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate class5 accuracy</span></span>
<span id="cb20-186"><a href="imputation.html#cb20-186" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create df of class5</span></span>
<span id="cb20-187"><a href="imputation.html#cb20-187" aria-hidden="true" tabindex="-1"></a>  class5 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">obs =</span> nn_tab<span class="sc">$</span>class5,</span>
<span id="cb20-188"><a href="imputation.html#cb20-188" aria-hidden="true" tabindex="-1"></a>                       <span class="at">est =</span> nn_tab<span class="sc">$</span>class5_nn)</span>
<span id="cb20-189"><a href="imputation.html#cb20-189" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-190"><a href="imputation.html#cb20-190" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create column of match or not</span></span>
<span id="cb20-191"><a href="imputation.html#cb20-191" aria-hidden="true" tabindex="-1"></a>  class5<span class="sc">$</span>match <span class="ot">&lt;-</span> class5<span class="sc">$</span>obs <span class="sc">==</span> class5<span class="sc">$</span>est</span>
<span id="cb20-192"><a href="imputation.html#cb20-192" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-193"><a href="imputation.html#cb20-193" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add total percent of matching class5 to perform_df</span></span>
<span id="cb20-194"><a href="imputation.html#cb20-194" aria-hidden="true" tabindex="-1"></a>  perform_df <span class="sc">%&lt;&gt;%</span> <span class="fu">add_row</span>(<span class="at">variable =</span> <span class="st">&#39;five func group class&#39;</span>,</span>
<span id="cb20-195"><a href="imputation.html#cb20-195" aria-hidden="true" tabindex="-1"></a>                        <span class="at">metric =</span> <span class="st">&#39;accuracy (%)&#39;</span>,</span>
<span id="cb20-196"><a href="imputation.html#cb20-196" aria-hidden="true" tabindex="-1"></a>                        <span class="at">value =</span> <span class="fu">NROW</span>(class5[class5<span class="sc">$</span>match <span class="sc">==</span> T,]) <span class="sc">/</span></span>
<span id="cb20-197"><a href="imputation.html#cb20-197" aria-hidden="true" tabindex="-1"></a>                                   <span class="fu">NROW</span>(class5) <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb20-198"><a href="imputation.html#cb20-198" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-199"><a href="imputation.html#cb20-199" aria-hidden="true" tabindex="-1"></a>  <span class="co"># return df</span></span>
<span id="cb20-200"><a href="imputation.html#cb20-200" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(perform_df)</span>
<span id="cb20-201"><a href="imputation.html#cb20-201" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-202"><a href="imputation.html#cb20-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-203"><a href="imputation.html#cb20-203" aria-hidden="true" tabindex="-1"></a><span class="co"># create knn function to output imputed vs. observed table</span></span>
<span id="cb20-204"><a href="imputation.html#cb20-204" aria-hidden="true" tabindex="-1"></a>run_knn_fri_table <span class="ot">&lt;-</span> <span class="cf">function</span>(dat, vars, k) {</span>
<span id="cb20-205"><a href="imputation.html#cb20-205" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-206"><a href="imputation.html#cb20-206" aria-hidden="true" tabindex="-1"></a>  <span class="co"># subset data</span></span>
<span id="cb20-207"><a href="imputation.html#cb20-207" aria-hidden="true" tabindex="-1"></a>  dat_nn <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">all_of</span>(vars))</span>
<span id="cb20-208"><a href="imputation.html#cb20-208" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-209"><a href="imputation.html#cb20-209" aria-hidden="true" tabindex="-1"></a>  <span class="co"># scale for nn computation</span></span>
<span id="cb20-210"><a href="imputation.html#cb20-210" aria-hidden="true" tabindex="-1"></a>  dat_nn_scaled <span class="ot">&lt;-</span> dat_nn <span class="sc">%&gt;%</span> scale</span>
<span id="cb20-211"><a href="imputation.html#cb20-211" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-212"><a href="imputation.html#cb20-212" aria-hidden="true" tabindex="-1"></a>  <span class="co"># run nearest neighbor</span></span>
<span id="cb20-213"><a href="imputation.html#cb20-213" aria-hidden="true" tabindex="-1"></a>  nn <span class="ot">&lt;-</span> <span class="fu">nn2</span>(dat_nn_scaled, dat_nn_scaled, <span class="at">k =</span> k <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb20-214"><a href="imputation.html#cb20-214" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-215"><a href="imputation.html#cb20-215" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get nn indices</span></span>
<span id="cb20-216"><a href="imputation.html#cb20-216" aria-hidden="true" tabindex="-1"></a>  nni <span class="ot">&lt;-</span> nn[[<span class="dv">1</span>]][, <span class="dv">2</span><span class="sc">:</span>(k <span class="sc">+</span> <span class="dv">1</span>)]</span>
<span id="cb20-217"><a href="imputation.html#cb20-217" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-218"><a href="imputation.html#cb20-218" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add vars to tibble</span></span>
<span id="cb20-219"><a href="imputation.html#cb20-219" aria-hidden="true" tabindex="-1"></a>  <span class="co"># take mean/mode if k &gt; 1</span></span>
<span id="cb20-220"><a href="imputation.html#cb20-220" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(k <span class="sc">&gt;</span> <span class="dv">1</span>){</span>
<span id="cb20-221"><a href="imputation.html#cb20-221" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(vars)){</span>
<span id="cb20-222"><a href="imputation.html#cb20-222" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb20-223"><a href="imputation.html#cb20-223" aria-hidden="true" tabindex="-1"></a>        nn_tab <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="sc">!!</span>vars[i] <span class="sc">:</span><span class="er">=</span> dat_nn[,i],</span>
<span id="cb20-224"><a href="imputation.html#cb20-224" aria-hidden="true" tabindex="-1"></a>                         <span class="sc">!!</span><span class="fu">str_c</span>(vars[i], <span class="st">&#39;_nn&#39;</span>) <span class="sc">:</span><span class="er">=</span> <span class="fu">apply</span>(nni, <span class="at">MARGIN =</span> <span class="dv">1</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb20-225"><a href="imputation.html#cb20-225" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">mean</span>(dat_nn[x, i])</span>
<span id="cb20-226"><a href="imputation.html#cb20-226" aria-hidden="true" tabindex="-1"></a>                         }))</span>
<span id="cb20-227"><a href="imputation.html#cb20-227" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb20-228"><a href="imputation.html#cb20-228" aria-hidden="true" tabindex="-1"></a>        nn_tab <span class="sc">%&lt;&gt;%</span> <span class="fu">mutate</span>(<span class="sc">!!</span>vars[i] <span class="sc">:</span><span class="er">=</span> dat_nn[,i],</span>
<span id="cb20-229"><a href="imputation.html#cb20-229" aria-hidden="true" tabindex="-1"></a>                           <span class="sc">!!</span><span class="fu">str_c</span>(vars[i], <span class="st">&#39;_nn&#39;</span>) <span class="sc">:</span><span class="er">=</span> <span class="fu">apply</span>(nni, <span class="at">MARGIN =</span> <span class="dv">1</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb20-230"><a href="imputation.html#cb20-230" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">mean</span>(dat_nn[x, i])</span>
<span id="cb20-231"><a href="imputation.html#cb20-231" aria-hidden="true" tabindex="-1"></a>                           }))</span>
<span id="cb20-232"><a href="imputation.html#cb20-232" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb20-233"><a href="imputation.html#cb20-233" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-234"><a href="imputation.html#cb20-234" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-235"><a href="imputation.html#cb20-235" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add target vars to tibble</span></span>
<span id="cb20-236"><a href="imputation.html#cb20-236" aria-hidden="true" tabindex="-1"></a>    nn_tab <span class="sc">%&lt;&gt;%</span> <span class="fu">mutate</span>(<span class="at">age =</span> dat<span class="sc">$</span>AGE2018,</span>
<span id="cb20-237"><a href="imputation.html#cb20-237" aria-hidden="true" tabindex="-1"></a>                       <span class="at">sp1 =</span> dat<span class="sc">$</span>SP1,</span>
<span id="cb20-238"><a href="imputation.html#cb20-238" aria-hidden="true" tabindex="-1"></a>                       <span class="at">sp2 =</span> dat<span class="sc">$</span>SP2,</span>
<span id="cb20-239"><a href="imputation.html#cb20-239" aria-hidden="true" tabindex="-1"></a>                       <span class="at">class5 =</span> dat<span class="sc">$</span>class5,</span>
<span id="cb20-240"><a href="imputation.html#cb20-240" aria-hidden="true" tabindex="-1"></a>                       <span class="at">class3 =</span> dat<span class="sc">$</span>class3,</span>
<span id="cb20-241"><a href="imputation.html#cb20-241" aria-hidden="true" tabindex="-1"></a>                       <span class="at">age_nn =</span> <span class="fu">apply</span>(nni, <span class="at">MARGIN =</span> <span class="dv">1</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb20-242"><a href="imputation.html#cb20-242" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">mean</span>(dat<span class="sc">$</span>AGE2018[x])</span>
<span id="cb20-243"><a href="imputation.html#cb20-243" aria-hidden="true" tabindex="-1"></a>                       }),</span>
<span id="cb20-244"><a href="imputation.html#cb20-244" aria-hidden="true" tabindex="-1"></a>                       <span class="at">sp1_nn =</span> <span class="fu">apply</span>(nni, <span class="at">MARGIN =</span> <span class="dv">1</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb20-245"><a href="imputation.html#cb20-245" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">getmode</span>(dat<span class="sc">$</span>SP1[x])</span>
<span id="cb20-246"><a href="imputation.html#cb20-246" aria-hidden="true" tabindex="-1"></a>                       }),</span>
<span id="cb20-247"><a href="imputation.html#cb20-247" aria-hidden="true" tabindex="-1"></a>                       <span class="at">sp2_nn =</span> <span class="fu">apply</span>(nni, <span class="at">MARGIN =</span> <span class="dv">1</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb20-248"><a href="imputation.html#cb20-248" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">getmode</span>(dat<span class="sc">$</span>SP2[x])</span>
<span id="cb20-249"><a href="imputation.html#cb20-249" aria-hidden="true" tabindex="-1"></a>                       }),</span>
<span id="cb20-250"><a href="imputation.html#cb20-250" aria-hidden="true" tabindex="-1"></a>                       <span class="at">class5_nn =</span> <span class="fu">apply</span>(nni, <span class="at">MARGIN =</span> <span class="dv">1</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb20-251"><a href="imputation.html#cb20-251" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">getmode</span>(dat<span class="sc">$</span>class5[x])</span>
<span id="cb20-252"><a href="imputation.html#cb20-252" aria-hidden="true" tabindex="-1"></a>                       }),</span>
<span id="cb20-253"><a href="imputation.html#cb20-253" aria-hidden="true" tabindex="-1"></a>                       <span class="at">class3_nn =</span> <span class="fu">apply</span>(nni, <span class="at">MARGIN =</span> <span class="dv">1</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb20-254"><a href="imputation.html#cb20-254" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">getmode</span>(dat<span class="sc">$</span>class3[x])</span>
<span id="cb20-255"><a href="imputation.html#cb20-255" aria-hidden="true" tabindex="-1"></a>                       }))</span>
<span id="cb20-256"><a href="imputation.html#cb20-256" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-257"><a href="imputation.html#cb20-257" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-258"><a href="imputation.html#cb20-258" aria-hidden="true" tabindex="-1"></a>  <span class="co"># take direct nn if k == 1</span></span>
<span id="cb20-259"><a href="imputation.html#cb20-259" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(k <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb20-260"><a href="imputation.html#cb20-260" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(vars)){</span>
<span id="cb20-261"><a href="imputation.html#cb20-261" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb20-262"><a href="imputation.html#cb20-262" aria-hidden="true" tabindex="-1"></a>        nn_tab <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="sc">!!</span>vars[i] <span class="sc">:</span><span class="er">=</span> dat_nn[,i],</span>
<span id="cb20-263"><a href="imputation.html#cb20-263" aria-hidden="true" tabindex="-1"></a>                         <span class="sc">!!</span><span class="fu">str_c</span>(vars[i], <span class="st">&#39;_nn&#39;</span>) <span class="sc">:</span><span class="er">=</span> dat_nn[nn[[<span class="dv">1</span>]][,<span class="dv">2</span>],i])</span>
<span id="cb20-264"><a href="imputation.html#cb20-264" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb20-265"><a href="imputation.html#cb20-265" aria-hidden="true" tabindex="-1"></a>        nn_tab <span class="sc">%&lt;&gt;%</span> <span class="fu">mutate</span>(<span class="sc">!!</span>vars[i] <span class="sc">:</span><span class="er">=</span> dat_nn[,i],</span>
<span id="cb20-266"><a href="imputation.html#cb20-266" aria-hidden="true" tabindex="-1"></a>                           <span class="sc">!!</span><span class="fu">str_c</span>(vars[i], <span class="st">&#39;_nn&#39;</span>) <span class="sc">:</span><span class="er">=</span> dat_nn[nn[[<span class="dv">1</span>]][,<span class="dv">2</span>],i])</span>
<span id="cb20-267"><a href="imputation.html#cb20-267" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb20-268"><a href="imputation.html#cb20-268" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-269"><a href="imputation.html#cb20-269" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-270"><a href="imputation.html#cb20-270" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add target vars to tibble</span></span>
<span id="cb20-271"><a href="imputation.html#cb20-271" aria-hidden="true" tabindex="-1"></a>    nn_tab <span class="sc">%&lt;&gt;%</span> <span class="fu">mutate</span>(<span class="at">age =</span> dat<span class="sc">$</span>AGE2018,</span>
<span id="cb20-272"><a href="imputation.html#cb20-272" aria-hidden="true" tabindex="-1"></a>                       <span class="at">sp1 =</span> dat<span class="sc">$</span>SP1,</span>
<span id="cb20-273"><a href="imputation.html#cb20-273" aria-hidden="true" tabindex="-1"></a>                       <span class="at">sp2 =</span> dat<span class="sc">$</span>SP2,</span>
<span id="cb20-274"><a href="imputation.html#cb20-274" aria-hidden="true" tabindex="-1"></a>                       <span class="at">class5 =</span> dat<span class="sc">$</span>class5,</span>
<span id="cb20-275"><a href="imputation.html#cb20-275" aria-hidden="true" tabindex="-1"></a>                       <span class="at">class3 =</span> dat<span class="sc">$</span>class3,</span>
<span id="cb20-276"><a href="imputation.html#cb20-276" aria-hidden="true" tabindex="-1"></a>                       <span class="at">age_nn =</span> dat<span class="sc">$</span>AGE2018[nn[[<span class="dv">1</span>]][,<span class="dv">2</span>]],</span>
<span id="cb20-277"><a href="imputation.html#cb20-277" aria-hidden="true" tabindex="-1"></a>                       <span class="at">sp1_nn =</span> dat<span class="sc">$</span>SP1[nn[[<span class="dv">1</span>]][,<span class="dv">2</span>]],</span>
<span id="cb20-278"><a href="imputation.html#cb20-278" aria-hidden="true" tabindex="-1"></a>                       <span class="at">sp2_nn =</span> dat<span class="sc">$</span>SP2[nn[[<span class="dv">1</span>]][,<span class="dv">2</span>]],</span>
<span id="cb20-279"><a href="imputation.html#cb20-279" aria-hidden="true" tabindex="-1"></a>                       <span class="at">class5_nn =</span> dat<span class="sc">$</span>class5[nn[[<span class="dv">1</span>]][,<span class="dv">2</span>]],</span>
<span id="cb20-280"><a href="imputation.html#cb20-280" aria-hidden="true" tabindex="-1"></a>                       <span class="at">class3_nn =</span> dat<span class="sc">$</span>class3[nn[[<span class="dv">1</span>]][,<span class="dv">2</span>]])</span>
<span id="cb20-281"><a href="imputation.html#cb20-281" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-282"><a href="imputation.html#cb20-282" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-283"><a href="imputation.html#cb20-283" aria-hidden="true" tabindex="-1"></a>  <span class="co"># return nn table</span></span>
<span id="cb20-284"><a href="imputation.html#cb20-284" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(nn_tab)</span>
<span id="cb20-285"><a href="imputation.html#cb20-285" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Then we run imputation on the FRI dataset using the functions defined above.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="imputation.html#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="do">########################################################</span></span>
<span id="cb21-2"><a href="imputation.html#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="do">### RUN KNN IMPUTATION USING OPTIMAL MODEL VARIABLES </span><span class="al">###</span></span>
<span id="cb21-3"><a href="imputation.html#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="do">########################################################</span></span>
<span id="cb21-4"><a href="imputation.html#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="imputation.html#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co"># load FRI screened polygons</span></span>
<span id="cb21-6"><a href="imputation.html#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="fu">str_c</span>(out_dir, <span class="st">&#39;/temp/dat_fri_scr.RData&#39;</span>))</span>
<span id="cb21-7"><a href="imputation.html#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="imputation.html#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co"># subset only the attributes we need from the screened FRI polygons</span></span>
<span id="cb21-9"><a href="imputation.html#cb21-9" aria-hidden="true" tabindex="-1"></a>dat_fri_scr <span class="sc">%&lt;&gt;%</span> <span class="fu">select</span>(POLYID, AGE2018, avg,</span>
<span id="cb21-10"><a href="imputation.html#cb21-10" aria-hidden="true" tabindex="-1"></a>                        rumple, pcum8, sd,</span>
<span id="cb21-11"><a href="imputation.html#cb21-11" aria-hidden="true" tabindex="-1"></a>                        b6, x, y, SP1, SP2, class3, class5)</span>
<span id="cb21-12"><a href="imputation.html#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="imputation.html#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="co"># remove any polygons with missing values</span></span>
<span id="cb21-14"><a href="imputation.html#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="co"># in imputation X-variables</span></span>
<span id="cb21-15"><a href="imputation.html#cb21-15" aria-hidden="true" tabindex="-1"></a>dat_fri_scr <span class="ot">&lt;-</span> <span class="fu">left_join</span>(dat_fri_scr <span class="sc">%&gt;%</span> <span class="fu">select</span>(POLYID, AGE2018, avg,</span>
<span id="cb21-16"><a href="imputation.html#cb21-16" aria-hidden="true" tabindex="-1"></a>                        rumple, pcum8, sd,</span>
<span id="cb21-17"><a href="imputation.html#cb21-17" aria-hidden="true" tabindex="-1"></a>                        b6, x, y) <span class="sc">%&gt;%</span> na.omit,</span>
<span id="cb21-18"><a href="imputation.html#cb21-18" aria-hidden="true" tabindex="-1"></a>                        dat_fri_scr)</span>
<span id="cb21-19"><a href="imputation.html#cb21-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-20"><a href="imputation.html#cb21-20" aria-hidden="true" tabindex="-1"></a><span class="co"># create vector of X-variables for imputation</span></span>
<span id="cb21-21"><a href="imputation.html#cb21-21" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;avg&#39;</span>, <span class="st">&#39;rumple&#39;</span>,</span>
<span id="cb21-22"><a href="imputation.html#cb21-22" aria-hidden="true" tabindex="-1"></a>          <span class="st">&#39;pcum8&#39;</span>, <span class="st">&#39;sd&#39;</span>,</span>
<span id="cb21-23"><a href="imputation.html#cb21-23" aria-hidden="true" tabindex="-1"></a>          <span class="st">&#39;b6&#39;</span>, <span class="st">&#39;x&#39;</span>, <span class="st">&#39;y&#39;</span>)</span>
<span id="cb21-24"><a href="imputation.html#cb21-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-25"><a href="imputation.html#cb21-25" aria-hidden="true" tabindex="-1"></a><span class="co"># run_knn_fri function to get performance results</span></span>
<span id="cb21-26"><a href="imputation.html#cb21-26" aria-hidden="true" tabindex="-1"></a>perf <span class="ot">&lt;-</span> <span class="fu">run_knn_fri</span>(dat_fri_scr, vars, <span class="at">k =</span> <span class="dv">5</span>)</span>
<span id="cb21-27"><a href="imputation.html#cb21-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-28"><a href="imputation.html#cb21-28" aria-hidden="true" tabindex="-1"></a><span class="co"># run_knn_fri function to get imputed vs. observed values</span></span>
<span id="cb21-29"><a href="imputation.html#cb21-29" aria-hidden="true" tabindex="-1"></a>nn_tab <span class="ot">&lt;-</span> <span class="fu">run_knn_fri_table</span>(dat_fri_scr, vars, <span class="at">k =</span> <span class="dv">5</span>)</span></code></pre></div>
</div>
<div id="imputation59" class="section level2 unnumbered hasAnchor">
<h2><strong>5.9</strong> Results: Imputation over FRI<a href="imputation.html#imputation59" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>For the imputation over FRI we don’t generate output polygons, just the performance metrics listed above so we can assess the performance of the imputation.</p>
<p>Having run the imputation function, we clean the output data and display results.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="imputation.html#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># round values</span></span>
<span id="cb22-2"><a href="imputation.html#cb22-2" aria-hidden="true" tabindex="-1"></a>perf <span class="sc">%&lt;&gt;%</span> <span class="fu">mutate</span>(<span class="at">value =</span> <span class="fu">round</span>(value, <span class="dv">2</span>))</span>
<span id="cb22-3"><a href="imputation.html#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="imputation.html#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"># factor variable and metric categories to order</span></span>
<span id="cb22-5"><a href="imputation.html#cb22-5" aria-hidden="true" tabindex="-1"></a>perf <span class="sc">%&lt;&gt;%</span> <span class="fu">mutate</span>(<span class="at">variable =</span> <span class="fu">factor</span>(variable, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&#39;age&#39;</span>, <span class="st">&#39;leading species&#39;</span>, </span>
<span id="cb22-6"><a href="imputation.html#cb22-6" aria-hidden="true" tabindex="-1"></a>                                                        <span class="st">&#39;second species&#39;</span>, <span class="st">&#39;three func group class&#39;</span>,</span>
<span id="cb22-7"><a href="imputation.html#cb22-7" aria-hidden="true" tabindex="-1"></a>                                                        <span class="st">&#39;five func group class&#39;</span>, vars))) <span class="sc">%&gt;%</span></span>
<span id="cb22-8"><a href="imputation.html#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">metric =</span> <span class="fu">factor</span>(metric, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&#39;rmsd (yrs)&#39;</span>, <span class="st">&#39;mbe (yrs)&#39;</span>, <span class="st">&#39;mae (yrs)&#39;</span>, <span class="st">&#39;accuracy (%)&#39;</span>, <span class="st">&#39;rrmsd (%)&#39;</span>, <span class="st">&#39;rmbe (%)&#39;</span>)))</span>
<span id="cb22-9"><a href="imputation.html#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="imputation.html#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="co"># cast df</span></span>
<span id="cb22-11"><a href="imputation.html#cb22-11" aria-hidden="true" tabindex="-1"></a>perf_cast <span class="ot">&lt;-</span> <span class="fu">dcast</span>(perf, variable <span class="sc">~</span> metric)</span>
<span id="cb22-12"><a href="imputation.html#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="imputation.html#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="co"># remove x and y</span></span>
<span id="cb22-14"><a href="imputation.html#cb22-14" aria-hidden="true" tabindex="-1"></a>perf_cast <span class="sc">%&lt;&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>(variable <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;x&#39;</span>, <span class="st">&#39;y&#39;</span>)))</span>
<span id="cb22-15"><a href="imputation.html#cb22-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-16"><a href="imputation.html#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="co"># set NA to blank</span></span>
<span id="cb22-17"><a href="imputation.html#cb22-17" aria-hidden="true" tabindex="-1"></a>perf_cast[<span class="fu">is.na</span>(perf_cast)] <span class="ot">&lt;-</span> <span class="st">&#39;&#39;</span></span>
<span id="cb22-18"><a href="imputation.html#cb22-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-19"><a href="imputation.html#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="co"># display results</span></span>
<span id="cb22-20"><a href="imputation.html#cb22-20" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(perf_cast, <span class="at">caption =</span> <span class="st">&quot;Imputation Performance of FRI Forest Stand Polygons&quot;</span>, <span class="at">label =</span> <span class="cn">NA</span>)</span></code></pre></div>
<table>
<caption>
Imputation Performance of FRI Forest Stand Polygons
</caption>
<thead>
<tr>
<th style="text-align:left;">
variable
</th>
<th style="text-align:left;">
rmsd (yrs)
</th>
<th style="text-align:left;">
mbe (yrs)
</th>
<th style="text-align:left;">
mae (yrs)
</th>
<th style="text-align:left;">
accuracy (%)
</th>
<th style="text-align:left;">
rrmsd (%)
</th>
<th style="text-align:left;">
rmbe (%)
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:left;">
23.31
</td>
<td style="text-align:left;">
-0.14
</td>
<td style="text-align:left;">
16.06
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
leading species
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
65.46
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
second species
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
37.62
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
three func group class
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
72.34
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
five func group class
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
60.73
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
avg
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
3.6
</td>
<td style="text-align:left;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
rumple
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
2.54
</td>
<td style="text-align:left;">
0.01
</td>
</tr>
<tr>
<td style="text-align:left;">
pcum8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
0.9
</td>
<td style="text-align:left;">
0.13
</td>
</tr>
<tr>
<td style="text-align:left;">
sd
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
3.88
</td>
<td style="text-align:left;">
-0.33
</td>
</tr>
<tr>
<td style="text-align:left;">
b6
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
2.15
</td>
<td style="text-align:left;">
-0.1
</td>
</tr>
</tbody>
</table>
<p>The mean bias error (MBE) of age is -0.14 years, indicating the imputed estimates of age are not skewed toward younger or older values. The mean absolute error (MAE) of age is 16.06 years, which is the average difference between the observed and imputed value.</p>
<p>Accuracy of leading species classification is 65.46%, and a much lower 37.62% for second leading species. Three and five functional group classification have respective accuracies of 72.34% and 60.73%.</p>
<p>Relative root mean squared difference (RRMSD) of the imputation attributes (avg, sd, rumple, zpcum8, and red_edge_2) is below 4% for all attributes. These are low values, which demonstrate that the imputation algorithm is finding optimal matches within the database of available FRI polygons.</p>
<p>Relative mean bias error (RMBE) of the imputation attributes is less than 1%, meaning that the nearest neighbor selections are not skewed toward positive or negative values of these attributes.</p>
<p>RRMSD/RMBE are not calculated for x and y because the coordinates do not represent a value scale.</p>
<p>We can also generate detailed confusion matrices of the imputed vs. observed species composition.</p>
<p>Three functional group classification:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="imputation.html#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate 3 func group confusion matrix</span></span>
<span id="cb23-2"><a href="imputation.html#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co"># build accuracy table</span></span>
<span id="cb23-3"><a href="imputation.html#cb23-3" aria-hidden="true" tabindex="-1"></a>accmat <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="st">&quot;pred&quot;</span> <span class="ot">=</span> nn_tab<span class="sc">$</span>class3_nn, <span class="st">&quot;ref&quot;</span> <span class="ot">=</span> nn_tab<span class="sc">$</span>class3)</span>
<span id="cb23-4"><a href="imputation.html#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="imputation.html#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co"># UA</span></span>
<span id="cb23-6"><a href="imputation.html#cb23-6" aria-hidden="true" tabindex="-1"></a>ua <span class="ot">&lt;-</span> <span class="fu">diag</span>(accmat) <span class="sc">/</span> <span class="fu">rowSums</span>(accmat) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb23-7"><a href="imputation.html#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="imputation.html#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co"># PA</span></span>
<span id="cb23-9"><a href="imputation.html#cb23-9" aria-hidden="true" tabindex="-1"></a>pa <span class="ot">&lt;-</span> <span class="fu">diag</span>(accmat) <span class="sc">/</span> <span class="fu">colSums</span>(accmat) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb23-10"><a href="imputation.html#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="imputation.html#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="co"># OA</span></span>
<span id="cb23-12"><a href="imputation.html#cb23-12" aria-hidden="true" tabindex="-1"></a>oa <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">diag</span>(accmat)) <span class="sc">/</span> <span class="fu">sum</span>(accmat) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb23-13"><a href="imputation.html#cb23-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-14"><a href="imputation.html#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="co"># build confusion matrix</span></span>
<span id="cb23-15"><a href="imputation.html#cb23-15" aria-hidden="true" tabindex="-1"></a>accmat_ext <span class="ot">&lt;-</span> <span class="fu">addmargins</span>(accmat)</span>
<span id="cb23-16"><a href="imputation.html#cb23-16" aria-hidden="true" tabindex="-1"></a>accmat_ext <span class="ot">&lt;-</span> <span class="fu">rbind</span>(accmat_ext, <span class="st">&quot;Users&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(pa, <span class="cn">NA</span>))</span>
<span id="cb23-17"><a href="imputation.html#cb23-17" aria-hidden="true" tabindex="-1"></a>accmat_ext <span class="ot">&lt;-</span> <span class="fu">cbind</span>(accmat_ext, <span class="st">&quot;Producers&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(ua, <span class="cn">NA</span>, oa))</span>
<span id="cb23-18"><a href="imputation.html#cb23-18" aria-hidden="true" tabindex="-1"></a>accmat_ext <span class="ot">&lt;-</span> <span class="fu">round</span>(accmat_ext, <span class="dv">2</span>)</span>
<span id="cb23-19"><a href="imputation.html#cb23-19" aria-hidden="true" tabindex="-1"></a><span class="fu">dimnames</span>(accmat_ext) <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">&quot;Imputed&quot;</span> <span class="ot">=</span> <span class="fu">colnames</span>(accmat_ext),</span>
<span id="cb23-20"><a href="imputation.html#cb23-20" aria-hidden="true" tabindex="-1"></a>                             <span class="st">&quot;Observed&quot;</span> <span class="ot">=</span> <span class="fu">rownames</span>(accmat_ext))</span>
<span id="cb23-21"><a href="imputation.html#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(accmat_ext) <span class="ot">&lt;-</span> <span class="st">&quot;table&quot;</span></span>
<span id="cb23-22"><a href="imputation.html#cb23-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-23"><a href="imputation.html#cb23-23" aria-hidden="true" tabindex="-1"></a><span class="co"># display results</span></span>
<span id="cb23-24"><a href="imputation.html#cb23-24" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(accmat_ext <span class="sc">%&gt;%</span> round, <span class="at">caption =</span> <span class="st">&quot;Confusion matrix of imputed vs. observed three functional group classification over FRI polygons. Rows are imputed values and columns are observed values.&quot;</span>, <span class="at">label =</span> <span class="cn">NA</span>)</span></code></pre></div>
<table>
<caption>
Confusion matrix of imputed vs. observed three functional group classification over FRI polygons. Rows are imputed values and columns are observed values.
</caption>
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:right;">
Hardwood
</th>
<th style="text-align:right;">
Mixedwood
</th>
<th style="text-align:right;">
Softwood
</th>
<th style="text-align:right;">
Sum
</th>
<th style="text-align:right;">
Users
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Hardwood
</td>
<td style="text-align:right;">
6651
</td>
<td style="text-align:right;">
2448
</td>
<td style="text-align:right;">
1044
</td>
<td style="text-align:right;">
10143
</td>
<td style="text-align:right;">
66
</td>
</tr>
<tr>
<td style="text-align:left;">
Mixedwood
</td>
<td style="text-align:right;">
2277
</td>
<td style="text-align:right;">
4426
</td>
<td style="text-align:right;">
2697
</td>
<td style="text-align:right;">
9400
</td>
<td style="text-align:right;">
47
</td>
</tr>
<tr>
<td style="text-align:left;">
Softwood
</td>
<td style="text-align:right;">
1397
</td>
<td style="text-align:right;">
4363
</td>
<td style="text-align:right;">
26134
</td>
<td style="text-align:right;">
31894
</td>
<td style="text-align:right;">
82
</td>
</tr>
<tr>
<td style="text-align:left;">
Sum
</td>
<td style="text-align:right;">
10325
</td>
<td style="text-align:right;">
11237
</td>
<td style="text-align:right;">
29875
</td>
<td style="text-align:right;">
51437
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:left;">
Producers
</td>
<td style="text-align:right;">
64
</td>
<td style="text-align:right;">
39
</td>
<td style="text-align:right;">
87
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
72
</td>
</tr>
</tbody>
</table>
<p>Five functional group classification:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="imputation.html#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate 5 func group confusion matrix</span></span>
<span id="cb24-2"><a href="imputation.html#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co"># build accuracy table</span></span>
<span id="cb24-3"><a href="imputation.html#cb24-3" aria-hidden="true" tabindex="-1"></a>accmat <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="st">&quot;pred&quot;</span> <span class="ot">=</span> nn_tab<span class="sc">$</span>class5_nn, <span class="st">&quot;ref&quot;</span> <span class="ot">=</span> nn_tab<span class="sc">$</span>class5)</span>
<span id="cb24-4"><a href="imputation.html#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="imputation.html#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co"># UA</span></span>
<span id="cb24-6"><a href="imputation.html#cb24-6" aria-hidden="true" tabindex="-1"></a>ua <span class="ot">&lt;-</span> <span class="fu">diag</span>(accmat) <span class="sc">/</span> <span class="fu">rowSums</span>(accmat) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb24-7"><a href="imputation.html#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="imputation.html#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="co"># PA</span></span>
<span id="cb24-9"><a href="imputation.html#cb24-9" aria-hidden="true" tabindex="-1"></a>pa <span class="ot">&lt;-</span> <span class="fu">diag</span>(accmat) <span class="sc">/</span> <span class="fu">colSums</span>(accmat) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb24-10"><a href="imputation.html#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="imputation.html#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="co"># OA</span></span>
<span id="cb24-12"><a href="imputation.html#cb24-12" aria-hidden="true" tabindex="-1"></a>oa <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">diag</span>(accmat)) <span class="sc">/</span> <span class="fu">sum</span>(accmat) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb24-13"><a href="imputation.html#cb24-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-14"><a href="imputation.html#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="co"># build confusion matrix</span></span>
<span id="cb24-15"><a href="imputation.html#cb24-15" aria-hidden="true" tabindex="-1"></a>accmat_ext <span class="ot">&lt;-</span> <span class="fu">addmargins</span>(accmat)</span>
<span id="cb24-16"><a href="imputation.html#cb24-16" aria-hidden="true" tabindex="-1"></a>accmat_ext <span class="ot">&lt;-</span> <span class="fu">rbind</span>(accmat_ext, <span class="st">&quot;Users&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(pa, <span class="cn">NA</span>))</span>
<span id="cb24-17"><a href="imputation.html#cb24-17" aria-hidden="true" tabindex="-1"></a>accmat_ext <span class="ot">&lt;-</span> <span class="fu">cbind</span>(accmat_ext, <span class="st">&quot;Producers&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(ua, <span class="cn">NA</span>, oa))</span>
<span id="cb24-18"><a href="imputation.html#cb24-18" aria-hidden="true" tabindex="-1"></a>accmat_ext <span class="ot">&lt;-</span> <span class="fu">round</span>(accmat_ext, <span class="dv">2</span>)</span>
<span id="cb24-19"><a href="imputation.html#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="fu">dimnames</span>(accmat_ext) <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">&quot;Imputed&quot;</span> <span class="ot">=</span> <span class="fu">colnames</span>(accmat_ext),</span>
<span id="cb24-20"><a href="imputation.html#cb24-20" aria-hidden="true" tabindex="-1"></a>                             <span class="st">&quot;Observed&quot;</span> <span class="ot">=</span> <span class="fu">rownames</span>(accmat_ext))</span>
<span id="cb24-21"><a href="imputation.html#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(accmat_ext) <span class="ot">&lt;-</span> <span class="st">&quot;table&quot;</span></span>
<span id="cb24-22"><a href="imputation.html#cb24-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-23"><a href="imputation.html#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="co"># display results</span></span>
<span id="cb24-24"><a href="imputation.html#cb24-24" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(accmat_ext <span class="sc">%&gt;%</span> round, <span class="at">caption =</span> <span class="st">&quot;Confusion matrix of imputed vs. observed five functional group classification over FRI polygons. Rows are imputed values and columns are observed values.&quot;</span>, <span class="at">label =</span> <span class="cn">NA</span>)</span></code></pre></div>
<table>
<caption>
Confusion matrix of imputed vs. observed five functional group classification over FRI polygons. Rows are imputed values and columns are observed values.
</caption>
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:right;">
Black Spruce Dominated
</th>
<th style="text-align:right;">
Hardwood
</th>
<th style="text-align:right;">
Jack Pine Dominated
</th>
<th style="text-align:right;">
Mixed Conifers
</th>
<th style="text-align:right;">
Mixedwood
</th>
<th style="text-align:right;">
Sum
</th>
<th style="text-align:right;">
Users
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Black Spruce Dominated
</td>
<td style="text-align:right;">
14832
</td>
<td style="text-align:right;">
575
</td>
<td style="text-align:right;">
618
</td>
<td style="text-align:right;">
2623
</td>
<td style="text-align:right;">
2664
</td>
<td style="text-align:right;">
21312
</td>
<td style="text-align:right;">
70
</td>
</tr>
<tr>
<td style="text-align:left;">
Hardwood
</td>
<td style="text-align:right;">
480
</td>
<td style="text-align:right;">
6744
</td>
<td style="text-align:right;">
323
</td>
<td style="text-align:right;">
283
</td>
<td style="text-align:right;">
2618
</td>
<td style="text-align:right;">
10448
</td>
<td style="text-align:right;">
65
</td>
</tr>
<tr>
<td style="text-align:left;">
Jack Pine Dominated
</td>
<td style="text-align:right;">
366
</td>
<td style="text-align:right;">
218
</td>
<td style="text-align:right;">
2481
</td>
<td style="text-align:right;">
178
</td>
<td style="text-align:right;">
492
</td>
<td style="text-align:right;">
3735
</td>
<td style="text-align:right;">
66
</td>
</tr>
<tr>
<td style="text-align:left;">
Mixed Conifers
</td>
<td style="text-align:right;">
1325
</td>
<td style="text-align:right;">
186
</td>
<td style="text-align:right;">
112
</td>
<td style="text-align:right;">
1326
</td>
<td style="text-align:right;">
765
</td>
<td style="text-align:right;">
3714
</td>
<td style="text-align:right;">
36
</td>
</tr>
<tr>
<td style="text-align:left;">
Mixedwood
</td>
<td style="text-align:right;">
2064
</td>
<td style="text-align:right;">
2602
</td>
<td style="text-align:right;">
539
</td>
<td style="text-align:right;">
1169
</td>
<td style="text-align:right;">
5854
</td>
<td style="text-align:right;">
12228
</td>
<td style="text-align:right;">
48
</td>
</tr>
<tr>
<td style="text-align:left;">
Sum
</td>
<td style="text-align:right;">
19067
</td>
<td style="text-align:right;">
10325
</td>
<td style="text-align:right;">
4073
</td>
<td style="text-align:right;">
5579
</td>
<td style="text-align:right;">
12393
</td>
<td style="text-align:right;">
51437
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:left;">
Producers
</td>
<td style="text-align:right;">
78
</td>
<td style="text-align:right;">
65
</td>
<td style="text-align:right;">
61
</td>
<td style="text-align:right;">
24
</td>
<td style="text-align:right;">
47
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
61
</td>
</tr>
</tbody>
</table>
<p>Leading species:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="imputation.html#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate leading species confusion matrix</span></span>
<span id="cb25-2"><a href="imputation.html#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co"># create df of sp1</span></span>
<span id="cb25-3"><a href="imputation.html#cb25-3" aria-hidden="true" tabindex="-1"></a>sp1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">obs =</span> nn_tab<span class="sc">$</span>sp1 <span class="sc">%&gt;%</span> as.factor,</span>
<span id="cb25-4"><a href="imputation.html#cb25-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">est =</span> nn_tab<span class="sc">$</span>sp1_nn <span class="sc">%&gt;%</span> as.factor)</span>
<span id="cb25-5"><a href="imputation.html#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="imputation.html#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="co"># make estimate levels match obs levels</span></span>
<span id="cb25-7"><a href="imputation.html#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="fu">levels</span>(sp1<span class="sc">$</span>est) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">levels</span>(sp1<span class="sc">$</span>est), <span class="fu">levels</span>(sp1<span class="sc">$</span>obs)[<span class="sc">!</span>(<span class="fu">levels</span>(sp1<span class="sc">$</span>obs) <span class="sc">%in%</span> <span class="fu">levels</span>(sp1<span class="sc">$</span>est))])</span>
<span id="cb25-8"><a href="imputation.html#cb25-8" aria-hidden="true" tabindex="-1"></a>sp1<span class="sc">$</span>est <span class="ot">&lt;-</span> <span class="fu">factor</span>(sp1<span class="sc">$</span>est, <span class="at">levels =</span> <span class="fu">levels</span>(sp1<span class="sc">$</span>obs))</span>
<span id="cb25-9"><a href="imputation.html#cb25-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-10"><a href="imputation.html#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="co"># create column of match or not</span></span>
<span id="cb25-11"><a href="imputation.html#cb25-11" aria-hidden="true" tabindex="-1"></a>sp1<span class="sc">$</span>match <span class="ot">&lt;-</span> sp1<span class="sc">$</span>obs <span class="sc">==</span> sp1<span class="sc">$</span>est</span>
<span id="cb25-12"><a href="imputation.html#cb25-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-13"><a href="imputation.html#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="co"># build accuracy table</span></span>
<span id="cb25-14"><a href="imputation.html#cb25-14" aria-hidden="true" tabindex="-1"></a>accmat <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="st">&quot;pred&quot;</span> <span class="ot">=</span> sp1<span class="sc">$</span>est, <span class="st">&quot;ref&quot;</span> <span class="ot">=</span> sp1<span class="sc">$</span>obs)</span>
<span id="cb25-15"><a href="imputation.html#cb25-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-16"><a href="imputation.html#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="co"># UA</span></span>
<span id="cb25-17"><a href="imputation.html#cb25-17" aria-hidden="true" tabindex="-1"></a>ua <span class="ot">&lt;-</span> <span class="fu">diag</span>(accmat) <span class="sc">/</span> <span class="fu">rowSums</span>(accmat) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb25-18"><a href="imputation.html#cb25-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-19"><a href="imputation.html#cb25-19" aria-hidden="true" tabindex="-1"></a><span class="co"># PA</span></span>
<span id="cb25-20"><a href="imputation.html#cb25-20" aria-hidden="true" tabindex="-1"></a>pa <span class="ot">&lt;-</span> <span class="fu">diag</span>(accmat) <span class="sc">/</span> <span class="fu">colSums</span>(accmat) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb25-21"><a href="imputation.html#cb25-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-22"><a href="imputation.html#cb25-22" aria-hidden="true" tabindex="-1"></a><span class="co"># OA</span></span>
<span id="cb25-23"><a href="imputation.html#cb25-23" aria-hidden="true" tabindex="-1"></a>oa <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">diag</span>(accmat)) <span class="sc">/</span> <span class="fu">sum</span>(accmat) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb25-24"><a href="imputation.html#cb25-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-25"><a href="imputation.html#cb25-25" aria-hidden="true" tabindex="-1"></a><span class="co"># build confusion matrix</span></span>
<span id="cb25-26"><a href="imputation.html#cb25-26" aria-hidden="true" tabindex="-1"></a>accmat_ext <span class="ot">&lt;-</span> <span class="fu">addmargins</span>(accmat)</span>
<span id="cb25-27"><a href="imputation.html#cb25-27" aria-hidden="true" tabindex="-1"></a>accmat_ext <span class="ot">&lt;-</span> <span class="fu">rbind</span>(accmat_ext, <span class="st">&quot;Users&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(pa, <span class="cn">NA</span>))</span>
<span id="cb25-28"><a href="imputation.html#cb25-28" aria-hidden="true" tabindex="-1"></a>accmat_ext <span class="ot">&lt;-</span> <span class="fu">cbind</span>(accmat_ext, <span class="st">&quot;Producers&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(ua, <span class="cn">NA</span>, oa))</span>
<span id="cb25-29"><a href="imputation.html#cb25-29" aria-hidden="true" tabindex="-1"></a>accmat_ext <span class="ot">&lt;-</span> <span class="fu">round</span>(accmat_ext, <span class="dv">2</span>)</span>
<span id="cb25-30"><a href="imputation.html#cb25-30" aria-hidden="true" tabindex="-1"></a><span class="fu">dimnames</span>(accmat_ext) <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">&quot;Imputed&quot;</span> <span class="ot">=</span> <span class="fu">colnames</span>(accmat_ext),</span>
<span id="cb25-31"><a href="imputation.html#cb25-31" aria-hidden="true" tabindex="-1"></a>                             <span class="st">&quot;Observed&quot;</span> <span class="ot">=</span> <span class="fu">rownames</span>(accmat_ext))</span>
<span id="cb25-32"><a href="imputation.html#cb25-32" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(accmat_ext) <span class="ot">&lt;-</span> <span class="st">&quot;table&quot;</span></span>
<span id="cb25-33"><a href="imputation.html#cb25-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-34"><a href="imputation.html#cb25-34" aria-hidden="true" tabindex="-1"></a><span class="co"># display results</span></span>
<span id="cb25-35"><a href="imputation.html#cb25-35" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(accmat_ext <span class="sc">%&gt;%</span> round, <span class="at">caption =</span> <span class="st">&quot;Confusion matrix of imputed vs. observed leading species over FRI polygons. Rows are imputed values and columns are observed values.&quot;</span>, <span class="at">label =</span> <span class="cn">NA</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb25-36"><a href="imputation.html#cb25-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">latex_options=</span><span class="st">&quot;scale_down&quot;</span>)</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
Confusion matrix of imputed vs. observed leading species over FRI polygons. Rows are imputed values and columns are observed values.
</caption>
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:right;">
AB
</th>
<th style="text-align:right;">
BF
</th>
<th style="text-align:right;">
BW
</th>
<th style="text-align:right;">
CE
</th>
<th style="text-align:right;">
LA
</th>
<th style="text-align:right;">
MR
</th>
<th style="text-align:right;">
PB
</th>
<th style="text-align:right;">
PJ
</th>
<th style="text-align:right;">
PO
</th>
<th style="text-align:right;">
PR
</th>
<th style="text-align:right;">
PT
</th>
<th style="text-align:right;">
PW
</th>
<th style="text-align:right;">
SB
</th>
<th style="text-align:right;">
SW
</th>
<th style="text-align:right;">
SX
</th>
<th style="text-align:right;">
Sum
</th>
<th style="text-align:right;">
Users
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
AB
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
50
</td>
</tr>
<tr>
<td style="text-align:left;">
BF
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
31
</td>
<td style="text-align:right;">
35
</td>
<td style="text-align:right;">
11
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
15
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
67
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
192
</td>
<td style="text-align:right;">
16
</td>
</tr>
<tr>
<td style="text-align:left;">
BW
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
86
</td>
<td style="text-align:right;">
4248
</td>
<td style="text-align:right;">
320
</td>
<td style="text-align:right;">
33
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
15
</td>
<td style="text-align:right;">
228
</td>
<td style="text-align:right;">
401
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1165
</td>
<td style="text-align:right;">
26
</td>
<td style="text-align:right;">
1333
</td>
<td style="text-align:right;">
166
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
8032
</td>
<td style="text-align:right;">
53
</td>
</tr>
<tr>
<td style="text-align:left;">
CE
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
166
</td>
<td style="text-align:right;">
428
</td>
<td style="text-align:right;">
43
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
18
</td>
<td style="text-align:right;">
18
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
45
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
471
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1221
</td>
<td style="text-align:right;">
35
</td>
</tr>
<tr>
<td style="text-align:left;">
LA
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
16
</td>
<td style="text-align:right;">
19
</td>
<td style="text-align:right;">
57
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
11
</td>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
15
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
165
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
299
</td>
<td style="text-align:right;">
19
</td>
</tr>
<tr>
<td style="text-align:left;">
MR
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
NaN
</td>
</tr>
<tr>
<td style="text-align:left;">
PB
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
27
</td>
<td style="text-align:right;">
15
</td>
</tr>
<tr>
<td style="text-align:left;">
PJ
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
185
</td>
<td style="text-align:right;">
18
</td>
<td style="text-align:right;">
43
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
3111
</td>
<td style="text-align:right;">
92
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
449
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
630
</td>
<td style="text-align:right;">
46
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
4591
</td>
<td style="text-align:right;">
68
</td>
</tr>
<tr>
<td style="text-align:left;">
PO
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
248
</td>
<td style="text-align:right;">
17
</td>
<td style="text-align:right;">
16
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
88
</td>
<td style="text-align:right;">
876
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
290
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
155
</td>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1747
</td>
<td style="text-align:right;">
50
</td>
</tr>
<tr>
<td style="text-align:left;">
PR
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
PT
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
28
</td>
<td style="text-align:right;">
1042
</td>
<td style="text-align:right;">
64
</td>
<td style="text-align:right;">
23
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
52
</td>
<td style="text-align:right;">
443
</td>
<td style="text-align:right;">
346
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
3594
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
715
</td>
<td style="text-align:right;">
69
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
6389
</td>
<td style="text-align:right;">
56
</td>
</tr>
<tr>
<td style="text-align:left;">
PW
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
40
</td>
</tr>
<tr>
<td style="text-align:left;">
SB
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
393
</td>
<td style="text-align:right;">
1815
</td>
<td style="text-align:right;">
1316
</td>
<td style="text-align:right;">
759
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
19
</td>
<td style="text-align:right;">
1155
</td>
<td style="text-align:right;">
277
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
1106
</td>
<td style="text-align:right;">
14
</td>
<td style="text-align:right;">
21259
</td>
<td style="text-align:right;">
506
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
28629
</td>
<td style="text-align:right;">
74
</td>
</tr>
<tr>
<td style="text-align:left;">
SW
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
50
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
22
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
33
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
96
</td>
<td style="text-align:right;">
56
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
289
</td>
<td style="text-align:right;">
19
</td>
</tr>
<tr>
<td style="text-align:left;">
SX
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
NaN
</td>
</tr>
<tr>
<td style="text-align:left;">
Sum
</td>
<td style="text-align:right;">
34
</td>
<td style="text-align:right;">
601
</td>
<td style="text-align:right;">
7816
</td>
<td style="text-align:right;">
2196
</td>
<td style="text-align:right;">
984
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
98
</td>
<td style="text-align:right;">
5083
</td>
<td style="text-align:right;">
2047
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
6713
</td>
<td style="text-align:right;">
56
</td>
<td style="text-align:right;">
24900
</td>
<td style="text-align:right;">
894
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
51437
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:left;">
Producers
</td>
<td style="text-align:right;">
18
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
54
</td>
<td style="text-align:right;">
19
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
61
</td>
<td style="text-align:right;">
43
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
54
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
85
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
65
</td>
</tr>
</tbody>
</table>
</div>
<div id="imputation510" class="section level2 unnumbered hasAnchor">
<h2><strong>5.10</strong> Execute Imputation Algorithm From FRI to GRM Polygons<a href="imputation.html#imputation510" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The last step is to run the imputation between the screened FRI polygons and the GRM segmented polygons. For each GRM segmented polygon, the k-nearest neighbors in the FRI data are found and used to impute age and species composition. Note we do not conduct imputation on all the GRM segmented polygons, but only the forested polygons that passed through the data screening filters.</p>
<p>Although we cannot directly assess the error of age and species composition when imputing into the GRM segmented polygons, we can still assess the fit of the variables used in the imputation.</p>
<p>We can also review maps and distributions comparing FRI age/species composition against the same attributes imputed into GRM segmented polygons.</p>
<p>First we execute the imputation algorithm itself. Since there was no iterative performance analysis conducted on the FRI to GRM imputation, we do not define an imputation function, rather just run the algorithm in line.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="imputation.html#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load GRM screened polygons</span></span>
<span id="cb26-2"><a href="imputation.html#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="fu">str_c</span>(out_dir, <span class="st">&#39;/temp/dat_grm_scr.RData&#39;</span>))</span>
<span id="cb26-3"><a href="imputation.html#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="imputation.html#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co"># create data frame for grm and fri metrics used in imputation</span></span>
<span id="cb26-5"><a href="imputation.html#cb26-5" aria-hidden="true" tabindex="-1"></a>dat_grm_imp <span class="ot">&lt;-</span> dat_grm_scr <span class="sc">%&gt;%</span> <span class="fu">select</span>(id, avg,</span>
<span id="cb26-6"><a href="imputation.html#cb26-6" aria-hidden="true" tabindex="-1"></a>                                      rumple, pcum8, sd,</span>
<span id="cb26-7"><a href="imputation.html#cb26-7" aria-hidden="true" tabindex="-1"></a>                                      b6, x, y) <span class="sc">%&gt;%</span> na.omit</span>
<span id="cb26-8"><a href="imputation.html#cb26-8" aria-hidden="true" tabindex="-1"></a>dat_fri_imp <span class="ot">&lt;-</span> dat_fri_scr <span class="sc">%&gt;%</span> <span class="fu">select</span>(avg,</span>
<span id="cb26-9"><a href="imputation.html#cb26-9" aria-hidden="true" tabindex="-1"></a>                                      rumple, pcum8, sd,</span>
<span id="cb26-10"><a href="imputation.html#cb26-10" aria-hidden="true" tabindex="-1"></a>                                      b6, x, y) <span class="sc">%&gt;%</span> na.omit</span>
<span id="cb26-11"><a href="imputation.html#cb26-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-12"><a href="imputation.html#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="co"># need to combine and scale all values together then separate again</span></span>
<span id="cb26-13"><a href="imputation.html#cb26-13" aria-hidden="true" tabindex="-1"></a>dat_comb_scaled <span class="ot">&lt;-</span> <span class="fu">rbind</span>(dat_grm_imp <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>id), </span>
<span id="cb26-14"><a href="imputation.html#cb26-14" aria-hidden="true" tabindex="-1"></a>                         dat_fri_imp) <span class="sc">%&gt;%</span> scale</span>
<span id="cb26-15"><a href="imputation.html#cb26-15" aria-hidden="true" tabindex="-1"></a>dat_grm_scaled <span class="ot">&lt;-</span> dat_comb_scaled[<span class="dv">1</span><span class="sc">:</span><span class="fu">NROW</span>(dat_grm_imp),]</span>
<span id="cb26-16"><a href="imputation.html#cb26-16" aria-hidden="true" tabindex="-1"></a>dat_fri_scaled <span class="ot">&lt;-</span> dat_comb_scaled[(<span class="fu">NROW</span>(dat_grm_imp)<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(<span class="fu">NROW</span>(dat_grm_imp)<span class="sc">+</span><span class="fu">NROW</span>(dat_fri_imp)),]</span>
<span id="cb26-17"><a href="imputation.html#cb26-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-18"><a href="imputation.html#cb26-18" aria-hidden="true" tabindex="-1"></a><span class="co"># run nearest neighbor imputation k = 5</span></span>
<span id="cb26-19"><a href="imputation.html#cb26-19" aria-hidden="true" tabindex="-1"></a>nn <span class="ot">&lt;-</span> <span class="fu">nn2</span>(dat_fri_scaled, dat_grm_scaled, <span class="at">k =</span> <span class="dv">5</span>)</span>
<span id="cb26-20"><a href="imputation.html#cb26-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-21"><a href="imputation.html#cb26-21" aria-hidden="true" tabindex="-1"></a><span class="co"># get nn indices</span></span>
<span id="cb26-22"><a href="imputation.html#cb26-22" aria-hidden="true" tabindex="-1"></a>nni <span class="ot">&lt;-</span> nn[[<span class="dv">1</span>]]</span>
<span id="cb26-23"><a href="imputation.html#cb26-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-24"><a href="imputation.html#cb26-24" aria-hidden="true" tabindex="-1"></a><span class="co"># add imputed attributes into GRM imputation data frame</span></span>
<span id="cb26-25"><a href="imputation.html#cb26-25" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(vars)){</span>
<span id="cb26-26"><a href="imputation.html#cb26-26" aria-hidden="true" tabindex="-1"></a>  dat_grm_imp <span class="sc">%&lt;&gt;%</span> <span class="fu">add_column</span>(</span>
<span id="cb26-27"><a href="imputation.html#cb26-27" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!!</span><span class="fu">str_c</span>(vars[i], <span class="st">&#39;_imp&#39;</span>) <span class="sc">:</span><span class="er">=</span> <span class="fu">apply</span>(</span>
<span id="cb26-28"><a href="imputation.html#cb26-28" aria-hidden="true" tabindex="-1"></a>      nni, </span>
<span id="cb26-29"><a href="imputation.html#cb26-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">MARGIN =</span> <span class="dv">1</span>, </span>
<span id="cb26-30"><a href="imputation.html#cb26-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb26-31"><a href="imputation.html#cb26-31" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mean</span>(dat_fri_imp[x, vars[i]])</span>
<span id="cb26-32"><a href="imputation.html#cb26-32" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb26-33"><a href="imputation.html#cb26-33" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb26-34"><a href="imputation.html#cb26-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-35"><a href="imputation.html#cb26-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-36"><a href="imputation.html#cb26-36" aria-hidden="true" tabindex="-1"></a><span class="co"># create vector of target variables</span></span>
<span id="cb26-37"><a href="imputation.html#cb26-37" aria-hidden="true" tabindex="-1"></a>tar_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;AGE2018&#39;</span>, <span class="st">&#39;SP1&#39;</span>, <span class="st">&#39;SP2&#39;</span>,</span>
<span id="cb26-38"><a href="imputation.html#cb26-38" aria-hidden="true" tabindex="-1"></a>              <span class="st">&#39;class3&#39;</span>, <span class="st">&#39;class5&#39;</span>)</span>
<span id="cb26-39"><a href="imputation.html#cb26-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-40"><a href="imputation.html#cb26-40" aria-hidden="true" tabindex="-1"></a><span class="co"># add age and species variables to GRM data frame</span></span>
<span id="cb26-41"><a href="imputation.html#cb26-41" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(tar_vars)){</span>
<span id="cb26-42"><a href="imputation.html#cb26-42" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(i <span class="sc">==</span> <span class="st">&#39;AGE2018&#39;</span>){</span>
<span id="cb26-43"><a href="imputation.html#cb26-43" aria-hidden="true" tabindex="-1"></a>    dat_grm_imp <span class="sc">%&lt;&gt;%</span> <span class="fu">add_column</span>(</span>
<span id="cb26-44"><a href="imputation.html#cb26-44" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!!</span>tar_vars[i] <span class="sc">:</span><span class="er">=</span> <span class="fu">apply</span>(</span>
<span id="cb26-45"><a href="imputation.html#cb26-45" aria-hidden="true" tabindex="-1"></a>        nni, </span>
<span id="cb26-46"><a href="imputation.html#cb26-46" aria-hidden="true" tabindex="-1"></a>        <span class="at">MARGIN =</span> <span class="dv">1</span>, </span>
<span id="cb26-47"><a href="imputation.html#cb26-47" aria-hidden="true" tabindex="-1"></a>        <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb26-48"><a href="imputation.html#cb26-48" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mean</span>(dat_fri_scr[x, tar_vars[i]])</span>
<span id="cb26-49"><a href="imputation.html#cb26-49" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb26-50"><a href="imputation.html#cb26-50" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb26-51"><a href="imputation.html#cb26-51" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span>{</span>
<span id="cb26-52"><a href="imputation.html#cb26-52" aria-hidden="true" tabindex="-1"></a>    dat_grm_imp <span class="sc">%&lt;&gt;%</span> <span class="fu">add_column</span>(</span>
<span id="cb26-53"><a href="imputation.html#cb26-53" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!!</span>tar_vars[i] <span class="sc">:</span><span class="er">=</span> <span class="fu">apply</span>(</span>
<span id="cb26-54"><a href="imputation.html#cb26-54" aria-hidden="true" tabindex="-1"></a>        nni, </span>
<span id="cb26-55"><a href="imputation.html#cb26-55" aria-hidden="true" tabindex="-1"></a>        <span class="at">MARGIN =</span> <span class="dv">1</span>, </span>
<span id="cb26-56"><a href="imputation.html#cb26-56" aria-hidden="true" tabindex="-1"></a>        <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb26-57"><a href="imputation.html#cb26-57" aria-hidden="true" tabindex="-1"></a>          <span class="fu">getmode</span>(dat_fri_scr[x, tar_vars[i]])</span>
<span id="cb26-58"><a href="imputation.html#cb26-58" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb26-59"><a href="imputation.html#cb26-59" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb26-60"><a href="imputation.html#cb26-60" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-61"><a href="imputation.html#cb26-61" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-62"><a href="imputation.html#cb26-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-63"><a href="imputation.html#cb26-63" aria-hidden="true" tabindex="-1"></a><span class="co"># update colnames</span></span>
<span id="cb26-64"><a href="imputation.html#cb26-64" aria-hidden="true" tabindex="-1"></a>dat_grm_imp <span class="sc">%&lt;&gt;%</span> <span class="fu">rename</span>(<span class="at">age =</span> AGE2018)</span>
<span id="cb26-65"><a href="imputation.html#cb26-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-66"><a href="imputation.html#cb26-66" aria-hidden="true" tabindex="-1"></a><span class="co"># add values back into main GRM data frame</span></span>
<span id="cb26-67"><a href="imputation.html#cb26-67" aria-hidden="true" tabindex="-1"></a>dat_grm <span class="ot">&lt;-</span> <span class="fu">left_join</span>(dat_grm, dat_grm_imp)</span></code></pre></div>
</div>
<div id="imputation511" class="section level2 unnumbered hasAnchor">
<h2><strong>5.11</strong> Results: Imputation X-Variable Performance<a href="imputation.html#imputation511" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Now having run the imputation and added the imputed attributes to the GRM polygon data, we can explore the results. We start by looking at the relative root mean squared difference (RRMSD) and relative mean bias error (RMBE) of the X-variables used in the algorithm.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="imputation.html#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate performance across imputation x-variables</span></span>
<span id="cb27-2"><a href="imputation.html#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(vars)){</span>
<span id="cb27-3"><a href="imputation.html#cb27-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb27-4"><a href="imputation.html#cb27-4" aria-hidden="true" tabindex="-1"></a>      perf <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">variable =</span> vars[i],</span>
<span id="cb27-5"><a href="imputation.html#cb27-5" aria-hidden="true" tabindex="-1"></a>                           <span class="at">metric =</span> <span class="fu">c</span>(<span class="st">&#39;rrmsd (%)&#39;</span>, <span class="st">&#39;rmbe (%)&#39;</span>),</span>
<span id="cb27-6"><a href="imputation.html#cb27-6" aria-hidden="true" tabindex="-1"></a>                           <span class="at">value =</span> <span class="fu">c</span>(<span class="fu">rrmsd</span>(dat_grm_imp[, vars[i]],</span>
<span id="cb27-7"><a href="imputation.html#cb27-7" aria-hidden="true" tabindex="-1"></a>                         dat_grm_imp[, <span class="fu">str_c</span>(vars[i], <span class="st">&#39;_imp&#39;</span>)]),</span>
<span id="cb27-8"><a href="imputation.html#cb27-8" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">rmbe</span>(dat_grm_imp[, vars[i]],</span>
<span id="cb27-9"><a href="imputation.html#cb27-9" aria-hidden="true" tabindex="-1"></a>                         dat_grm_imp[, <span class="fu">str_c</span>(vars[i], <span class="st">&#39;_imp&#39;</span>)])))</span>
<span id="cb27-10"><a href="imputation.html#cb27-10" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb27-11"><a href="imputation.html#cb27-11" aria-hidden="true" tabindex="-1"></a>      perf <span class="sc">%&lt;&gt;%</span> <span class="fu">add_row</span>(<span class="at">variable =</span> vars[i],</span>
<span id="cb27-12"><a href="imputation.html#cb27-12" aria-hidden="true" tabindex="-1"></a>                           <span class="at">metric =</span> <span class="fu">c</span>(<span class="st">&#39;rrmsd (%)&#39;</span>, <span class="st">&#39;rmbe (%)&#39;</span>),</span>
<span id="cb27-13"><a href="imputation.html#cb27-13" aria-hidden="true" tabindex="-1"></a>                           <span class="at">value =</span> <span class="fu">c</span>(<span class="fu">rrmsd</span>(dat_grm_imp[, vars[i]],</span>
<span id="cb27-14"><a href="imputation.html#cb27-14" aria-hidden="true" tabindex="-1"></a>                         dat_grm_imp[, <span class="fu">str_c</span>(vars[i], <span class="st">&#39;_imp&#39;</span>)]),</span>
<span id="cb27-15"><a href="imputation.html#cb27-15" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">rmbe</span>(dat_grm_imp[, vars[i]],</span>
<span id="cb27-16"><a href="imputation.html#cb27-16" aria-hidden="true" tabindex="-1"></a>                          dat_grm_imp[, <span class="fu">str_c</span>(vars[i], <span class="st">&#39;_imp&#39;</span>)])))</span>
<span id="cb27-17"><a href="imputation.html#cb27-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb27-18"><a href="imputation.html#cb27-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-19"><a href="imputation.html#cb27-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-20"><a href="imputation.html#cb27-20" aria-hidden="true" tabindex="-1"></a><span class="co"># round to two decimal places</span></span>
<span id="cb27-21"><a href="imputation.html#cb27-21" aria-hidden="true" tabindex="-1"></a>perf <span class="sc">%&lt;&gt;%</span> <span class="fu">mutate</span>(<span class="at">value =</span> <span class="fu">round</span>(value, <span class="dv">2</span>))</span>
<span id="cb27-22"><a href="imputation.html#cb27-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-23"><a href="imputation.html#cb27-23" aria-hidden="true" tabindex="-1"></a><span class="co"># factor so table displays nicely</span></span>
<span id="cb27-24"><a href="imputation.html#cb27-24" aria-hidden="true" tabindex="-1"></a>perf <span class="sc">%&lt;&gt;%</span> <span class="fu">mutate</span>(<span class="at">variable =</span> <span class="fu">factor</span>(variable, <span class="at">levels =</span> vars)) <span class="sc">%&gt;%</span></span>
<span id="cb27-25"><a href="imputation.html#cb27-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">metric =</span> <span class="fu">factor</span>(metric, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&#39;rrmsd (%)&#39;</span>, <span class="st">&#39;rmbe (%)&#39;</span>)))</span>
<span id="cb27-26"><a href="imputation.html#cb27-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-27"><a href="imputation.html#cb27-27" aria-hidden="true" tabindex="-1"></a><span class="co"># cast df</span></span>
<span id="cb27-28"><a href="imputation.html#cb27-28" aria-hidden="true" tabindex="-1"></a>perf_cast <span class="ot">&lt;-</span> <span class="fu">dcast</span>(perf, variable <span class="sc">~</span> metric)</span>
<span id="cb27-29"><a href="imputation.html#cb27-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-30"><a href="imputation.html#cb27-30" aria-hidden="true" tabindex="-1"></a><span class="co"># remove x and y</span></span>
<span id="cb27-31"><a href="imputation.html#cb27-31" aria-hidden="true" tabindex="-1"></a>perf_cast <span class="sc">%&lt;&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>(variable <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;x&#39;</span>, <span class="st">&#39;y&#39;</span>)))</span>
<span id="cb27-32"><a href="imputation.html#cb27-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-33"><a href="imputation.html#cb27-33" aria-hidden="true" tabindex="-1"></a><span class="co"># display results of imputation rmsd</span></span>
<span id="cb27-34"><a href="imputation.html#cb27-34" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(perf_cast, <span class="at">caption =</span> <span class="st">&quot;Imputation X-Variable Performance between FRI and GRM Forest Stand Polygons&quot;</span>, <span class="at">label =</span> <span class="cn">NA</span>)</span></code></pre></div>
<table>
<caption>
Imputation X-Variable Performance between FRI and GRM Forest Stand Polygons
</caption>
<thead>
<tr>
<th style="text-align:left;">
variable
</th>
<th style="text-align:right;">
rrmsd (%)
</th>
<th style="text-align:right;">
rmbe (%)
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
avg
</td>
<td style="text-align:right;">
3.82
</td>
<td style="text-align:right;">
-0.04
</td>
</tr>
<tr>
<td style="text-align:left;">
rumple
</td>
<td style="text-align:right;">
2.71
</td>
<td style="text-align:right;">
0.09
</td>
</tr>
<tr>
<td style="text-align:left;">
pcum8
</td>
<td style="text-align:right;">
0.88
</td>
<td style="text-align:right;">
0.12
</td>
</tr>
<tr>
<td style="text-align:left;">
sd
</td>
<td style="text-align:right;">
4.16
</td>
<td style="text-align:right;">
-0.40
</td>
</tr>
<tr>
<td style="text-align:left;">
b6
</td>
<td style="text-align:right;">
2.08
</td>
<td style="text-align:right;">
-0.16
</td>
</tr>
</tbody>
</table>
<p>The RRMSD results are all below 5% and RMBE does not show bias toward negative of positive difference. These results are comparable to those found when conducting imputation over FRI polygons only.</p>
</div>
<div id="imputation512" class="section level2 unnumbered hasAnchor">
<h2><strong>5.12</strong> Results: Distribution of Age<a href="imputation.html#imputation512" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The next thing we can do is compare the distribution of imputed values in GRM polygons to observed values in FRI polygons. We can compare spatial patterns as well as overall distributions.</p>
<p>We first generate a spatial comparison of age across the RMF.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="imputation.html#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load GRM polygons</span></span>
<span id="cb28-2"><a href="imputation.html#cb28-2" aria-hidden="true" tabindex="-1"></a>poly_grm <span class="ot">&lt;-</span> <span class="fu">vect</span>(grm)</span>
<span id="cb28-3"><a href="imputation.html#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="imputation.html#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co"># add new data frame to polygons</span></span>
<span id="cb28-5"><a href="imputation.html#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="fu">values</span>(poly_grm) <span class="ot">&lt;-</span> dat_grm</span>
<span id="cb28-6"><a href="imputation.html#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="imputation.html#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="co"># save grm polygon output</span></span>
<span id="cb28-8"><a href="imputation.html#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="fu">writeVector</span>(poly_grm, <span class="fu">str_c</span>(out_dir, <span class="st">&#39;/grm_imp.shp&#39;</span>), <span class="at">overwrite =</span> T)</span>
<span id="cb28-9"><a href="imputation.html#cb28-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-10"><a href="imputation.html#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="co"># load FRI polygons</span></span>
<span id="cb28-11"><a href="imputation.html#cb28-11" aria-hidden="true" tabindex="-1"></a>poly_fri <span class="ot">&lt;-</span> <span class="fu">vect</span>(fri)</span>
<span id="cb28-12"><a href="imputation.html#cb28-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-13"><a href="imputation.html#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="co"># combine dat_fri with polygon attributes</span></span>
<span id="cb28-14"><a href="imputation.html#cb28-14" aria-hidden="true" tabindex="-1"></a>dat_fri_poly <span class="ot">&lt;-</span> <span class="fu">left_join</span>(<span class="fu">as.data.frame</span>(poly_fri), dat_fri)</span>
<span id="cb28-15"><a href="imputation.html#cb28-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-16"><a href="imputation.html#cb28-16" aria-hidden="true" tabindex="-1"></a><span class="co"># we should only compare the screened FRI polygons so set </span></span>
<span id="cb28-17"><a href="imputation.html#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="co"># other values to NA</span></span>
<span id="cb28-18"><a href="imputation.html#cb28-18" aria-hidden="true" tabindex="-1"></a>dat_fri_poly<span class="sc">$</span>AGE2018[<span class="sc">!</span>(dat_fri_poly<span class="sc">$</span>POLYID <span class="sc">%in%</span> dat_fri_scr<span class="sc">$</span>POLYID)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb28-19"><a href="imputation.html#cb28-19" aria-hidden="true" tabindex="-1"></a>dat_fri_poly<span class="sc">$</span>class3[<span class="sc">!</span>(dat_fri_poly<span class="sc">$</span>POLYID <span class="sc">%in%</span> dat_fri_scr<span class="sc">$</span>POLYID)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb28-20"><a href="imputation.html#cb28-20" aria-hidden="true" tabindex="-1"></a>dat_fri_poly<span class="sc">$</span>class5[<span class="sc">!</span>(dat_fri_poly<span class="sc">$</span>POLYID <span class="sc">%in%</span> dat_fri_scr<span class="sc">$</span>POLYID)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb28-21"><a href="imputation.html#cb28-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-22"><a href="imputation.html#cb28-22" aria-hidden="true" tabindex="-1"></a><span class="co"># re-input attributes into FRI polygons</span></span>
<span id="cb28-23"><a href="imputation.html#cb28-23" aria-hidden="true" tabindex="-1"></a><span class="fu">values</span>(poly_fri) <span class="ot">&lt;-</span> dat_fri_poly</span>
<span id="cb28-24"><a href="imputation.html#cb28-24" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(dat_fri_poly)</span>
<span id="cb28-25"><a href="imputation.html#cb28-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-26"><a href="imputation.html#cb28-26" aria-hidden="true" tabindex="-1"></a><span class="co"># save fri polygon output with key values only in screened polygons</span></span>
<span id="cb28-27"><a href="imputation.html#cb28-27" aria-hidden="true" tabindex="-1"></a><span class="fu">writeVector</span>(poly_fri, <span class="fu">str_c</span>(out_dir, <span class="st">&#39;/fri_scr.shp&#39;</span>), <span class="at">overwrite =</span> T)</span>
<span id="cb28-28"><a href="imputation.html#cb28-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-29"><a href="imputation.html#cb28-29" aria-hidden="true" tabindex="-1"></a><span class="co"># create df to plot age</span></span>
<span id="cb28-30"><a href="imputation.html#cb28-30" aria-hidden="true" tabindex="-1"></a>grm_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(poly_grm)</span>
<span id="cb28-31"><a href="imputation.html#cb28-31" aria-hidden="true" tabindex="-1"></a>fri_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(poly_fri)</span>
<span id="cb28-32"><a href="imputation.html#cb28-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-33"><a href="imputation.html#cb28-33" aria-hidden="true" tabindex="-1"></a><span class="co"># cut dfs</span></span>
<span id="cb28-34"><a href="imputation.html#cb28-34" aria-hidden="true" tabindex="-1"></a>grm_sf <span class="sc">%&lt;&gt;%</span> <span class="fu">mutate</span>(<span class="at">age_cut =</span> <span class="fu">cut</span>(age, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">130</span>, <span class="dv">10</span>), <span class="dv">250</span>)))</span>
<span id="cb28-35"><a href="imputation.html#cb28-35" aria-hidden="true" tabindex="-1"></a>fri_sf <span class="sc">%&lt;&gt;%</span> <span class="fu">mutate</span>(<span class="at">age_cut =</span> <span class="fu">cut</span>(AGE2018, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">130</span>, <span class="dv">10</span>), <span class="dv">250</span>)))</span>
<span id="cb28-36"><a href="imputation.html#cb28-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-37"><a href="imputation.html#cb28-37" aria-hidden="true" tabindex="-1"></a><span class="co"># plot age</span></span>
<span id="cb28-38"><a href="imputation.html#cb28-38" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(grm_sf) <span class="sc">+</span></span>
<span id="cb28-39"><a href="imputation.html#cb28-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">fill =</span> age_cut), <span class="at">linewidth =</span> <span class="fl">0.001</span>) <span class="sc">+</span></span>
<span id="cb28-40"><a href="imputation.html#cb28-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>() <span class="sc">+</span></span>
<span id="cb28-41"><a href="imputation.html#cb28-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">viridis</span>(<span class="dv">14</span>), <span class="at">name =</span> <span class="st">&#39;Age&#39;</span>, <span class="at">na.translate =</span> F) <span class="sc">+</span></span>
<span id="cb28-42"><a href="imputation.html#cb28-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>(<span class="at">base_size =</span> <span class="dv">30</span>) <span class="sc">+</span></span>
<span id="cb28-43"><a href="imputation.html#cb28-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&#39;Imputed Age of GRM </span><span class="sc">\n</span><span class="st">Segmented Forest Stands&#39;</span>) <span class="sc">+</span></span>
<span id="cb28-44"><a href="imputation.html#cb28-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb28-45"><a href="imputation.html#cb28-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-46"><a href="imputation.html#cb28-46" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(fri_sf) <span class="sc">+</span></span>
<span id="cb28-47"><a href="imputation.html#cb28-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">fill =</span> age_cut), <span class="at">linewidth =</span> <span class="fl">0.001</span>) <span class="sc">+</span></span>
<span id="cb28-48"><a href="imputation.html#cb28-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>() <span class="sc">+</span></span>
<span id="cb28-49"><a href="imputation.html#cb28-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">viridis</span>(<span class="dv">14</span>), <span class="at">name =</span> <span class="st">&#39;Age&#39;</span>, <span class="at">na.translate =</span> F) <span class="sc">+</span></span>
<span id="cb28-50"><a href="imputation.html#cb28-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>(<span class="at">base_size =</span> <span class="dv">30</span>) <span class="sc">+</span></span>
<span id="cb28-51"><a href="imputation.html#cb28-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&#39;Age of FRI </span><span class="sc">\n</span><span class="st">Forest Stands&#39;</span>) <span class="sc">+</span></span>
<span id="cb28-52"><a href="imputation.html#cb28-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb28-53"><a href="imputation.html#cb28-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-54"><a href="imputation.html#cb28-54" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(p1, p2, <span class="at">ncol =</span> <span class="dv">1</span>)</span></code></pre></div>
<p><img src="05-imputation_files/figure-html/imputationp5121-1.png" width="1152" /></p>
<p>Imputed age values show a similar spatial distribution to observed age values at a broad scale. Of course, the values should be scrutinized on a fine scale in specific areas. This task is much easier to do in a GIS software using the output shapefiles.</p>
<p>We next generate density plots of stand age.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="imputation.html#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># density plots of age</span></span>
<span id="cb29-2"><a href="imputation.html#cb29-2" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(dat_grm, <span class="fu">aes</span>(<span class="at">x =</span> age)) <span class="sc">+</span></span>
<span id="cb29-3"><a href="imputation.html#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">&#39;grey&#39;</span>) <span class="sc">+</span></span>
<span id="cb29-4"><a href="imputation.html#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="fu">median</span>(age, <span class="at">na.rm =</span> T)),</span>
<span id="cb29-5"><a href="imputation.html#cb29-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>,</span>
<span id="cb29-6"><a href="imputation.html#cb29-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb29-7"><a href="imputation.html#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">200</span>)) <span class="sc">+</span></span>
<span id="cb29-8"><a href="imputation.html#cb29-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.02</span>)) <span class="sc">+</span></span>
<span id="cb29-9"><a href="imputation.html#cb29-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb29-10"><a href="imputation.html#cb29-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&#39;Age&#39;</span>) <span class="sc">+</span></span>
<span id="cb29-11"><a href="imputation.html#cb29-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&#39;Density&#39;</span>) <span class="sc">+</span></span>
<span id="cb29-12"><a href="imputation.html#cb29-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&#39;Imputed Age of GRM Segmented Forest Stands&#39;</span>) <span class="sc">+</span></span>
<span id="cb29-13"><a href="imputation.html#cb29-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">25</span>),</span>
<span id="cb29-14"><a href="imputation.html#cb29-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">30</span>))</span>
<span id="cb29-15"><a href="imputation.html#cb29-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-16"><a href="imputation.html#cb29-16" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">as.data.frame</span>(poly_fri), <span class="fu">aes</span>(<span class="at">x =</span> AGE2018)) <span class="sc">+</span></span>
<span id="cb29-17"><a href="imputation.html#cb29-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">&#39;grey&#39;</span>) <span class="sc">+</span></span>
<span id="cb29-18"><a href="imputation.html#cb29-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="fu">median</span>(AGE2018, <span class="at">na.rm =</span> T)),</span>
<span id="cb29-19"><a href="imputation.html#cb29-19" aria-hidden="true" tabindex="-1"></a>             <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>,</span>
<span id="cb29-20"><a href="imputation.html#cb29-20" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb29-21"><a href="imputation.html#cb29-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">200</span>)) <span class="sc">+</span></span>
<span id="cb29-22"><a href="imputation.html#cb29-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.02</span>)) <span class="sc">+</span></span>
<span id="cb29-23"><a href="imputation.html#cb29-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb29-24"><a href="imputation.html#cb29-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&#39;Age&#39;</span>) <span class="sc">+</span></span>
<span id="cb29-25"><a href="imputation.html#cb29-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&#39;Density&#39;</span>) <span class="sc">+</span></span>
<span id="cb29-26"><a href="imputation.html#cb29-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&#39;Age of FRI Forest Stands&#39;</span>) <span class="sc">+</span></span>
<span id="cb29-27"><a href="imputation.html#cb29-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">25</span>),</span>
<span id="cb29-28"><a href="imputation.html#cb29-28" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">30</span>))</span>
<span id="cb29-29"><a href="imputation.html#cb29-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-30"><a href="imputation.html#cb29-30" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(p1, p2, <span class="at">ncol =</span> <span class="dv">1</span>)</span></code></pre></div>
<p><img src="05-imputation_files/figure-html/imputationp5122-1.png" width="1728" /></p>
<p>The distribution of imputed age in GRM polygons closely matches that of observed age in FRI polygons. The median age values (dotted lines) are 78 (GRM) and 83 (FRI).</p>
</div>
<div id="imputation513" class="section level2 unnumbered hasAnchor">
<h2><strong>5.13</strong> Results: Distribution of Species<a href="imputation.html#imputation513" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Finally we explore the distribution of species, starting with spatial patterns of three functional group classification.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="imputation.html#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot three func group classification</span></span>
<span id="cb30-2"><a href="imputation.html#cb30-2" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(grm_sf) <span class="sc">+</span></span>
<span id="cb30-3"><a href="imputation.html#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">fill =</span> class3), <span class="at">linewidth =</span> <span class="fl">0.001</span>) <span class="sc">+</span></span>
<span id="cb30-4"><a href="imputation.html#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>() <span class="sc">+</span></span>
<span id="cb30-5"><a href="imputation.html#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&#39;#228833&#39;</span>, <span class="st">&#39;#aa3377&#39;</span>, <span class="st">&#39;#ccbb44&#39;</span>), </span>
<span id="cb30-6"><a href="imputation.html#cb30-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">name =</span> <span class="st">&#39;Species Class&#39;</span>, <span class="at">na.translate =</span> F) <span class="sc">+</span></span>
<span id="cb30-7"><a href="imputation.html#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>(<span class="at">base_size =</span> <span class="dv">30</span>) <span class="sc">+</span></span>
<span id="cb30-8"><a href="imputation.html#cb30-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&#39;Imputed Three Functional </span><span class="sc">\n</span><span class="st">Group Classification (GRM)&#39;</span>) <span class="sc">+</span></span>
<span id="cb30-9"><a href="imputation.html#cb30-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb30-10"><a href="imputation.html#cb30-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-11"><a href="imputation.html#cb30-11" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(fri_sf) <span class="sc">+</span></span>
<span id="cb30-12"><a href="imputation.html#cb30-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">fill =</span> class3), <span class="at">linewidth =</span> <span class="fl">0.001</span>) <span class="sc">+</span></span>
<span id="cb30-13"><a href="imputation.html#cb30-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>() <span class="sc">+</span></span>
<span id="cb30-14"><a href="imputation.html#cb30-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&#39;#228833&#39;</span>, <span class="st">&#39;#aa3377&#39;</span>, <span class="st">&#39;#ccbb44&#39;</span>), </span>
<span id="cb30-15"><a href="imputation.html#cb30-15" aria-hidden="true" tabindex="-1"></a>                    <span class="at">name =</span> <span class="st">&#39;Species Class&#39;</span>, <span class="at">na.translate =</span> F) <span class="sc">+</span></span>
<span id="cb30-16"><a href="imputation.html#cb30-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>(<span class="at">base_size =</span> <span class="dv">30</span>) <span class="sc">+</span></span>
<span id="cb30-17"><a href="imputation.html#cb30-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&#39;Three Functional </span><span class="sc">\n</span><span class="st">Group Classification (FRI)&#39;</span>) <span class="sc">+</span></span>
<span id="cb30-18"><a href="imputation.html#cb30-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb30-19"><a href="imputation.html#cb30-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-20"><a href="imputation.html#cb30-20" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(p1, p2, <span class="at">ncol =</span> <span class="dv">1</span>)</span></code></pre></div>
<p><img src="05-imputation_files/figure-html/imputationp5131-1.png" width="1152" /></p>
<p>We can observe a similar distribution of species classes.</p>
<p>Five functional group classification:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="imputation.html#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot five func group classification</span></span>
<span id="cb31-2"><a href="imputation.html#cb31-2" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(grm_sf) <span class="sc">+</span></span>
<span id="cb31-3"><a href="imputation.html#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">fill =</span> class5), <span class="at">linewidth =</span> <span class="fl">0.001</span>) <span class="sc">+</span></span>
<span id="cb31-4"><a href="imputation.html#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>() <span class="sc">+</span></span>
<span id="cb31-5"><a href="imputation.html#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&#39;#ccbb44&#39;</span>, <span class="st">&#39;#228833&#39;</span>, <span class="st">&#39;#4477aa&#39;</span>,</span>
<span id="cb31-6"><a href="imputation.html#cb31-6" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&#39;#ee6677&#39;</span>, <span class="st">&#39;#aa3377&#39;</span>), </span>
<span id="cb31-7"><a href="imputation.html#cb31-7" aria-hidden="true" tabindex="-1"></a>                    <span class="at">name =</span> <span class="st">&#39;Species Class&#39;</span>, <span class="at">na.translate =</span> F) <span class="sc">+</span></span>
<span id="cb31-8"><a href="imputation.html#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>(<span class="at">base_size =</span> <span class="dv">30</span>) <span class="sc">+</span></span>
<span id="cb31-9"><a href="imputation.html#cb31-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&#39;Imputed Five Functional </span><span class="sc">\n</span><span class="st">Group Classification (GRM)&#39;</span>) <span class="sc">+</span></span>
<span id="cb31-10"><a href="imputation.html#cb31-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb31-11"><a href="imputation.html#cb31-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-12"><a href="imputation.html#cb31-12" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(fri_sf) <span class="sc">+</span></span>
<span id="cb31-13"><a href="imputation.html#cb31-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">fill =</span> class5), <span class="at">linewidth =</span> <span class="fl">0.001</span>) <span class="sc">+</span></span>
<span id="cb31-14"><a href="imputation.html#cb31-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>() <span class="sc">+</span></span>
<span id="cb31-15"><a href="imputation.html#cb31-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&#39;#ccbb44&#39;</span>, <span class="st">&#39;#228833&#39;</span>, <span class="st">&#39;#4477aa&#39;</span>,</span>
<span id="cb31-16"><a href="imputation.html#cb31-16" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&#39;#ee6677&#39;</span>, <span class="st">&#39;#aa3377&#39;</span>), </span>
<span id="cb31-17"><a href="imputation.html#cb31-17" aria-hidden="true" tabindex="-1"></a>                    <span class="at">name =</span> <span class="st">&#39;Species Class&#39;</span>, <span class="at">na.translate =</span> F) <span class="sc">+</span></span>
<span id="cb31-18"><a href="imputation.html#cb31-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>(<span class="at">base_size =</span> <span class="dv">30</span>) <span class="sc">+</span></span>
<span id="cb31-19"><a href="imputation.html#cb31-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&#39;Five Functional </span><span class="sc">\n</span><span class="st">Group Classification (FRI)&#39;</span>) <span class="sc">+</span></span>
<span id="cb31-20"><a href="imputation.html#cb31-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb31-21"><a href="imputation.html#cb31-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-22"><a href="imputation.html#cb31-22" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(p1, p2, <span class="at">ncol =</span> <span class="dv">1</span>)</span></code></pre></div>
<p><img src="05-imputation_files/figure-html/imputationp5132-1.png" width="1152" /></p>
<p>Overall distribution of three functional group classification:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="imputation.html#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create data frame for GRM 3 classes</span></span>
<span id="cb32-2"><a href="imputation.html#cb32-2" aria-hidden="true" tabindex="-1"></a>dat_grm_c3 <span class="ot">&lt;-</span> dat_grm <span class="sc">%&gt;%</span> </span>
<span id="cb32-3"><a href="imputation.html#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tabyl</span>(class3) <span class="sc">%&gt;%</span>  </span>
<span id="cb32-4"><a href="imputation.html#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(class3) <span class="sc">==</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb32-5"><a href="imputation.html#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(class3)) <span class="sc">%&gt;%</span></span>
<span id="cb32-6"><a href="imputation.html#cb32-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prop =</span> n <span class="sc">/</span> <span class="fu">sum</span>(.<span class="sc">$</span>n)<span class="sc">*</span><span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-7"><a href="imputation.html#cb32-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ypos =</span> <span class="fu">cumsum</span>(prop) <span class="sc">-</span> <span class="fl">0.5</span><span class="sc">*</span>prop) <span class="sc">%&gt;%</span></span>
<span id="cb32-8"><a href="imputation.html#cb32-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lbl =</span> <span class="fu">round</span>(prop))</span>
<span id="cb32-9"><a href="imputation.html#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="imputation.html#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="co"># create data frame for FRI 3 classes</span></span>
<span id="cb32-11"><a href="imputation.html#cb32-11" aria-hidden="true" tabindex="-1"></a>dat_fri_c3 <span class="ot">&lt;-</span> poly_fri <span class="sc">%&gt;%</span> as.data.frame <span class="sc">%&gt;%</span></span>
<span id="cb32-12"><a href="imputation.html#cb32-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tabyl</span>(class3) <span class="sc">%&gt;%</span>  </span>
<span id="cb32-13"><a href="imputation.html#cb32-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(class3) <span class="sc">==</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb32-14"><a href="imputation.html#cb32-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(class3)) <span class="sc">%&gt;%</span></span>
<span id="cb32-15"><a href="imputation.html#cb32-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prop =</span> n <span class="sc">/</span> <span class="fu">sum</span>(.<span class="sc">$</span>n)<span class="sc">*</span><span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-16"><a href="imputation.html#cb32-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ypos =</span> <span class="fu">cumsum</span>(prop) <span class="sc">-</span> <span class="fl">0.5</span><span class="sc">*</span>prop) <span class="sc">%&gt;%</span></span>
<span id="cb32-17"><a href="imputation.html#cb32-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lbl =</span> <span class="fu">round</span>(prop))</span>
<span id="cb32-18"><a href="imputation.html#cb32-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-19"><a href="imputation.html#cb32-19" aria-hidden="true" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb32-20"><a href="imputation.html#cb32-20" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(dat_grm_c3, <span class="fu">aes</span>(<span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> prop, <span class="at">fill =</span> class3)) <span class="sc">+</span></span>
<span id="cb32-21"><a href="imputation.html#cb32-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">width =</span> <span class="dv">1</span>, <span class="at">stat =</span> <span class="st">&quot;identity&quot;</span>) <span class="sc">+</span></span>
<span id="cb32-22"><a href="imputation.html#cb32-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_polar</span>(<span class="st">&quot;y&quot;</span>, <span class="at">start =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb32-23"><a href="imputation.html#cb32-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb32-24"><a href="imputation.html#cb32-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">y =</span> ypos, <span class="at">label =</span> <span class="fu">str_c</span>(lbl, <span class="st">&quot;%&quot;</span>)), <span class="at">size =</span> <span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb32-25"><a href="imputation.html#cb32-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">30</span>),</span>
<span id="cb32-26"><a href="imputation.html#cb32-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>),</span>
<span id="cb32-27"><a href="imputation.html#cb32-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.key.width =</span> <span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">&#39;cm&#39;</span>),</span>
<span id="cb32-28"><a href="imputation.html#cb32-28" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">30</span>)) <span class="sc">+</span></span>
<span id="cb32-29"><a href="imputation.html#cb32-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&#39;#228833&#39;</span>, <span class="st">&#39;#aa3377&#39;</span>, <span class="st">&#39;#ccbb44&#39;</span>)) <span class="sc">+</span></span>
<span id="cb32-30"><a href="imputation.html#cb32-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb32-31"><a href="imputation.html#cb32-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Imputed Three Functional </span><span class="sc">\n</span><span class="st">Group Classification (GRM)&quot;</span>)</span>
<span id="cb32-32"><a href="imputation.html#cb32-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-33"><a href="imputation.html#cb32-33" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(dat_fri_c3, <span class="fu">aes</span>(<span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> prop, <span class="at">fill =</span> class3)) <span class="sc">+</span></span>
<span id="cb32-34"><a href="imputation.html#cb32-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">width =</span> <span class="dv">1</span>, <span class="at">stat =</span> <span class="st">&quot;identity&quot;</span>) <span class="sc">+</span></span>
<span id="cb32-35"><a href="imputation.html#cb32-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_polar</span>(<span class="st">&quot;y&quot;</span>, <span class="at">start =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb32-36"><a href="imputation.html#cb32-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb32-37"><a href="imputation.html#cb32-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">y =</span> ypos, <span class="at">label =</span> <span class="fu">str_c</span>(lbl, <span class="st">&quot;%&quot;</span>)), <span class="at">size =</span> <span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb32-38"><a href="imputation.html#cb32-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">30</span>),</span>
<span id="cb32-39"><a href="imputation.html#cb32-39" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>),</span>
<span id="cb32-40"><a href="imputation.html#cb32-40" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.key.width =</span> <span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">&#39;cm&#39;</span>),</span>
<span id="cb32-41"><a href="imputation.html#cb32-41" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">30</span>)) <span class="sc">+</span></span>
<span id="cb32-42"><a href="imputation.html#cb32-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&#39;#228833&#39;</span>, <span class="st">&#39;#aa3377&#39;</span>, <span class="st">&#39;#ccbb44&#39;</span>)) <span class="sc">+</span></span>
<span id="cb32-43"><a href="imputation.html#cb32-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb32-44"><a href="imputation.html#cb32-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Three Functional Group </span><span class="sc">\n</span><span class="st">Classification (FRI)&quot;</span>)</span>
<span id="cb32-45"><a href="imputation.html#cb32-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-46"><a href="imputation.html#cb32-46" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(p1, p2, <span class="at">ncol =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="05-imputation_files/figure-html/imputationp5133-1.png" width="1728" /></p>
<p>The distribution of three functional groups is very similar with slightly more softwood in the imputed data.</p>
<p>Five functional group classification:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="imputation.html#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># distribution of 5 species classes</span></span>
<span id="cb33-2"><a href="imputation.html#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="co"># create data frame for GRM 5 classes</span></span>
<span id="cb33-3"><a href="imputation.html#cb33-3" aria-hidden="true" tabindex="-1"></a>dat_grm_c5 <span class="ot">&lt;-</span> dat_grm <span class="sc">%&gt;%</span> </span>
<span id="cb33-4"><a href="imputation.html#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tabyl</span>(class5) <span class="sc">%&gt;%</span>  </span>
<span id="cb33-5"><a href="imputation.html#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(class5) <span class="sc">==</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb33-6"><a href="imputation.html#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(class5)) <span class="sc">%&gt;%</span></span>
<span id="cb33-7"><a href="imputation.html#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prop =</span> n <span class="sc">/</span> <span class="fu">sum</span>(.<span class="sc">$</span>n)<span class="sc">*</span><span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb33-8"><a href="imputation.html#cb33-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ypos =</span> <span class="fu">cumsum</span>(prop) <span class="sc">-</span> <span class="fl">0.5</span><span class="sc">*</span>prop) <span class="sc">%&gt;%</span></span>
<span id="cb33-9"><a href="imputation.html#cb33-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lbl =</span> <span class="fu">round</span>(prop))</span>
<span id="cb33-10"><a href="imputation.html#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="imputation.html#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="co"># create data frame for FRI 5 classes</span></span>
<span id="cb33-12"><a href="imputation.html#cb33-12" aria-hidden="true" tabindex="-1"></a>dat_fri_c5 <span class="ot">&lt;-</span> poly_fri <span class="sc">%&gt;%</span> as.data.frame <span class="sc">%&gt;%</span></span>
<span id="cb33-13"><a href="imputation.html#cb33-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tabyl</span>(class5) <span class="sc">%&gt;%</span>  </span>
<span id="cb33-14"><a href="imputation.html#cb33-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(class5) <span class="sc">==</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb33-15"><a href="imputation.html#cb33-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(class5)) <span class="sc">%&gt;%</span></span>
<span id="cb33-16"><a href="imputation.html#cb33-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prop =</span> n <span class="sc">/</span> <span class="fu">sum</span>(.<span class="sc">$</span>n)<span class="sc">*</span><span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb33-17"><a href="imputation.html#cb33-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ypos =</span> <span class="fu">cumsum</span>(prop) <span class="sc">-</span> <span class="fl">0.5</span><span class="sc">*</span>prop) <span class="sc">%&gt;%</span></span>
<span id="cb33-18"><a href="imputation.html#cb33-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lbl =</span> <span class="fu">round</span>(prop))</span>
<span id="cb33-19"><a href="imputation.html#cb33-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-20"><a href="imputation.html#cb33-20" aria-hidden="true" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb33-21"><a href="imputation.html#cb33-21" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(dat_grm_c5, <span class="fu">aes</span>(<span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> prop, <span class="at">fill =</span> class5)) <span class="sc">+</span></span>
<span id="cb33-22"><a href="imputation.html#cb33-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">width =</span> <span class="dv">1</span>, <span class="at">stat =</span> <span class="st">&quot;identity&quot;</span>) <span class="sc">+</span></span>
<span id="cb33-23"><a href="imputation.html#cb33-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_polar</span>(<span class="st">&quot;y&quot;</span>, <span class="at">start =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb33-24"><a href="imputation.html#cb33-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb33-25"><a href="imputation.html#cb33-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">y =</span> ypos, <span class="at">label =</span> <span class="fu">str_c</span>(lbl, <span class="st">&quot;%&quot;</span>)), <span class="at">size =</span> <span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb33-26"><a href="imputation.html#cb33-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">30</span>),</span>
<span id="cb33-27"><a href="imputation.html#cb33-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>),</span>
<span id="cb33-28"><a href="imputation.html#cb33-28" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.key.width =</span> <span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">&#39;cm&#39;</span>),</span>
<span id="cb33-29"><a href="imputation.html#cb33-29" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">30</span>)) <span class="sc">+</span></span>
<span id="cb33-30"><a href="imputation.html#cb33-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&#39;#ccbb44&#39;</span>, <span class="st">&#39;#228833&#39;</span>, <span class="st">&#39;#4477aa&#39;</span>,</span>
<span id="cb33-31"><a href="imputation.html#cb33-31" aria-hidden="true" tabindex="-1"></a>                                        <span class="st">&#39;#ee6677&#39;</span>, <span class="st">&#39;#aa3377&#39;</span>)) <span class="sc">+</span></span>
<span id="cb33-32"><a href="imputation.html#cb33-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb33-33"><a href="imputation.html#cb33-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Imputed Five Functional </span><span class="sc">\n</span><span class="st">Group Classification (GRM)&quot;</span>)</span>
<span id="cb33-34"><a href="imputation.html#cb33-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-35"><a href="imputation.html#cb33-35" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(dat_fri_c5, <span class="fu">aes</span>(<span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> prop, <span class="at">fill =</span> class5)) <span class="sc">+</span></span>
<span id="cb33-36"><a href="imputation.html#cb33-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">width =</span> <span class="dv">1</span>, <span class="at">stat =</span> <span class="st">&quot;identity&quot;</span>) <span class="sc">+</span></span>
<span id="cb33-37"><a href="imputation.html#cb33-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_polar</span>(<span class="st">&quot;y&quot;</span>, <span class="at">start =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb33-38"><a href="imputation.html#cb33-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb33-39"><a href="imputation.html#cb33-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">y =</span> ypos, <span class="at">label =</span> <span class="fu">str_c</span>(lbl, <span class="st">&quot;%&quot;</span>)), <span class="at">size =</span> <span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb33-40"><a href="imputation.html#cb33-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">30</span>),</span>
<span id="cb33-41"><a href="imputation.html#cb33-41" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>),</span>
<span id="cb33-42"><a href="imputation.html#cb33-42" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.key.width =</span> <span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">&#39;cm&#39;</span>),</span>
<span id="cb33-43"><a href="imputation.html#cb33-43" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">30</span>)) <span class="sc">+</span></span>
<span id="cb33-44"><a href="imputation.html#cb33-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&#39;#ccbb44&#39;</span>, <span class="st">&#39;#228833&#39;</span>, <span class="st">&#39;#4477aa&#39;</span>,</span>
<span id="cb33-45"><a href="imputation.html#cb33-45" aria-hidden="true" tabindex="-1"></a>                                        <span class="st">&#39;#ee6677&#39;</span>, <span class="st">&#39;#aa3377&#39;</span>)) <span class="sc">+</span></span>
<span id="cb33-46"><a href="imputation.html#cb33-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb33-47"><a href="imputation.html#cb33-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Five Functional Group </span><span class="sc">\n</span><span class="st">Classification (FRI)&quot;</span>)</span>
<span id="cb33-48"><a href="imputation.html#cb33-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-49"><a href="imputation.html#cb33-49" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(p1, p2, <span class="at">ncol =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="05-imputation_files/figure-html/imputationp5134-1.png" width="1728" /></p>
<p>The distribution of imputed five classes of species is also very similar to the FRI distribution. The imputed values contain slightly more black spruce dominated stands (2% more than the FRI), hardwood stands (1% more than the FRI), and less jack pine dominated and mixed conifer stands.</p>
</div>
<div id="imputation516" class="section level2 unnumbered hasAnchor">
<h2><strong>5.16</strong> Caveats<a href="imputation.html#imputation516" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We only used ALS variables derived directly from the point cloud, as in our performance analysis these variables performed slightly better than EFI attributes modelled using an area-based approach. That being said, the performance difference was minimal, as many variables are highly correlated and thus interchangable. In the FSF (Part 6 below), EFI attributes are used for imputation as they performed better. Details of the performance analysis are in Part 7 below. In terms of number of X-variables used in imputation in RMF, our performance analysis showed a small difference between n = 5 and n = 7. We stuck with n = 7 that performed slightly better. N = 3 performed much poorer. We used k = 5 as it performed better than k = 3 and k = 1 yet still resulted in an adequate distribution of variables (higher values of k lead to less variability in the imputed attributes).</p>
<p>Although we compared imputed and observed values across the FRI data, we were limited in our ability to quantify error in relation to ground truth. Little work has investigated the accuracy of FRI species and age attributes. Accuracy depends on the complexity of the forest ecosystem and interpretation procedures (Tompalski et al., 2021). Thus implications will vary across areas, and also based on harvesting and management priorities.</p>
<p>Across the RMF we found similar distributions of age and species between imputed and observed values, even with the GRM data containing ~70% more polygons. Overall distributions are important for forest planning and can even out across the landscape even if individual forest stands do not match imputed and observed values (Thompson et al., 2007).</p>
</div>
<div id="imputation517" class="section level2 unnumbered hasAnchor">
<h2><strong>5.17</strong> Future Work<a href="imputation.html#imputation517" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Future work should explore the performance of imputation across diverse landscapes and scales. In addition, ground plots could be used to assess the relationship between ground truth, FRI polygon attributes, and newly segmented GRM polygon attributes.</p>
</div>
<div id="imputation518" class="section level2 unnumbered hasAnchor">
<h2><strong>5.18</strong> Summary<a href="imputation.html#imputation518" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This tutorial has demonstrated a novel approach to update forest stand polygons and populate them with important forest attributes derived from both expert interpretation of aerial photography and ALS point clouds. The imputation approach is open-source, reproducible, and scalable to meet the needs of operational and strategic planning at various levels.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="segmentation.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="fsf.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
